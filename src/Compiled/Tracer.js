var Color_1=require("./Color/Color"),Ray_1=require("./Ray"),RGBColor_1=require("./Color/RGBColor"),Vector_1=require("./Vector"),Tracer=function(){function e(){this.raysPerPixel=1,this.screenWidth=250,this.screenHeight=250}return e.prototype.getColor=function(e,o){void 0===o&&(o=!0);var t=this.trace(e),r=new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)),n=new Color_1.Color(new RGBColor_1.RGBColor(0,0,0));return null===t.owner?new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)):(r=this.getDiffuseColor(e,t,o),o&&(n=this.getReflectionColor(e,t)),r.add(n))},e.prototype.getDiffuseColor=function(e,o,t){void 0===t&&(t=!0);for(var r,n,i,a,l,c,s,g,C=new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)),d=0,V=this.scene.getLights();d<V.length;d++){var w=V[d];if("light"===o.ownerType)return o.owner.getMaterial().getColor();var _=this.getLightPower(o,w);if(r=new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)),n=new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)),i=new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)),a=Vector_1.Vector.normalized(Vector_1.Vector.substract(o.point,w.getPosition())),c=Math.max(0,-Vector_1.Vector.dot(a,o.owner.getNormal(o.point))),r=r.add(o.owner.getMaterial().getColor().multiple(w.getMaterial().getColor().scaled(_*c*o.owner.getMaterial().getLambertCoeff()))),t)for(var h=35,p=function(e){for(;;){var o=new Vector_1.Vector(Math.random()-.5,Math.random()-.5,Math.random()-.5);if(!(Vector_1.Vector.dot(o,o)>Math.pow(.5,2)))return o=Vector_1.Vector.normalized(o),Vector_1.Vector.dot(o,e)<0&&(o=Vector_1.Vector.inverse(o)),o}},u=0;h>u;++u){var R=p(o.owner.getNormal(o.point)),f=this.getColor(new Ray_1.Ray(o.point,R),!1),v=Vector_1.Vector.dot(R,o.owner.getNormal(o.point));n=n.add(o.owner.getMaterial().getColor().divide(Math.PI).multiple(f.scaled(v)))}l=Vector_1.Vector.reflect(a,o.owner.getNormal(o.point)),s=-Vector_1.Vector.dot(l,e.getDirection()),s>0&&(g=Math.pow(s,35),i=i.add(o.owner.getMaterial().getColor().multiple(w.getMaterial().getColor().scaled(_*g*o.owner.getMaterial().getPhongCoeff())))),C=C.add(r.add(n.divide(15))).add(i)}return C},e.prototype.getReflectionColor=function(e,o){var t,r;return e.setIteration(e.getIteration()-1),0===e.getIteration()||0===o.owner.getMaterial().getReflectionValue()?new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)):(r=Vector_1.Vector.reflect(e.getDirection(),o.owner.getNormal(o.point)),t=this.getColor(new Ray_1.Ray(o.point,r,e.getIteration())).scaled(o.owner.getMaterial().getReflectionValue()))},e.prototype.getPerspectiveVector=function(e,o,t,r){var n=this.scene.getCamera();return Vector_1.Vector.normalized(Vector_1.Vector.add(n.getForwardVector(),Vector_1.Vector.add(Vector_1.Vector.scaled(n.getRightVector(),n.recenterX(e)),Vector_1.Vector.scaled(n.getUpVector(),n.recenterY(o)))))},e.prototype.getLightPower=function(e,o){for(var t,r=10,n=o.getPower(),i=0,a=0;r>a;a++){t=o.getRandomPoint();var l=this.trace(new Ray_1.Ray(e.point,Vector_1.Vector.substract(Vector_1.Vector.substract(o.getPosition(),t),e.point)));null!==l.point&&l.owner===o&&(i+=(n-Vector_1.Vector.substract(Vector_1.Vector.substract(o.getPosition(),t),e.point).getLength()*(n/o.getFadeRadius()))/r)}return i},e.prototype.trace=function(e){for(var o,t={distance:0,point:null,owner:null,ownerType:null},r=this.scene.getObjects().concat(this.scene.getLights()),n=0,i=r;n<i.length;n++){var a=i[n];o=a.getIntersectData(e),o&&o.distance>0&&(null===t.owner||o.distance<t.distance)&&(t.distance=o.distance,t.point=o.point,t.owner=a,t.ownerType=a.getType())}return t},e.prototype.render=function(e,o,t){var r,n,i,a,l=.5;this.screenWidth=o,this.screenHeight=t;for(var c=0;t>c;c++)for(var s=0;o>s;s++){r=new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)),console.log(c,s);for(var g=0;g<this.raysPerPixel;g++)n=0,console.log(g),this.raysPerPixel>1&&(g%2?n+=Math.random()*l:n-=Math.random()*l),i=new Ray_1.Ray(this.scene.getCamera().getPosition(),this.getPerspectiveVector(s+n,c+n,o,t)),r=r.add(this.getColor(i));r=r.divide(this.raysPerPixel);for(var C in r)r[C]=Color_1.Color.sRGBEncode(r[C]);a=Color_1.Color.toRGB(r),e.fillStyle="rgb("+a.red+", "+a.green+", "+a.blue+")",e.fillRect(s,c,s+1,c+1)}},e.prototype.setScene=function(e){this.scene=e},e}();exports.Tracer=Tracer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlRyYWNlci50cyJdLCJuYW1lcyI6WyJDb2xvcl8xIiwicmVxdWlyZSIsIlJheV8xIiwiUkdCQ29sb3JfMSIsIlZlY3Rvcl8xIiwiVHJhY2VyIiwiVHJhY2VyLmNvbnN0cnVjdG9yIiwiVHJhY2VyLmdldENvbG9yIiwiVHJhY2VyLmdldERpZmZ1c2VDb2xvciIsIlRyYWNlci5nZXRSZWZsZWN0aW9uQ29sb3IiLCJUcmFjZXIuZ2V0UGVyc3BlY3RpdmVWZWN0b3IiLCJUcmFjZXIuZ2V0TGlnaHRQb3dlciIsIlRyYWNlci50cmFjZSIsIlRyYWNlci5yZW5kZXIiLCJUcmFjZXIuc2V0U2NlbmUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFDQSxHQUFBQSxTQUFBQyxRQUFzQixpQkFDdEJDLE1BQUFELFFBQW9CLFNBQ3BCRSxXQUFBRixRQUF5QixvQkFJekJHLFNBQUFILFFBQXVCLFlBSXZCSSxPQUFBLFdBQUFBLFFBQUFBLEtBRVlDLEtBQUFBLGFBQXVCQSxFQUN2QkEsS0FBQUEsWUFBc0JBLElBQ3RCQSxLQUFBQSxhQUF1QkEsSUFxVm5DRCxNQW5WWUEsR0FBQUEsVUFBQUEsU0FBUkEsU0FBa0JBLEVBQVVBLEdBQUFFLFNBQUFBLElBQUFBLEdBQUFBLEVBQ3hCQSxJQUFJQSxHQUFZQSxLQUFLQSxNQUFNQSxHQUN2QkEsRUFBc0JBLEdBQUlBLFNBQUFBLE1BQU1BLEdBQUlBLFlBQUFBLFNBQVNBLEVBQUdBLEVBQUdBLElBQ25EQSxFQUFzQkEsR0FBSUEsU0FBQUEsTUFBTUEsR0FBSUEsWUFBQUEsU0FBU0EsRUFBR0EsRUFBR0EsR0FFdkRBLE9BQTJCQSxRQUF2QkEsRUFBaUJBLE1BQ1ZBLEdBQUlBLFNBQUFBLE1BQU1BLEdBQUlBLFlBQUFBLFNBQVNBLEVBQUdBLEVBQUdBLEtBR3hDQSxFQUFlQSxLQUFLQSxnQkFBZ0JBLEVBQUtBLEVBQVdBLEdBRWhEQSxJQUNBQSxFQUFlQSxLQUFLQSxtQkFBbUJBLEVBQUtBLElBR3pDQSxFQUFhQSxJQUFJQSxLQUdwQkYs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R0EsSUFDckNBLFFBQVFBLElBQUlBLEVBQUdBLEVBRWZBLEtBQUtBLEdBQUlBLEdBQU9BLEVBQUdBLEVBQU9BLEtBQUtBLGFBQWNBLElBQ3pDQSxFQUFPQSxFQUVQQSxRQUFRQSxJQUFJQSxHQUVSQSxLQUFLQSxhQUFlQSxJQUNoQkEsRUFBT0EsRUFDUEEsR0FBUUEsS0FBS0EsU0FBV0EsRUFFeEJBLEdBQVFBLEtBQUtBLFNBQVdBLEdBSWhDQSxFQUFNQSxHQUFJQSxPQUFBQSxJQUNOQSxLQUFLQSxNQUFNQSxZQUFZQSxjQUN2QkEsS0FBS0EscUJBQXFCQSxFQUFJQSxFQUFNQSxFQUFJQSxFQUFNQSxFQUFhQSxJQUcvREEsRUFBUUEsRUFBTUEsSUFBSUEsS0FBS0EsU0FBU0EsR0FHcENBLEdBQVFBLEVBQU1BLE9BQU9BLEtBQUtBLGFBRTFCQSxLQUFLQSxHQUFJQSxLQUFhQSxHQUNsQkEsRUFBTUEsR0FBYUEsUUFBQUEsTUFBTUEsV0FBV0EsRUFBTUEsR0FHOUNBLEdBQVdBLFFBQUFBLE1BQU1BLE1BQU1BLEdBRXZCQSxFQUFJQSxVQUFZQSxPQUFPQSxFQUFTQSxJQUFHQSxLQUFLQSxFQUFTQSxNQUFLQSxLQUFLQSxFQUFTQSxLQUFJQSxJQUN4RUEsRUFBSUEsU0FBU0EsRUFBR0EsRUFBR0EsRUFBSUEsRUFBR0EsRUFBSUEsS0FNbkNSLEVBQUFBLFVBQUFBLFNBQVBBLFNBQWlCQSxHQUNiUyxLQUFLQSxNQUFRQSxHQUVyQlQsSUF6VmFVLFNBQUFWLE9BQU1BIiwiZmlsZSI6IlRyYWNlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENhbWVyYSB9IGZyb20gXCIuL0NhbWVyYVwiO1xuaW1wb3J0IHsgQ29sb3IgfSBmcm9tIFwiLi9Db2xvci9Db2xvclwiO1xuaW1wb3J0IHsgUmF5IH0gZnJvbSBcIi4vUmF5XCI7XG5pbXBvcnQgeyBSR0JDb2xvciB9IGZyb20gXCIuL0NvbG9yL1JHQkNvbG9yXCI7XG5pbXBvcnQgeyBSVE1hdGggfSBmcm9tIFwiLi9SVE1hdGhcIjtcbmltcG9ydCB7IFNjZW5lIH0gZnJvbSBcIi4vU2NlbmVcIjtcbmltcG9ydCB7IFNwaGVyZSB9IGZyb20gXCIuL09iamVjdHMvU3BoZXJlXCI7XG5pbXBvcnQgeyBWZWN0b3IgfSBmcm9tIFwiLi9WZWN0b3JcIjtcbmltcG9ydCB7UGxhbmV9IGZyb20gXCIuL09iamVjdHMvUGxhbmVcIjtcbmltcG9ydCB7QWJzdHJhY3RMaWdodH0gZnJvbSBcIi4vTGlnaHRzL0Fic3RyYWN0TGlnaHRcIjtcblxuZXhwb3J0IGNsYXNzIFRyYWNlciB7XG4gICAgcHJpdmF0ZSBzY2VuZTogU2NlbmU7XG4gICAgcHJpdmF0ZSByYXlzUGVyUGl4ZWw6IG51bWJlciA9IDE7XG4gICAgcHJpdmF0ZSBzY3JlZW5XaWR0aDogbnVtYmVyID0gMjUwO1xuICAgIHByaXZhdGUgc2NyZWVuSGVpZ2h0OiBudW1iZXIgPSAyNTA7XG5cbiAgICBwcml2YXRlIGdldENvbG9yIChyYXk6IFJheSwgcmVjdXJjaXZlOiBib29sZWFuID0gdHJ1ZSk6IENvbG9yIHtcbiAgICAgICAgbGV0IGludGVyc2VjdCA9IHRoaXMudHJhY2UocmF5KSxcbiAgICAgICAgICAgIGRpZmZ1c2VDb2xvcjogQ29sb3IgPSBuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDAsIDAsIDApKSxcbiAgICAgICAgICAgIHJlZmxlY3RDb2xvcjogQ29sb3IgPSBuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDAsIDAsIDApKTtcblxuICAgICAgICBpZiAoaW50ZXJzZWN0Wydvd25lciddID09PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IENvbG9yKG5ldyBSR0JDb2xvcigwLCAwLCAwKSk7XG4gICAgICAgIH1cblxuICAgICAgICBkaWZmdXNlQ29sb3IgPSB0aGlzLmdldERpZmZ1c2VDb2xvcihyYXksIGludGVyc2VjdCwgcmVjdXJjaXZlKTtcblxuICAgICAgICBpZiAocmVjdXJjaXZlKSB7XG4gICAgICAgICAgICByZWZsZWN0Q29sb3IgPSB0aGlzLmdldFJlZmxlY3Rpb25Db2xvcihyYXksIGludGVyc2VjdCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZGlmZnVzZUNvbG9yLmFkZChyZWZsZWN0Q29sb3IpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0RGlmZnVzZUNvbG9yIChyYXk6IFJheSwgaW50ZXJzZWN0OiBhbnksIHJlY3Vyc2l2ZTogYm9vbGVhbiA9IHRydWUpOiBDb2xvciB7XG4gICAgICAgIGxldCBsYW1iQ29sb3I6IENvbG9yLFxuICAgICAgICAgICAgcmFkaWFuY2VDb2xvcjogQ29sb3IsXG4gICAgICAgICAgICBwaG9uZ0NvbG9yOiBDb2xvcixcbiAgICAgICAgICAgIHBpeGVsQ29sb3I6IENvbG9yID0gbmV3IENvbG9yKG5ldyBSR0JDb2xvcigwLCAwLCAwKSksXG4gICAgICAgICAgICBsaWdodERpcmVjdGlvbjogVmVjdG9yLFxuICAgICAgICAgICAgcmVmbGVjdFBob25nVmVjdG9yRGlyOiBWZWN0b3IsXG4gICAgICAgICAgICBsYW1iQ29zOiBudW1iZXIsXG4gICAgICAgICAgICBwaG9uZ0NvczogbnVtYmVyLFxuICAgICAgICAgICAgcGhvbmc6IG51bWJlcjtcblxuICAgICAgICBmb3IgKGxldCBsaWdodCBvZiB0aGlzLnNjZW5lLmdldExpZ2h0cygpKSB7XG4gICAgICAgICAgICAvLyBpZiBsaWdodCAtIHJldHVybiBvbmx5IGxpZ2h0IGNvbG9yXG4gICAgICAgICAgICBpZiAoaW50ZXJzZWN0Wydvd25lclR5cGUnXSA9PT0gJ2xpZ2h0Jykge1xuICAgICAgICAgICAgICAgIHJldHVybiBpbnRlcnNlY3RbJ293bmVyJ11cbiAgICAgICAgICAgICAgICAgICAgLmdldE1hdGVyaWFsKClcbiAgICAgICAgICAgICAgICAgICAgLmdldENvbG9yKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBsaWdodFBvd2VyID0gdGhpcy5nZXRMaWdodFBvd2VyKGludGVyc2VjdCwgbGlnaHQpO1xuXG4gICAgICAgICAgICBsYW1iQ29sb3IgPSBuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDAsIDAsIDApKTtcbiAgICAgICAgICAgIHJhZGlhbmNlQ29sb3IgPSBuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDAsIDAsIDApKTtcbiAgICAgICAgICAgIHBob25nQ29sb3IgPSBuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDAsIDAsIDApKTtcbiAgICAgICAgICAgIGxpZ2h0RGlyZWN0aW9uID0gVmVjdG9yLm5vcm1hbGl6ZWQoXG4gICAgICAgICAgICAgICAgVmVjdG9yLnN1YnN0cmFjdChcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0Wydwb2ludCddLFxuICAgICAgICAgICAgICAgICAgICBsaWdodC5nZXRQb3NpdGlvbigpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgLy8gbGFtYmVydFxuXG4gICAgICAgICAgICBsYW1iQ29zID0gTWF0aC5tYXgoXG4gICAgICAgICAgICAgICAgMCxcbiAgICAgICAgICAgICAgICAtVmVjdG9yLmRvdChcbiAgICAgICAgICAgICAgICAgICAgbGlnaHREaXJlY3Rpb24sXG4gICAgICAgICAgICAgICAgICAgIGludGVyc2VjdFsnb3duZXInXS5nZXROb3JtYWwoaW50ZXJzZWN0Wydwb2ludCddKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGxhbWJDb2xvciA9IGxhbWJDb2xvci5hZGQoXG4gICAgICAgICAgICAgICAgaW50ZXJzZWN0Wydvd25lciddXG4gICAgICAgICAgICAgICAgICAgIC5nZXRNYXRlcmlhbCgpXG4gICAgICAgICAgICAgICAgICAgIC5nZXRDb2xvcigpXG4gICAgICAgICAgICAgICAgICAgIC5tdWx0aXBsZShcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0LmdldE1hdGVyaWFsKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0Q29sb3IoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zY2FsZWQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0UG93ZXIgKiBsYW1iQ29zICogaW50ZXJzZWN0Wydvd25lciddLmdldE1hdGVyaWFsKCkuZ2V0TGFtYmVydENvZWZmKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmIChyZWN1cnNpdmUpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBOVU1fRElSRUNUSU9OUyA9IDM1O1xuXG4gICAgICAgICAgICAgICAgbGV0IHJhbmREaXIgPSAobm9ybWFsOiBWZWN0b3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBkaXI6IFZlY3RvciA9IG5ldyBWZWN0b3IoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5yYW5kb20oKSAtIDAuNSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBNYXRoLnJhbmRvbSgpIC0gMC41LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1hdGgucmFuZG9tKCkgLSAwLjVcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChWZWN0b3IuZG90KGRpciwgZGlyKSA+IDAuNSAqKiAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGRpciA9IFZlY3Rvci5ub3JtYWxpemVkKGRpcik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChWZWN0b3IuZG90KGRpciwgbm9ybWFsKSA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXIgPSBWZWN0b3IuaW52ZXJzZShkaXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGlyO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTlVNX0RJUkVDVElPTlM7ICsraSkge1xuICAgICAgICAgICAgICAgICAgICBsZXQgZGlyOiBWZWN0b3IgPSByYW5kRGlyKGludGVyc2VjdFsnb3duZXInXS5nZXROb3JtYWwoaW50ZXJzZWN0Wydwb2ludCddKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IHJhZGlhbmNlSW5UaGF0RGlyOiBDb2xvciA9IHRoaXMuZ2V0Q29sb3IobmV3IFJheShpbnRlcnNlY3RbJ3BvaW50J10sIGRpciksIGZhbHNlKTtcblxuICAgICAgICAgICAgICAgICAgICBsZXQgY29zSTogbnVtYmVyID0gVmVjdG9yLmRvdChcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpcixcbiAgICAgICAgICAgICAgICAgICAgICAgIGludGVyc2VjdFsnb3duZXInXS5nZXROb3JtYWwoaW50ZXJzZWN0Wydwb2ludCddKVxuICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgIHJhZGlhbmNlQ29sb3IgPSByYWRpYW5jZUNvbG9yXG4gICAgICAgICAgICAgICAgICAgICAgICAuYWRkKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludGVyc2VjdFsnb3duZXInXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0TWF0ZXJpYWwoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0Q29sb3IoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZGl2aWRlKE1hdGguUEkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tdWx0aXBsZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhZGlhbmNlSW5UaGF0RGlyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnNjYWxlZChjb3NJKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG5cbiAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIHBob25nXG5cbiAgICAgICAgICAgIHJlZmxlY3RQaG9uZ1ZlY3RvckRpciA9IFZlY3Rvci5yZWZsZWN0KFxuICAgICAgICAgICAgICAgIGxpZ2h0RGlyZWN0aW9uLFxuICAgICAgICAgICAgICAgIGludGVyc2VjdFsnb3duZXInXS5nZXROb3JtYWwoaW50ZXJzZWN0Wydwb2ludCddKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHBob25nQ29zID0gLVZlY3Rvci5kb3QocmVmbGVjdFBob25nVmVjdG9yRGlyLCByYXkuZ2V0RGlyZWN0aW9uKCkpO1xuXG4gICAgICAgICAgICBpZiAocGhvbmdDb3MgPiAwKSB7XG4gICAgICAgICAgICAgICAgcGhvbmcgPSBNYXRoLnBvdyhwaG9uZ0NvcywgMzUpO1xuICAgICAgICAgICAgICAgIHBob25nQ29sb3IgPSBwaG9uZ0NvbG9yLmFkZChcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0Wydvd25lciddXG4gICAgICAgICAgICAgICAgICAgICAgICAuZ2V0TWF0ZXJpYWwoKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmdldENvbG9yKClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5tdWx0aXBsZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodC5nZXRNYXRlcmlhbCgpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRDb2xvcigpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zY2FsZWQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodFBvd2VyICogcGhvbmcgKiBpbnRlcnNlY3RbJ293bmVyJ10uZ2V0TWF0ZXJpYWwoKS5nZXRQaG9uZ0NvZWZmKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHBpeGVsQ29sb3IgPSBwaXhlbENvbG9yLmFkZChsYW1iQ29sb3IuYWRkKHJhZGlhbmNlQ29sb3IuZGl2aWRlKDE1KSkpLmFkZChwaG9uZ0NvbG9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwaXhlbENvbG9yO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0UmVmbGVjdGlvbkNvbG9yIChyYXk6IFJheSwgaW50ZXJzZWN0OiBhbnkpOiBhbnkge1xuICAgICAgICBsZXQgcmVmbGVjdGlvbkNvbG9yOiBDb2xvcixcbiAgICAgICAgICAgIHJlZmxlY3RlZFJheTogVmVjdG9yO1xuXG4gICAgICAgIHJheS5zZXRJdGVyYXRpb24ocmF5LmdldEl0ZXJhdGlvbigpIC0gMSk7XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgcmF5LmdldEl0ZXJhdGlvbigpID09PSAwIHx8XG4gICAgICAgICAgICBpbnRlcnNlY3RbJ293bmVyJ10uZ2V0TWF0ZXJpYWwoKS5nZXRSZWZsZWN0aW9uVmFsdWUoKSA9PT0gMFxuICAgICAgICApIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDAsIDAsIDApKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlZmxlY3RlZFJheSA9IFZlY3Rvci5yZWZsZWN0KFxuICAgICAgICAgICAgcmF5LmdldERpcmVjdGlvbigpLFxuICAgICAgICAgICAgaW50ZXJzZWN0Wydvd25lciddLmdldE5vcm1hbChpbnRlcnNlY3RbJ3BvaW50J10pXG4gICAgICAgICk7XG5cbiAgICAgICAgcmVmbGVjdGlvbkNvbG9yID0gdGhpcy5nZXRDb2xvcihcbiAgICAgICAgICAgIG5ldyBSYXkoaW50ZXJzZWN0Wydwb2ludCddLCByZWZsZWN0ZWRSYXksIHJheS5nZXRJdGVyYXRpb24oKSlcbiAgICAgICAgKS5zY2FsZWQoXG4gICAgICAgICAgICBpbnRlcnNlY3RbJ293bmVyJ11cbiAgICAgICAgICAgICAgICAuZ2V0TWF0ZXJpYWwoKVxuICAgICAgICAgICAgICAgIC5nZXRSZWZsZWN0aW9uVmFsdWUoKVxuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiByZWZsZWN0aW9uQ29sb3I7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRQZXJzcGVjdGl2ZVZlY3RvciAoeDogbnVtYmVyLCB5OiBudW1iZXIsIHNjcmVlbldpZHRoOiBudW1iZXIsIHNjcmVlbkhlaWdodDogbnVtYmVyKSB7XG4gICAgICAgIGxldCBjYW1lcmE6IENhbWVyYSA9IHRoaXMuc2NlbmUuZ2V0Q2FtZXJhKCk7XG5cbiAgICAgICAgcmV0dXJuIFZlY3Rvci5ub3JtYWxpemVkKFxuICAgICAgICAgICAgVmVjdG9yLmFkZChcbiAgICAgICAgICAgICAgICBjYW1lcmEuZ2V0Rm9yd2FyZFZlY3RvcigpLFxuICAgICAgICAgICAgICAgIFZlY3Rvci5hZGQoXG4gICAgICAgICAgICAgICAgICAgIFZlY3Rvci5zY2FsZWQoXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW1lcmEuZ2V0UmlnaHRWZWN0b3IoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbWVyYS5yZWNlbnRlclgoeClcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgVmVjdG9yLnNjYWxlZChcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbWVyYS5nZXRVcFZlY3RvcigpLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2FtZXJhLnJlY2VudGVyWSh5KVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TGlnaHRQb3dlciAoaW50ZXJzZWN0OiBhbnksIGxpZ2h0OiBBYnN0cmFjdExpZ2h0KTogbnVtYmVyIHtcbiAgICAgICAgY29uc3Qgc2FtcGxpbmcgPSAxMDtcblxuICAgICAgICBsZXQgbGlnaHRQb3dlciA9IGxpZ2h0LmdldFBvd2VyKCksXG4gICAgICAgICAgICBsaWdodFJhbmRvbVBvaW50OiBWZWN0b3IsXG4gICAgICAgICAgICByZXN1bHRQb3dlciA9IDA7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzYW1wbGluZzsgaSsrKSB7XG4gICAgICAgICAgICBsaWdodFJhbmRvbVBvaW50ID0gbGlnaHQuZ2V0UmFuZG9tUG9pbnQoKTtcblxuICAgICAgICAgICAgbGV0IGxpZ2h0UmF5ID0gdGhpcy50cmFjZShcbiAgICAgICAgICAgICAgICBuZXcgUmF5KFxuICAgICAgICAgICAgICAgICAgICBpbnRlcnNlY3RbJ3BvaW50J10sXG4gICAgICAgICAgICAgICAgICAgIFZlY3Rvci5zdWJzdHJhY3QoXG4gICAgICAgICAgICAgICAgICAgICAgICBWZWN0b3Iuc3Vic3RyYWN0KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0LmdldFBvc2l0aW9uKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHRSYW5kb21Qb2ludFxuICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGludGVyc2VjdFsncG9pbnQnXVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgaWYgKGxpZ2h0UmF5Wydwb2ludCddID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChsaWdodFJheVsnb3duZXInXSAhPT0gbGlnaHQpIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmVzdWx0UG93ZXIgKz0gKFxuICAgICAgICAgICAgICAgIGxpZ2h0UG93ZXIgLVxuICAgICAgICAgICAgICAgIChcbiAgICAgICAgICAgICAgICAgICAgVmVjdG9yLnN1YnN0cmFjdChcbiAgICAgICAgICAgICAgICAgICAgICAgIFZlY3Rvci5zdWJzdHJhY3QoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHQuZ2V0UG9zaXRpb24oKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodFJhbmRvbVBvaW50XG4gICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0Wydwb2ludCddXG4gICAgICAgICAgICAgICAgICAgICkuZ2V0TGVuZ3RoKCkgKiAobGlnaHRQb3dlciAvIGxpZ2h0LmdldEZhZGVSYWRpdXMoKSlcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApIC8gc2FtcGxpbmc7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0UG93ZXI7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0cmFjZSAocmF5OiBSYXkpOiB7ZGlzdGFuY2U6IG51bWJlciwgcG9pbnQ6IFZlY3Rvciwgb3duZXI6IGFueSwgb3duZXJUeXBlOiBzdHJpbmd9IHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IHtcbiAgICAgICAgICAgICAgICBkaXN0YW5jZTogMCxcbiAgICAgICAgICAgICAgICBwb2ludDogbnVsbCxcbiAgICAgICAgICAgICAgICBvd25lcjogbnVsbCxcbiAgICAgICAgICAgICAgICBvd25lclR5cGU6IG51bGxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBpbnRlcnNlY3REYXRhOiBhbnksXG4gICAgICAgICAgICBzY2VuZU9iamVjdHNXaXRoTGlnaHRzOiBhbnlbXSA9IHRoaXMuc2NlbmUuZ2V0T2JqZWN0cygpLmNvbmNhdCh0aGlzLnNjZW5lLmdldExpZ2h0cygpKTtcblxuICAgICAgICBmb3IgKGxldCBvYmplY3Qgb2Ygc2NlbmVPYmplY3RzV2l0aExpZ2h0cykge1xuICAgICAgICAgICAgaW50ZXJzZWN0RGF0YSA9IG9iamVjdC5nZXRJbnRlcnNlY3REYXRhKHJheSk7XG5cbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3REYXRhICYmXG4gICAgICAgICAgICAgICAgaW50ZXJzZWN0RGF0YVsnZGlzdGFuY2UnXSA+IDAgJiZcbiAgICAgICAgICAgICAgICAoXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFsnb3duZXInXSA9PT0gbnVsbCB8fFxuICAgICAgICAgICAgICAgICAgICBpbnRlcnNlY3REYXRhWydkaXN0YW5jZSddIDwgcmVzdWx0WydkaXN0YW5jZSddXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0WydkaXN0YW5jZSddID0gaW50ZXJzZWN0RGF0YVsnZGlzdGFuY2UnXTtcbiAgICAgICAgICAgICAgICByZXN1bHRbJ3BvaW50J10gPSBpbnRlcnNlY3REYXRhWydwb2ludCddO1xuICAgICAgICAgICAgICAgIHJlc3VsdFsnb3duZXInXSA9IG9iamVjdDtcbiAgICAgICAgICAgICAgICByZXN1bHRbJ293bmVyVHlwZSddID0gb2JqZWN0LmdldFR5cGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHVibGljIHJlbmRlciAoY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsIHNjcmVlbldpZHRoPzogbnVtYmVyLCBzY3JlZW5IZWlnaHQ/OiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgcmFuZG9NdWx0aXBsaWVyID0gMC41O1xuXG4gICAgICAgIGxldCBjb2xvcjogQ29sb3IsXG4gICAgICAgICAgICByYW5kOiBudW1iZXIsXG4gICAgICAgICAgICByYXk6IFJheSxcbiAgICAgICAgICAgIHJnYkNvbG9yOiB7XG4gICAgICAgICAgICAgICAgcmVkOiBudW1iZXIsXG4gICAgICAgICAgICAgICAgZ3JlZW46IG51bWJlcixcbiAgICAgICAgICAgICAgICBibHVlOiBudW1iZXJcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5zY3JlZW5XaWR0aCA9IHNjcmVlbldpZHRoO1xuICAgICAgICB0aGlzLnNjcmVlbkhlaWdodCA9IHNjcmVlbkhlaWdodDtcblxuICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHNjcmVlbkhlaWdodDsgeSsrKSB7XG4gICAgICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8IHNjcmVlbldpZHRoOyB4KyspIHtcbiAgICAgICAgICAgICAgICBjb2xvciA9IG5ldyBDb2xvcihuZXcgUkdCQ29sb3IoMCwgMCwgMCkpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHksIHgpO1xuXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaXRlciA9IDA7IGl0ZXIgPCB0aGlzLnJheXNQZXJQaXhlbDsgaXRlcisrKSB7XG4gICAgICAgICAgICAgICAgICAgIHJhbmQgPSAwO1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGl0ZXIpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJheXNQZXJQaXhlbCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVyICUgMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmQgKz0gTWF0aC5yYW5kb20oKSAqIHJhbmRvTXVsdGlwbGllcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmQgLT0gTWF0aC5yYW5kb20oKSAqIHJhbmRvTXVsdGlwbGllcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHJheSA9IG5ldyBSYXkoXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNjZW5lLmdldENhbWVyYSgpLmdldFBvc2l0aW9uKCksXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldFBlcnNwZWN0aXZlVmVjdG9yKHggKyByYW5kLCB5ICsgcmFuZCwgc2NyZWVuV2lkdGgsIHNjcmVlbkhlaWdodClcbiAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICBjb2xvciA9IGNvbG9yLmFkZCh0aGlzLmdldENvbG9yKHJheSkpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGNvbG9yID0gY29sb3IuZGl2aWRlKHRoaXMucmF5c1BlclBpeGVsKTtcblxuICAgICAgICAgICAgICAgIGZvciAobGV0IGNvbXBvbmVudCBpbiBjb2xvcikge1xuICAgICAgICAgICAgICAgICAgICBjb2xvcltjb21wb25lbnRdID0gQ29sb3Iuc1JHQkVuY29kZShjb2xvcltjb21wb25lbnRdKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICByZ2JDb2xvciA9IENvbG9yLnRvUkdCKGNvbG9yKTtcblxuICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBgcmdiKCR7cmdiQ29sb3IucmVkfSwgJHtyZ2JDb2xvci5ncmVlbn0sICR7cmdiQ29sb3IuYmx1ZX0pYDtcbiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoeCwgeSwgeCArIDEsIHkgKyAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHVibGljIHNldFNjZW5lIChzY2VuZTogU2NlbmUpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zY2VuZSA9IHNjZW5lO1xuICAgIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
