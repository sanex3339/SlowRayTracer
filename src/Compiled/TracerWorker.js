var Camera_1=require("./Camera"),Color_1=require("./Color/Color"),Ray_1=require("./Ray"),RGBColor_1=require("./Color/RGBColor"),Scene_1=require("./Scene"),Sphere_1=require("./Objects/Sphere"),Vector_1=require("./Vector"),SphericalLight_1=require("./Lights/SphericalLight"),Material_1=require("./Material"),Polygon_1=require("./Objects/Polygon"),Tracer=function(){function e(){this.pixelSamples=4,this.shadowSamples=35,this.aoSamples=100,this.giSamples=35,this.screenWidth=250,this.screenHeight=250}return e.prototype.getColor=function(e,o){void 0===o&&(o=!0);var t=this.trace(e),r=new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)),a=new Color_1.Color(new RGBColor_1.RGBColor(0,0,0));return null===t.owner?new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)):(r=this.getDiffuseColor(e,t,o),o&&(a=this.getReflectionColor(e,t)),r.add(a))},e.prototype.getDiffuseColor=function(e,o,t){void 0===t&&(t=!0);for(var r,a,n,l,i,c,s,C,_,w,V,g=new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)),d=0,h=this.scene.getLights();d<h.length;d++){var p=h[d];if("light"===o.ownerType)return o.owner.getMaterial().getColor();s=this.getLightPower(o,p),r=new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)),a=new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)),n=new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)),i=new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)),c=Vector_1.Vector.normalized(Vector_1.Vector.substract(o.point,p.getPosition())),_=-Vector_1.Vector.dot(c,o.normal),r=r.add(o.owner.getMaterial().getColor().multiple(p.getMaterial().getColor().scaled(s*_*o.owner.getMaterial().getLambertCoeff())));var M=function(e){var o=Math.random(),t=Math.random(),r=Math.acos(Math.sqrt(1-o)),a=2*Math.PI*t,n=Math.sin(r)*Math.cos(a),l=Math.cos(r),i=Math.sin(r)*Math.sin(a),c=e,s=e;s=Math.abs(s.getCoordinates().x)<=Math.abs(s.getCoordinates().y)&&Math.abs(s.getCoordinates().x)<=Math.abs(s.getCoordinates().z)?new Vector_1.Vector(1,s.getCoordinates().y,s.getCoordinates().z):Math.abs(s.getCoordinates().y)<=Math.abs(s.getCoordinates().x)&&Math.abs(s.getCoordinates().x)<=Math.abs(s.getCoordinates().z)?new Vector_1.Vector(s.getCoordinates().x,1,s.getCoordinates().z):new Vector_1.Vector(s.getCoordinates().x,s.getCoordinates().y,1);var C=Vector_1.Vector.normalized(new Vector_1.Vector(Math.pow(s.getCoordinates().x,c.getCoordinates().x),Math.pow(s.getCoordinates().y,c.getCoordinates().y),Math.pow(s.getCoordinates().z,c.getCoordinates().z))),_=Vector_1.Vector.normalized(new Vector_1.Vector(Math.pow(C.getCoordinates().x,c.getCoordinates().x),Math.pow(C.getCoordinates().y,c.getCoordinates().y),Math.pow(C.getCoordinates().z,c.getCoordinates().z))),w=Vector_1.Vector.add(Vector_1.Vector.add(Vector_1.Vector.scaled(C,n),Vector_1.Vector.scaled(c,l)),Vector_1.Vector.scaled(_,i));return Vector_1.Vector.normalized(w)};if(t)for(var R=0;R<this.giSamples;++R){var u=void 0,m=void 0;l=M(o.owner.getNormal(o.point)),u=this.getColor(new Ray_1.Ray(o.point,l),!1),m=Vector_1.Vector.dot(l,o.owner.getNormal(o.point)),a=a.add(o.owner.getMaterial().getColor().divide(Math.PI).multiple(u.scaled(m)))}for(var f=0,R=0;R<this.aoSamples;R++){var y=M(o.owner.getNormal(o.point)),B=this.trace(new Ray_1.Ray(o.point,y));null!==B.point&&(B.distance>250||f++)}C=Vector_1.Vector.reflect(c,o.normal),w=-Vector_1.Vector.dot(C,e.getDirection()),w>0&&(V=Math.pow(w,35),i=i.add(o.owner.getMaterial().getColor().multiple(p.getMaterial().getColor().scaled(s*V*o.owner.getMaterial().getPhongCoeff())))),g=g.add(r.add(a.divide(this.giSamples))).add(i),g=g.substract(g.scaled(.3*f/this.aoSamples))}return g},e.prototype.getReflectionColor=function(e,o){var t,r,a=e.getIteration(),n=o.owner.getMaterial().getReflectionValue();return e.setIteration(--a),0===a||0===n?new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)):(r=Vector_1.Vector.reflect(e.getDirection(),o.normal),t=this.getColor(new Ray_1.Ray(o.point,r,a)).scaled(n))},e.prototype.getPerspectiveVector=function(e,o){var t=this.scene.getCamera();return Vector_1.Vector.normalized(Vector_1.Vector.add(t.getForwardVector(),Vector_1.Vector.add(Vector_1.Vector.scaled(t.getRightVector(),t.recenterX(e)),Vector_1.Vector.scaled(t.getUpVector(),t.recenterY(o)))))},e.prototype.getLightPower=function(e,o){for(var t,r,a=o.getPower(),n=0,l=0;l<this.shadowSamples;l++)t=o.getRandomPoint(),r=this.trace(new Ray_1.Ray(e.point,Vector_1.Vector.substract(Vector_1.Vector.substract(o.getPosition(),t),e.point))),null!==r.point&&r.owner===o&&(n+=(a-Vector_1.Vector.substract(Vector_1.Vector.substract(o.getPosition(),t),e.point).getLength()*(a/o.getFadeRadius()))/this.shadowSamples);return n},e.prototype.trace=function(e){for(var o,t={distance:0,point:null,normal:null,owner:null,ownerType:null},r=this.scene.getObjects().concat(this.scene.getLights()),a=0,n=r;a<n.length;a++){var l=n[a];o=l.getIntersectData(e),o&&o.distance>0&&(null===t.owner||o.distance<t.distance)&&(t.distance=o.distance,t.point=o.point,t.owner=l,t.ownerType=l.getType(),t.normal=t.owner.getNormal(t.point))}return t},e.prototype.render=function(e,o,t,r){var a,n,l,i,c=.5;this.screenWidth=e,this.screenHeight=o,a=new Color_1.Color(new RGBColor_1.RGBColor(0,0,0));for(var s=0;s<this.pixelSamples;s++)n=0,this.pixelSamples>1&&(s%2?n+=Math.random()*c:n-=Math.random()*c),l=new Ray_1.Ray(this.scene.getCamera().getPosition(),this.getPerspectiveVector(t+n,r+n)),a=a.add(this.getColor(l));a=a.divide(this.pixelSamples);for(var C in a)a[C]=Color_1.Color.sRGBEncode(a[C]);i=Color_1.Color.toRGB(a),self.postMessage([t,r,i.red,i.green,i.blue])},e.prototype.setScene=function(e){this.scene=e},e}();onmessage=function(e){var o=e.data;"string"==typeof o&&(o=JSON.parse("["+o+"]"));var t=new Tracer;t.setScene(new Scene_1.Scene({camera:new Camera_1.Camera(new Vector_1.Vector(0,0,-699),new Vector_1.Vector(0,0,1),o[0],o[1]),lights:[new SphericalLight_1.SphericalLight(new Vector_1.Vector(0,640,0),.7,50).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(255,255,255)))),new SphericalLight_1.SphericalLight(new Vector_1.Vector(0,0,0),.7,150).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(255,235,200))))],objects:[new Polygon_1.Polygon(new Vector_1.Vector(-700,-700,-700),new Vector_1.Vector(700,-700,-700),new Vector_1.Vector(700,-700,700),new Vector_1.Vector(-700,-700,700)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(255,255,255)),0).setLambertCoeff(1)),new Polygon_1.Polygon(new Vector_1.Vector(-700,-700,700),new Vector_1.Vector(700,-700,700),new Vector_1.Vector(700,700,700),new Vector_1.Vector(-700,700,700)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(255,255,255)),0).setLambertCoeff(1)),new Polygon_1.Polygon(new Vector_1.Vector(-700,700,-700),new Vector_1.Vector(-700,700,700),new Vector_1.Vector(700,700,700),new Vector_1.Vector(700,700,-700)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(255,255,255)),0).setLambertCoeff(1)),new Polygon_1.Polygon(new Vector_1.Vector(700,-700,700),new Vector_1.Vector(700,-700,-700),new Vector_1.Vector(700,700,-700),new Vector_1.Vector(700,700,700)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(79,166,242)),0).setLambertCoeff(1)),new Polygon_1.Polygon(new Vector_1.Vector(-700,-700,-700),new Vector_1.Vector(-700,-700,700),new Vector_1.Vector(-700,700,700),new Vector_1.Vector(-700,700,-700)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(245,130,130)),0).setLambertCoeff(1)),new Polygon_1.Polygon(new Vector_1.Vector(700,-700,-700),new Vector_1.Vector(-700,-700,-700),new Vector_1.Vector(-700,700,-700),new Vector_1.Vector(700,700,-700)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)),0).setLambertCoeff(1)),new Sphere_1.Sphere(new Vector_1.Vector(-250,-500,450),200).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(0,0,0)),1)),new Sphere_1.Sphere(new Vector_1.Vector(250,-500,400),200).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(0,255,0)),0))]})),t.render(o[0],o[1],o[2],o[3])};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlRyYWNlcldvcmtlci50cyJdLCJuYW1lcyI6WyJDYW1lcmFfMSIsInJlcXVpcmUiLCJDb2xvcl8xIiwiUmF5XzEiLCJSR0JDb2xvcl8xIiwiU2NlbmVfMSIsIlNwaGVyZV8xIiwiVmVjdG9yXzEiLCJTcGhlcmljYWxMaWdodF8xIiwiTWF0ZXJpYWxfMSIsIlBvbHlnb25fMSIsIlRyYWNlciIsIlRyYWNlci5jb25zdHJ1Y3RvciIsIlRyYWNlci5nZXRDb2xvciIsIlRyYWNlci5nZXREaWZmdXNlQ29sb3IiLCJUcmFjZXIuZ2V0UmVmbGVjdGlvbkNvbG9yIiwiVHJhY2VyLmdldFBlcnNwZWN0aXZlVmVjdG9yIiwiVHJhY2VyLmdldExpZ2h0UG93ZXIiLCJUcmFjZXIudHJhY2UiLCJUcmFjZXIucmVuZGVyIiwiVHJhY2VyLnNldFNjZW5lIiwib25tZXNzYWdlIiwibWVzc2FnZSIsImRhdGEiLCJKU09OIiwicGFyc2UiLCJ0cmFjZXIiLCJzZXRTY2VuZSIsIlNjZW5lIiwiY2FtZXJhIiwiQ2FtZXJhIiwiVmVjdG9yIiwibGlnaHRzIiwiU3BoZXJpY2FsTGlnaHQiLCJzZXRNYXRlcmlhbCIsIk1hdGVyaWFsIiwiQ29sb3IiLCJSR0JDb2xvciIsIm9iamVjdHMiLCJQb2x5Z29uIiwic2V0TGFtYmVydENvZWZmIiwiU3BoZXJlIiwicmVuZGVyIl0sIm1hcHBpbmdzIjoiQUFHQSxHQUFBQSxVQUFBQyxRQUF1QixZQUN2QkMsUUFBQUQsUUFBc0IsaUJBQ3RCRSxNQUFBRixRQUFvQixTQUNwQkcsV0FBQUgsUUFBeUIsb0JBRXpCSSxRQUFBSixRQUFzQixXQUN0QkssU0FBQUwsUUFBdUIsb0JBQ3ZCTSxTQUFBTixRQUF1QixZQUd2Qk8saUJBQUFQLFFBQStCLDJCQUMvQlEsV0FBQVIsUUFBeUIsY0FDekJTLFVBQUFULFFBQXdCLHFCQUV4QlUsT0FBQSxXQUFBQSxRQUFBQSxLQUVZQyxLQUFBQSxhQUF1QkEsRUFDdkJBLEtBQUFBLGNBQXdCQSxHQUN4QkEsS0FBQUEsVUFB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RUFBRUEsaUJBQW9CQSxHQUVqRUEsS0FBS0EsSUFBSUEsRUFBRUEsaUJBQW9CQSxJQUFNQSxLQUFLQSxJQUFJQSxFQUFFQSxpQkFBb0JBLElBQ3BFQSxLQUFLQSxJQUFJQSxFQUFFQSxpQkFBb0JBLElBQU1BLEtBQUtBLElBQUlBLEVBQUVBLGlCQUFvQkEsR0FFaEVBLEdBQUlBLFVBQUFBLE9BQU9BLEVBQUVBLGlCQUFvQkEsRUFBR0EsRUFBR0EsRUFBRUEsaUJBQW9CQSxHQUU3REEsR0FBSUEsVUFBQUEsT0FBT0EsRUFBRUEsaUJBQW9CQSxFQUFHQSxFQUFFQSxpQkFBb0JBLEVBQUdBLEVBSXJFQSxJQUFJQSxHQUFJQSxTQUFBQSxPQUFPQSxXQUNYQSxHQUFJQSxVQUFBQSxPQUNBQSxLQUFBQSxJQUFBQSxFQUFFQSxpQkFBb0JBLEVBQUtBLEVBQUVBLGlCQUFvQkEsR0FDakRBLEtBQUFBLElBQUFBLEVBQUVBLGlCQUFvQkEsRUFBS0EsRUFBRUEsaUJBQW9CQSxHQUNqREEsS0FBQUEsSUFBQUEsRUFBRUEsaUJBQW9CQSxFQUFLQSxFQUFFQSxpQkFBb0JBLEtBSXJEQSxFQUFJQSxTQUFBQSxPQUFPQSxXQUNYQSxHQUFJQSxVQUFBQSxPQUNBQSxLQUFBQSxJQUFBQSxFQUFFQSxpQkFBb0JBLEVBQUtBLEVBQUVBLGlCQUFvQkEsR0FDakRBLEtBQUFBLElBQUFBLEVBQUVBLGlCQUFvQkEsRUFBS0EsRUFBRUEsaUJBQW9CQSxHQUNqREEsS0FBQUEsSUFBQUEsRUFBRUEsaUJBQW9CQSxFQUFLQSxFQUFFQSxpQkFBb0JBLEtBSXJEQSxFQUFZQSxTQUFBQSxPQUFPQSxJQUNuQkEsU0FBQUEsT0FBT0EsSUFDSEEsU0FBQUEsT0FBT0EsT0FBT0EsRUFBR0EsR0FDakJBLFNBQUFBLE9BQU9BLE9BQU9BLEVBQUdBLElBRXJCQSxTQUFBQSxPQUFPQSxPQUFPQSxFQUFHQSxHQUdyQkEsT0FBT0EsVUFBQUEsT0FBT0EsV0FBV0EsR0F1QzdCQSxJQUFJQSxFQUNBQSxJQUFLQSxHQUFJQSxHQUFJQSxFQUFHQSxFQUFJQSxL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QUFBbUMsT0FBTyxHQUFJbEMsVUFBQXdCLE9BQU8sSUFBSyxLQUFNLEtBQU0sS0FDbENHLFlBQVksR0FBSXpCLFlBQUEwQixTQUFTLEdBQUlqQyxTQUFBa0MsTUFBTSxHQUFJaEMsWUFBQWlDLFNBQVMsRUFBRyxJQUFLLElBQUssUUFLOUVYLEVBQU9nQixPQUFPbkIsRUFBSyxHQUFJQSxFQUFLLEdBQUlBLEVBQUssR0FBSUEsRUFBSyIsImZpbGUiOiJUcmFjZXJXb3JrZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBuby1kZWZhdWx0LWxpYj1cInRydWVcIi8+XG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwibGliL2xpYi53ZWJ3b3JrZXIuZC50c1wiIC8+XG5cbmltcG9ydCB7IENhbWVyYSB9IGZyb20gXCIuL0NhbWVyYVwiO1xuaW1wb3J0IHsgQ29sb3IgfSBmcm9tIFwiLi9Db2xvci9Db2xvclwiO1xuaW1wb3J0IHsgUmF5IH0gZnJvbSBcIi4vUmF5XCI7XG5pbXBvcnQgeyBSR0JDb2xvciB9IGZyb20gXCIuL0NvbG9yL1JHQkNvbG9yXCI7XG5pbXBvcnQgeyBSVE1hdGggfSBmcm9tIFwiLi9SVE1hdGhcIjtcbmltcG9ydCB7IFNjZW5lIH0gZnJvbSBcIi4vU2NlbmVcIjtcbmltcG9ydCB7IFNwaGVyZSB9IGZyb20gXCIuL09iamVjdHMvU3BoZXJlXCI7XG5pbXBvcnQgeyBWZWN0b3IgfSBmcm9tIFwiLi9WZWN0b3JcIjtcbmltcG9ydCB7IFBsYW5lIH0gZnJvbSBcIi4vT2JqZWN0cy9QbGFuZVwiO1xuaW1wb3J0IHsgQWJzdHJhY3RMaWdodCB9IGZyb20gXCIuL0xpZ2h0cy9BYnN0cmFjdExpZ2h0XCI7XG5pbXBvcnQgeyBTcGhlcmljYWxMaWdodCB9IGZyb20gXCIuL0xpZ2h0cy9TcGhlcmljYWxMaWdodFwiO1xuaW1wb3J0IHsgTWF0ZXJpYWwgfSBmcm9tIFwiLi9NYXRlcmlhbFwiO1xuaW1wb3J0IHsgUG9seWdvbiB9IGZyb20gXCIuL09iamVjdHMvUG9seWdvblwiO1xuXG5jbGFzcyBUcmFjZXIge1xuICAgIHByaXZhdGUgc2NlbmU6IFNjZW5lO1xuICAgIHByaXZhdGUgcGl4ZWxTYW1wbGVzOiBudW1iZXIgPSA0O1xuICAgIHByaXZhdGUgc2hhZG93U2FtcGxlczogbnVtYmVyID0gMzU7XG4gICAgcHJpdmF0ZSBhb1NhbXBsZXM6IG51bWJlciA9IDEwMDtcbiAgICBwcml2YXRlIGdpU2FtcGxlczogbnVtYmVyID0gMzU7XG4gICAgcHJpdmF0ZSBzY3JlZW5XaWR0aDogbnVtYmVyID0gMjUwO1xuICAgIHByaXZhdGUgc2NyZWVuSGVpZ2h0OiBudW1iZXIgPSAyNTA7XG5cbiAgICBwcml2YXRlIGdldENvbG9yIChyYXk6IFJheSwgcmVjdXJjaXZlOiBib29sZWFuID0gdHJ1ZSk6IENvbG9yIHtcbiAgICAgICAgbGV0IGludGVyc2VjdCA9IHRoaXMudHJhY2UocmF5KSxcbiAgICAgICAgICAgIGRpZmZ1c2VDb2xvcjogQ29sb3IgPSBuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDAsIDAsIDApKSxcbiAgICAgICAgICAgIHJlZmxlY3RDb2xvcjogQ29sb3IgPSBuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDAsIDAsIDApKTtcblxuICAgICAgICBpZiAoaW50ZXJzZWN0Wydvd25lciddID09PSBudWxsKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IENvbG9yKG5ldyBSR0JDb2xvcigwLCAwLCAwKSk7XG4gICAgICAgIH1cblxuICAgICAgICBkaWZmdXNlQ29sb3IgPSB0aGlzLmdldERpZmZ1c2VDb2xvcihyYXksIGludGVyc2VjdCwgcmVjdXJjaXZlKTtcblxuICAgICAgICBpZiAocmVjdXJjaXZlKSB7XG4gICAgICAgICAgICByZWZsZWN0Q29sb3IgPSB0aGlzLmdldFJlZmxlY3Rpb25Db2xvcihyYXksIGludGVyc2VjdCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZGlmZnVzZUNvbG9yLmFkZChyZWZsZWN0Q29sb3IpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0RGlmZnVzZUNvbG9yIChyYXk6IFJheSwgaW50ZXJzZWN0OiBhbnksIHJlY3Vyc2l2ZTogYm9vbGVhbiA9IHRydWUpOiBDb2xvciB7XG4gICAgICAgIGxldCBsYW1iQ29sb3I6IENvbG9yLFxuICAgICAgICAgICAgcmFkaWFuY2VDb2xvcjogQ29sb3IsXG4gICAgICAgICAgICBhbWJpZW50T2NjbHVzaW9uQ29sb3I6IENvbG9yLFxuICAgICAgICAgICAgcmFkaWFuY2VSYW5kb21EaXJlY3Rpb246IFZlY3RvcixcbiAgICAgICAgICAgIHBob25nQ29sb3I6IENvbG9yLFxuICAgICAgICAgICAgcGl4ZWxDb2xvcjogQ29sb3IgPSBuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDAsIDAsIDApKSxcbiAgICAgICAgICAgIGxpZ2h0RGlyZWN0aW9uOiBWZWN0b3IsXG4gICAgICAgICAgICBsaWdodFBvd2VyOiBudW1iZXIsXG4gICAgICAgICAgICByZWZsZWN0UGhvbmdWZWN0b3JEaXI6IFZlY3RvcixcbiAgICAgICAgICAgIGxhbWJDb3M6IG51bWJlcixcbiAgICAgICAgICAgIHBob25nQ29zOiBudW1iZXIsXG4gICAgICAgICAgICBwaG9uZzogbnVtYmVyO1xuXG4gICAgICAgIGZvciAobGV0IGxpZ2h0IG9mIHRoaXMuc2NlbmUuZ2V0TGlnaHRzKCkpIHtcbiAgICAgICAgICAgIGlmIChpbnRlcnNlY3RbJ293bmVyVHlwZSddID09PSAnbGlnaHQnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGludGVyc2VjdFsnb3duZXInXVxuICAgICAgICAgICAgICAgICAgICAuZ2V0TWF0ZXJpYWwoKVxuICAgICAgICAgICAgICAgICAgICAuZ2V0Q29sb3IoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGlnaHRQb3dlciA9IHRoaXMuZ2V0TGlnaHRQb3dlcihpbnRlcnNlY3QsIGxpZ2h0KTtcblxuICAgICAgICAgICAgbGFtYkNvbG9yID0gbmV3IENvbG9yKG5ldyBSR0JDb2xvcigwLCAwLCAwKSk7XG4gICAgICAgICAgICByYWRpYW5jZUNvbG9yID0gbmV3IENvbG9yKG5ldyBSR0JDb2xvcigwLCAwLCAwKSk7XG4gICAgICAgICAgICBhbWJpZW50T2NjbHVzaW9uQ29sb3IgPSBuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDAsIDAsIDApKTtcbiAgICAgICAgICAgIHBob25nQ29sb3IgPSBuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDAsIDAsIDApKTtcbiAgICAgICAgICAgIGxpZ2h0RGlyZWN0aW9uID0gVmVjdG9yLm5vcm1hbGl6ZWQoXG4gICAgICAgICAgICAgICAgVmVjdG9yLnN1YnN0cmFjdChcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0Wydwb2ludCddLFxuICAgICAgICAgICAgICAgICAgICBsaWdodC5nZXRQb3NpdGlvbigpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgLy8gbGFtYmVydFxuXG4gICAgICAgICAgICBsYW1iQ29zID0gLVZlY3Rvci5kb3QoXG4gICAgICAgICAgICAgICAgbGlnaHREaXJlY3Rpb24sXG4gICAgICAgICAgICAgICAgaW50ZXJzZWN0Wydub3JtYWwnXVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgbGFtYkNvbG9yID0gbGFtYkNvbG9yLmFkZChcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3RbJ293bmVyJ11cbiAgICAgICAgICAgICAgICAgICAgLmdldE1hdGVyaWFsKClcbiAgICAgICAgICAgICAgICAgICAgLmdldENvbG9yKClcbiAgICAgICAgICAgICAgICAgICAgLm11bHRpcGxlKFxuICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHQuZ2V0TWF0ZXJpYWwoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRDb2xvcigpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnNjYWxlZChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHRQb3dlciAqIGxhbWJDb3MgKiBpbnRlcnNlY3RbJ293bmVyJ10uZ2V0TWF0ZXJpYWwoKS5nZXRMYW1iZXJ0Q29lZmYoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgbGV0IGNvc2luZVdlaWdodGVkRGlyZWN0aW9uU291cmNlID0gKG5vcm1hbDogVmVjdG9yKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IFhpMSA9IE1hdGgucmFuZG9tKCk7XG4gICAgICAgICAgICAgICAgbGV0IFhpMiA9IE1hdGgucmFuZG9tKCk7XG5cbiAgICAgICAgICAgICAgICBsZXQgdGhldGEgPSBNYXRoLmFjb3MoTWF0aC5zcXJ0KDEgLSBYaTEpKTtcbiAgICAgICAgICAgICAgICBsZXQgIHBoaSA9IDIgKiBNYXRoLlBJICogWGkyO1xuXG4gICAgICAgICAgICAgICAgbGV0IHhzID0gTWF0aC5zaW4odGhldGEpICogTWF0aC5jb3MocGhpKTtcbiAgICAgICAgICAgICAgICBsZXQgeXMgPSBNYXRoLmNvcyh0aGV0YSk7XG4gICAgICAgICAgICAgICAgbGV0IHpzID0gTWF0aC5zaW4odGhldGEpICogTWF0aC5zaW4ocGhpKTtcblxuICAgICAgICAgICAgICAgIGxldCB5ID0gbm9ybWFsO1xuICAgICAgICAgICAgICAgIGxldCBoID0gbm9ybWFsO1xuICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgTWF0aC5hYnMoaC5nZXRDb29yZGluYXRlcygpWyd4J10pIDw9IE1hdGguYWJzKGguZ2V0Q29vcmRpbmF0ZXMoKVsneSddKSAmJlxuICAgICAgICAgICAgICAgICAgICBNYXRoLmFicyhoLmdldENvb3JkaW5hdGVzKClbJ3gnXSkgPD0gTWF0aC5hYnMoaC5nZXRDb29yZGluYXRlcygpWyd6J10pXG4gICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgIGggPSBuZXcgVmVjdG9yKDEsIGguZ2V0Q29vcmRpbmF0ZXMoKVsneSddLCBoLmdldENvb3JkaW5hdGVzKClbJ3onXSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgICAgICAgICAgICAgTWF0aC5hYnMoaC5nZXRDb29yZGluYXRlcygpWyd5J10pIDw9IE1hdGguYWJzKGguZ2V0Q29vcmRpbmF0ZXMoKVsneCddKSAmJlxuICAgICAgICAgICAgICAgICAgICBNYXRoLmFicyhoLmdldENvb3JkaW5hdGVzKClbJ3gnXSkgPD0gTWF0aC5hYnMoaC5nZXRDb29yZGluYXRlcygpWyd6J10pXG4gICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgIGggPSBuZXcgVmVjdG9yKGguZ2V0Q29vcmRpbmF0ZXMoKVsneCddLCAxLCBoLmdldENvb3JkaW5hdGVzKClbJ3onXSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaCA9IG5ldyBWZWN0b3IoaC5nZXRDb29yZGluYXRlcygpWyd4J10sIGguZ2V0Q29vcmRpbmF0ZXMoKVsneSddLCAxKTtcbiAgICAgICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgICAgIGxldCB4ID0gVmVjdG9yLm5vcm1hbGl6ZWQoXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoXG4gICAgICAgICAgICAgICAgICAgICAgICBoLmdldENvb3JkaW5hdGVzKClbJ3gnXSAqKiB5LmdldENvb3JkaW5hdGVzKClbJ3gnXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGguZ2V0Q29vcmRpbmF0ZXMoKVsneSddICoqIHkuZ2V0Q29vcmRpbmF0ZXMoKVsneSddLFxuICAgICAgICAgICAgICAgICAgICAgICAgaC5nZXRDb29yZGluYXRlcygpWyd6J10gKiogeS5nZXRDb29yZGluYXRlcygpWyd6J11cbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICBsZXQgeiA9IFZlY3Rvci5ub3JtYWxpemVkKFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKFxuICAgICAgICAgICAgICAgICAgICAgICAgeC5nZXRDb29yZGluYXRlcygpWyd4J10gKiogeS5nZXRDb29yZGluYXRlcygpWyd4J10sXG4gICAgICAgICAgICAgICAgICAgICAgICB4LmdldENvb3JkaW5hdGVzKClbJ3knXSAqKiB5LmdldENvb3JkaW5hdGVzKClbJ3knXSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHguZ2V0Q29vcmRpbmF0ZXMoKVsneiddICoqIHkuZ2V0Q29vcmRpbmF0ZXMoKVsneiddXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgbGV0IGRpcmVjdGlvbiA9IFZlY3Rvci5hZGQoXG4gICAgICAgICAgICAgICAgICAgIFZlY3Rvci5hZGQoXG4gICAgICAgICAgICAgICAgICAgICAgICBWZWN0b3Iuc2NhbGVkKHgsIHhzKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFZlY3Rvci5zY2FsZWQoeSwgeXMpXG4gICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgIFZlY3Rvci5zY2FsZWQoeiwgenMpXG4gICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBWZWN0b3Iubm9ybWFsaXplZChkaXJlY3Rpb24pO1xuXG4gICAgICAgICAgICAgICAgLypsZXQgYmFzaXNUcmFuc2Zvcm06IFZlY3RvcixcbiAgICAgICAgICAgICAgICAgICAgYml0YW5nZW50OiBWZWN0b3IsXG4gICAgICAgICAgICAgICAgICAgIHUxOiBudW1iZXIgPSBNYXRoLnJhbmRvbSgpLFxuICAgICAgICAgICAgICAgICAgICB1MjogbnVtYmVyID0gTWF0aC5yYW5kb20oKSxcbiAgICAgICAgICAgICAgICAgICAgc2luX3RoZXRhOiBudW1iZXIgPSBNYXRoLnNxcnQodTEpLFxuICAgICAgICAgICAgICAgICAgICBjb3NfdGhldGE6IG51bWJlciA9IE1hdGguc3FydCgxIC0gdTEpLFxuICAgICAgICAgICAgICAgICAgICBwaGk6IG51bWJlciA9IDIgKiBNYXRoLlBJICogdTIsXG4gICAgICAgICAgICAgICAgICAgIGRpcjogVmVjdG9yID0gbmV3IFZlY3RvcihcbiAgICAgICAgICAgICAgICAgICAgICAgIHNpbl90aGV0YSAqIE1hdGguY29zKHBoaSksXG4gICAgICAgICAgICAgICAgICAgICAgICBjb3NfdGhldGEsXG4gICAgICAgICAgICAgICAgICAgICAgICBzaW5fdGhldGEgKiBNYXRoLnNpbihwaGkpXG4gICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgIHRhbmdlbnQ6IFZlY3RvcjtcblxuICAgICAgICAgICAgICAgIGlmIChub3JtYWwuZ2V0Q29vcmRpbmF0ZXMoKVsneCddID09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdGFuZ2VudCA9IG5ldyBWZWN0b3IoMSwgMCwgMCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGFuZ2VudCA9IFZlY3Rvci5ub3JtYWxpemVkKFxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IFZlY3RvcihcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3JtYWwuZ2V0Q29vcmRpbmF0ZXMoKVsneiddLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLW5vcm1hbC5nZXRDb29yZGluYXRlcygpWyd4J11cbiAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBiaXRhbmdlbnQgPSBWZWN0b3IuY3Jvc3ModGFuZ2VudCwgbm9ybWFsKTtcblxuICAgICAgICAgICAgICAgIGJhc2lzVHJhbnNmb3JtID0gbmV3IFZlY3RvcihcbiAgICAgICAgICAgICAgICAgICAgVmVjdG9yLmRvdCh0YW5nZW50LCBkaXIpLFxuICAgICAgICAgICAgICAgICAgICBWZWN0b3IuZG90KG5vcm1hbCwgZGlyKSxcbiAgICAgICAgICAgICAgICAgICAgVmVjdG9yLmRvdChiaXRhbmdlbnQsIGRpcilcbiAgICAgICAgICAgICAgICApOyovXG5cbiAgICAgICAgICAgICAgICAvL3JldHVybiBWZWN0b3Iubm9ybWFsaXplZChiYXNpc1RyYW5zZm9ybSk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBpZiAocmVjdXJzaXZlKSB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmdpU2FtcGxlczsgKytpKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCByYWRpYW5jZUluUmFuZG9tRGlyZWN0aW9uOiBDb2xvcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3NJOiBudW1iZXI7XG5cbiAgICAgICAgICAgICAgICAgICAgcmFkaWFuY2VSYW5kb21EaXJlY3Rpb24gPSBjb3NpbmVXZWlnaHRlZERpcmVjdGlvblNvdXJjZShpbnRlcnNlY3RbJ293bmVyJ10uZ2V0Tm9ybWFsKGludGVyc2VjdFsncG9pbnQnXSkpO1xuICAgICAgICAgICAgICAgICAgICByYWRpYW5jZUluUmFuZG9tRGlyZWN0aW9uID0gdGhpcy5nZXRDb2xvcihcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBSYXkoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0Wydwb2ludCddLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhZGlhbmNlUmFuZG9tRGlyZWN0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgY29zSSA9IFZlY3Rvci5kb3QoXG4gICAgICAgICAgICAgICAgICAgICAgICByYWRpYW5jZVJhbmRvbURpcmVjdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgIGludGVyc2VjdFsnb3duZXInXS5nZXROb3JtYWwoaW50ZXJzZWN0Wydwb2ludCddKVxuICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgIHJhZGlhbmNlQ29sb3IgPSByYWRpYW5jZUNvbG9yXG4gICAgICAgICAgICAgICAgICAgICAgICAuYWRkKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludGVyc2VjdFsnb3duZXInXVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0TWF0ZXJpYWwoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0Q29sb3IoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZGl2aWRlKE1hdGguUEkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tdWx0aXBsZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhZGlhbmNlSW5SYW5kb21EaXJlY3Rpb25cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc2NhbGVkKGNvc0kpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcblxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy9hbWJpZW50IG9jY2x1c2lvblxuICAgICAgICAgICAgbGV0IGMgPSAwO1xuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuYW9TYW1wbGVzOyBpKyspIHtcbiAgICAgICAgICAgICAgICBsZXQgZGlyID0gY29zaW5lV2VpZ2h0ZWREaXJlY3Rpb25Tb3VyY2UoaW50ZXJzZWN0Wydvd25lciddLmdldE5vcm1hbChpbnRlcnNlY3RbJ3BvaW50J10pKTtcblxuICAgICAgICAgICAgICAgIGxldCBhb0ludGVyc2VjdCA9IHRoaXMudHJhY2UoXG4gICAgICAgICAgICAgICAgICAgIG5ldyBSYXkoXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnNlY3RbJ3BvaW50J10sXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXJcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICBpZiAoYW9JbnRlcnNlY3RbJ3BvaW50J10gPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGFvSW50ZXJzZWN0WydkaXN0YW5jZSddID4gMjUwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGMrKztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gcGhvbmdcblxuICAgICAgICAgICAgcmVmbGVjdFBob25nVmVjdG9yRGlyID0gVmVjdG9yLnJlZmxlY3QoXG4gICAgICAgICAgICAgICAgbGlnaHREaXJlY3Rpb24sXG4gICAgICAgICAgICAgICAgaW50ZXJzZWN0Wydub3JtYWwnXVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHBob25nQ29zID0gLVZlY3Rvci5kb3QocmVmbGVjdFBob25nVmVjdG9yRGlyLCByYXkuZ2V0RGlyZWN0aW9uKCkpO1xuXG4gICAgICAgICAgICBpZiAocGhvbmdDb3MgPiAwKSB7XG4gICAgICAgICAgICAgICAgcGhvbmcgPSBNYXRoLnBvdyhwaG9uZ0NvcywgMzUpO1xuICAgICAgICAgICAgICAgIHBob25nQ29sb3IgPSBwaG9uZ0NvbG9yLmFkZChcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0Wydvd25lciddXG4gICAgICAgICAgICAgICAgICAgICAgICAuZ2V0TWF0ZXJpYWwoKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmdldENvbG9yKClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5tdWx0aXBsZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodC5nZXRNYXRlcmlhbCgpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRDb2xvcigpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zY2FsZWQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodFBvd2VyICogcGhvbmcgKiBpbnRlcnNlY3RbJ293bmVyJ10uZ2V0TWF0ZXJpYWwoKS5nZXRQaG9uZ0NvZWZmKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHBpeGVsQ29sb3IgPSBwaXhlbENvbG9yXG4gICAgICAgICAgICAgICAgLmFkZChcbiAgICAgICAgICAgICAgICAgICAgbGFtYkNvbG9yLmFkZChcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhZGlhbmNlQ29sb3IuZGl2aWRlKHRoaXMuZ2lTYW1wbGVzKVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKS5hZGQocGhvbmdDb2xvcik7XG5cbiAgICAgICAgICAgIHBpeGVsQ29sb3IgPSBwaXhlbENvbG9yLnN1YnN0cmFjdChwaXhlbENvbG9yLnNjYWxlZCgwLjMgKiBjIC8gdGhpcy5hb1NhbXBsZXMpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwaXhlbENvbG9yO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0UmVmbGVjdGlvbkNvbG9yIChyYXk6IFJheSwgaW50ZXJzZWN0OiBhbnkpOiBhbnkge1xuICAgICAgICBsZXQgcmF5SXRlcmF0aW9uOiBudW1iZXIgPSByYXkuZ2V0SXRlcmF0aW9uKCksXG4gICAgICAgICAgICByZWZsZWN0aW9uQ29sb3I6IENvbG9yLFxuICAgICAgICAgICAgcmVmbGVjdGlvblZhbHVlOiBudW1iZXIgPSBpbnRlcnNlY3RbJ293bmVyJ10uZ2V0TWF0ZXJpYWwoKS5nZXRSZWZsZWN0aW9uVmFsdWUoKSxcbiAgICAgICAgICAgIHJlZmxlY3RlZFJheTogVmVjdG9yO1xuXG4gICAgICAgIHJheS5zZXRJdGVyYXRpb24oLS1yYXlJdGVyYXRpb24pO1xuXG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIHJheUl0ZXJhdGlvbiA9PT0gMCB8fFxuICAgICAgICAgICAgcmVmbGVjdGlvblZhbHVlID09PSAwXG4gICAgICAgICkge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBDb2xvcihuZXcgUkdCQ29sb3IoMCwgMCwgMCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVmbGVjdGVkUmF5ID0gVmVjdG9yLnJlZmxlY3QoXG4gICAgICAgICAgICByYXkuZ2V0RGlyZWN0aW9uKCksXG4gICAgICAgICAgICBpbnRlcnNlY3RbJ25vcm1hbCddXG4gICAgICAgICk7XG5cbiAgICAgICAgcmVmbGVjdGlvbkNvbG9yID0gdGhpcy5nZXRDb2xvcihcbiAgICAgICAgICAgIG5ldyBSYXkoaW50ZXJzZWN0Wydwb2ludCddLCByZWZsZWN0ZWRSYXksIHJheUl0ZXJhdGlvbilcbiAgICAgICAgKS5zY2FsZWQocmVmbGVjdGlvblZhbHVlKTtcblxuICAgICAgICByZXR1cm4gcmVmbGVjdGlvbkNvbG9yO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0UGVyc3BlY3RpdmVWZWN0b3IgKHg6IG51bWJlciwgeTogbnVtYmVyKSB7XG4gICAgICAgIGxldCBjYW1lcmE6IENhbWVyYSA9IHRoaXMuc2NlbmUuZ2V0Q2FtZXJhKCk7XG5cbiAgICAgICAgcmV0dXJuIFZlY3Rvci5ub3JtYWxpemVkKFxuICAgICAgICAgICAgVmVjdG9yLmFkZChcbiAgICAgICAgICAgICAgICBjYW1lcmEuZ2V0Rm9yd2FyZFZlY3RvcigpLFxuICAgICAgICAgICAgICAgIFZlY3Rvci5hZGQoXG4gICAgICAgICAgICAgICAgICAgIFZlY3Rvci5zY2FsZWQoXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW1lcmEuZ2V0UmlnaHRWZWN0b3IoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbWVyYS5yZWNlbnRlclgoeClcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgVmVjdG9yLnNjYWxlZChcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbWVyYS5nZXRVcFZlY3RvcigpLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2FtZXJhLnJlY2VudGVyWSh5KVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TGlnaHRQb3dlciAoaW50ZXJzZWN0OiBhbnksIGxpZ2h0OiBBYnN0cmFjdExpZ2h0KTogbnVtYmVyIHtcbiAgICAgICAgbGV0IGxpZ2h0UG93ZXIgPSBsaWdodC5nZXRQb3dlcigpLFxuICAgICAgICAgICAgbGlnaHRSYW5kb21Qb2ludDogVmVjdG9yLFxuICAgICAgICAgICAgbGlnaHRSYXk6IGFueSxcbiAgICAgICAgICAgIHJlc3VsdFBvd2VyOiBudW1iZXIgPSAwO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zaGFkb3dTYW1wbGVzOyBpKyspIHtcbiAgICAgICAgICAgIGxpZ2h0UmFuZG9tUG9pbnQgPSBsaWdodC5nZXRSYW5kb21Qb2ludCgpO1xuXG4gICAgICAgICAgICBsaWdodFJheSA9IHRoaXMudHJhY2UoXG4gICAgICAgICAgICAgICAgbmV3IFJheShcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0Wydwb2ludCddLFxuICAgICAgICAgICAgICAgICAgICBWZWN0b3Iuc3Vic3RyYWN0KFxuICAgICAgICAgICAgICAgICAgICAgICAgVmVjdG9yLnN1YnN0cmFjdChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodC5nZXRQb3NpdGlvbigpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0UmFuZG9tUG9pbnRcbiAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnNlY3RbJ3BvaW50J11cbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmIChsaWdodFJheVsncG9pbnQnXSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAobGlnaHRSYXlbJ293bmVyJ10gIT09IGxpZ2h0KSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJlc3VsdFBvd2VyICs9IChcbiAgICAgICAgICAgICAgICBsaWdodFBvd2VyIC1cbiAgICAgICAgICAgICAgICAoXG4gICAgICAgICAgICAgICAgICAgIFZlY3Rvci5zdWJzdHJhY3QoXG4gICAgICAgICAgICAgICAgICAgICAgICBWZWN0b3Iuc3Vic3RyYWN0KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0LmdldFBvc2l0aW9uKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHRSYW5kb21Qb2ludFxuICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGludGVyc2VjdFsncG9pbnQnXVxuICAgICAgICAgICAgICAgICAgICApLmdldExlbmd0aCgpICogKGxpZ2h0UG93ZXIgLyBsaWdodC5nZXRGYWRlUmFkaXVzKCkpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKSAvIHRoaXMuc2hhZG93U2FtcGxlcztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHRQb3dlcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIHRyYWNlIChyYXk6IFJheSk6IHtkaXN0YW5jZTogbnVtYmVyLCBwb2ludDogVmVjdG9yLCBvd25lcjogYW55LCBvd25lclR5cGU6IHN0cmluZ30ge1xuICAgICAgICBsZXQgcmVzdWx0ID0ge1xuICAgICAgICAgICAgICAgIGRpc3RhbmNlOiAwLFxuICAgICAgICAgICAgICAgIHBvaW50OiBudWxsLFxuICAgICAgICAgICAgICAgIG5vcm1hbDogbnVsbCxcbiAgICAgICAgICAgICAgICBvd25lcjogbnVsbCxcbiAgICAgICAgICAgICAgICBvd25lclR5cGU6IG51bGxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBpbnRlcnNlY3REYXRhOiBhbnksXG4gICAgICAgICAgICBzY2VuZU9iamVjdHNXaXRoTGlnaHRzOiBhbnlbXSA9IHRoaXMuc2NlbmUuZ2V0T2JqZWN0cygpLmNvbmNhdCh0aGlzLnNjZW5lLmdldExpZ2h0cygpKTtcblxuICAgICAgICBmb3IgKGxldCBvYmplY3Qgb2Ygc2NlbmVPYmplY3RzV2l0aExpZ2h0cykge1xuICAgICAgICAgICAgaW50ZXJzZWN0RGF0YSA9IG9iamVjdC5nZXRJbnRlcnNlY3REYXRhKHJheSk7XG5cbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3REYXRhICYmXG4gICAgICAgICAgICAgICAgaW50ZXJzZWN0RGF0YVsnZGlzdGFuY2UnXSA+IDAgJiZcbiAgICAgICAgICAgICAgICAoXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFsnb3duZXInXSA9PT0gbnVsbCB8fFxuICAgICAgICAgICAgICAgICAgICBpbnRlcnNlY3REYXRhWydkaXN0YW5jZSddIDwgcmVzdWx0WydkaXN0YW5jZSddXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0WydkaXN0YW5jZSddID0gaW50ZXJzZWN0RGF0YVsnZGlzdGFuY2UnXTtcbiAgICAgICAgICAgICAgICByZXN1bHRbJ3BvaW50J10gPSBpbnRlcnNlY3REYXRhWydwb2ludCddO1xuICAgICAgICAgICAgICAgIHJlc3VsdFsnb3duZXInXSA9IG9iamVjdDtcbiAgICAgICAgICAgICAgICByZXN1bHRbJ293bmVyVHlwZSddID0gb2JqZWN0LmdldFR5cGUoKTtcbiAgICAgICAgICAgICAgICByZXN1bHRbJ25vcm1hbCddID0gcmVzdWx0Wydvd25lciddLmdldE5vcm1hbChyZXN1bHRbJ3BvaW50J10pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVuZGVyIChzY3JlZW5XaWR0aDogbnVtYmVyLCBzY3JlZW5IZWlnaHQ6IG51bWJlciwgeDogbnVtYmVyLCB5OiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgcmFuZG9NdWx0aXBsaWVyID0gMC41O1xuXG4gICAgICAgIGxldCBjb2xvcjogQ29sb3IsXG4gICAgICAgICAgICByYW5kOiBudW1iZXIsXG4gICAgICAgICAgICByYXk6IFJheSxcbiAgICAgICAgICAgIHJnYkNvbG9yOiB7XG4gICAgICAgICAgICAgICAgcmVkOiBudW1iZXIsXG4gICAgICAgICAgICAgICAgZ3JlZW46IG51bWJlcixcbiAgICAgICAgICAgICAgICBibHVlOiBudW1iZXJcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5zY3JlZW5XaWR0aCA9IHNjcmVlbldpZHRoO1xuICAgICAgICB0aGlzLnNjcmVlbkhlaWdodCA9IHNjcmVlbkhlaWdodDtcblxuICAgICAgICBjb2xvciA9IG5ldyBDb2xvcihuZXcgUkdCQ29sb3IoMCwgMCwgMCkpO1xuXG4gICAgICAgIGZvciAobGV0IGl0ZXIgPSAwOyBpdGVyIDwgdGhpcy5waXhlbFNhbXBsZXM7IGl0ZXIrKykge1xuICAgICAgICAgICAgcmFuZCA9IDA7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLnBpeGVsU2FtcGxlcyA+IDEpIHtcbiAgICAgICAgICAgICAgICBpZiAoaXRlciAlIDIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmFuZCArPSBNYXRoLnJhbmRvbSgpICogcmFuZG9NdWx0aXBsaWVyO1xuICAgICAgICAgICAgICAgIH0gIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByYW5kIC09IE1hdGgucmFuZG9tKCkgKiByYW5kb011bHRpcGxpZXI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByYXkgPSBuZXcgUmF5KFxuICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUuZ2V0Q2FtZXJhKCkuZ2V0UG9zaXRpb24oKSxcbiAgICAgICAgICAgICAgICB0aGlzLmdldFBlcnNwZWN0aXZlVmVjdG9yKHggKyByYW5kLCB5ICsgcmFuZClcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGNvbG9yID0gY29sb3IuYWRkKHRoaXMuZ2V0Q29sb3IocmF5KSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb2xvciA9IGNvbG9yLmRpdmlkZSh0aGlzLnBpeGVsU2FtcGxlcyk7XG5cbiAgICAgICAgZm9yIChsZXQgY29tcG9uZW50IGluIGNvbG9yKSB7XG4gICAgICAgICAgICBjb2xvcltjb21wb25lbnRdID0gQ29sb3Iuc1JHQkVuY29kZShjb2xvcltjb21wb25lbnRdKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJnYkNvbG9yID0gQ29sb3IudG9SR0IoY29sb3IpO1xuXG4gICAgICAgIHNlbGYucG9zdE1lc3NhZ2UoW3gsIHksIHJnYkNvbG9yLnJlZCwgcmdiQ29sb3IuZ3JlZW4sIHJnYkNvbG9yLmJsdWVdKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0U2NlbmUgKHNjZW5lOiBTY2VuZSk6IHZvaWQge1xuICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7XG4gICAgfVxufVxuXG5vbm1lc3NhZ2UgPSBmdW5jdGlvbiAobWVzc2FnZSkge1xuICAgIHZhciBkYXRhID0gbWVzc2FnZS5kYXRhO1xuXG4gICAgaWYgKHR5cGVvZihkYXRhKSA9PSAnc3RyaW5nJykge1xuICAgICAgICBkYXRhID0gSlNPTi5wYXJzZSgnWycrZGF0YSsnXScpO1xuICAgIH1cblxuICAgIGxldCB0cmFjZXIgPSBuZXcgVHJhY2VyKCk7XG5cbiAgICB0cmFjZXIuc2V0U2NlbmUoXG4gICAgICAgIG5ldyBTY2VuZSh7XG4gICAgICAgICAgICBjYW1lcmE6IG5ldyBDYW1lcmEoXG4gICAgICAgICAgICAgICAgbmV3IFZlY3RvcigwLCAwLCAtNjk5KSxcbiAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKDAsIDAsIDEpLFxuICAgICAgICAgICAgICAgIGRhdGFbMF0sXG4gICAgICAgICAgICAgICAgZGF0YVsxXVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGxpZ2h0czogW1xuICAgICAgICAgICAgICAgIG5ldyBTcGhlcmljYWxMaWdodChuZXcgVmVjdG9yICgwLCA2NDAsIDApLCAwLjcsIDUwKVxuICAgICAgICAgICAgICAgICAgICAuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKG5ldyBDb2xvcihuZXcgUkdCQ29sb3IoMjU1LCAyNTUsIDI1NSkpKSksXG4gICAgICAgICAgICAgICAgbmV3IFNwaGVyaWNhbExpZ2h0KG5ldyBWZWN0b3IgKDAsIDAsIDApLCAwLjcsIDE1MClcbiAgICAgICAgICAgICAgICAgICAgLnNldE1hdGVyaWFsKG5ldyBNYXRlcmlhbChuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDI1NSwgMjM1LCAyMDApKSkpXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgb2JqZWN0czogW1xuICAgICAgICAgICAgICAgIC8vbmV3IFBsYW5lKG5ldyBWZWN0b3IoMCwgMSwgMCksIC00MDApLnNldE1hdGVyaWFsKG5ldyBNYXRlcmlhbChuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDExNSwgMTE1LCAxMTUpKSwgMCkpLFxuICAgICAgICAgICAgICAgIC8vIGJvdHRvbSBwbGFuZVxuICAgICAgICAgICAgICAgIG5ldyBQb2x5Z29uKFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKC03MDAsIC03MDAsIC03MDApLFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKDcwMCwgLTcwMCwgLTcwMCksXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoNzAwLCAtNzAwLCA3MDApLFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKC03MDAsIC03MDAsIDcwMClcbiAgICAgICAgICAgICAgICApLnNldE1hdGVyaWFsKG5ldyBNYXRlcmlhbChuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDI1NSwgMjU1LCAyNTUpKSwgMCkuc2V0TGFtYmVydENvZWZmKDEpKSxcbiAgICAgICAgICAgICAgICAvLyBmcm9udCBwbGFuZVxuICAgICAgICAgICAgICAgIG5ldyBQb2x5Z29uKFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKC03MDAsIC03MDAsIDcwMCksXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoNzAwLCAtNzAwLCA3MDApLFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKDcwMCwgNzAwLCA3MDApLFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKC03MDAsIDcwMCwgNzAwKVxuICAgICAgICAgICAgICAgICkuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKG5ldyBDb2xvcihuZXcgUkdCQ29sb3IoMjU1LCAyNTUsIDI1NSkpLCAwKS5zZXRMYW1iZXJ0Q29lZmYoMSkpLFxuICAgICAgICAgICAgICAgIC8vIHRvcCBwbGFuZVxuICAgICAgICAgICAgICAgIG5ldyBQb2x5Z29uKFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKC03MDAsIDcwMCwgLTcwMCksXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoLTcwMCwgNzAwLCA3MDApLFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKDcwMCwgNzAwLCA3MDApLFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKDcwMCwgNzAwLCAtNzAwKVxuICAgICAgICAgICAgICAgICkuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKG5ldyBDb2xvcihuZXcgUkdCQ29sb3IoMjU1LCAyNTUsIDI1NSkpLCAwKS5zZXRMYW1iZXJ0Q29lZmYoMSkpLFxuICAgICAgICAgICAgICAgIC8vcmlnaHQgcGxhbmVcbiAgICAgICAgICAgICAgICBuZXcgUG9seWdvbihcbiAgICAgICAgICAgICAgICAgICAgbmV3IFZlY3Rvcig3MDAsIC03MDAsIDcwMCksXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoNzAwLCAtNzAwLCAtNzAwKSxcbiAgICAgICAgICAgICAgICAgICAgbmV3IFZlY3Rvcig3MDAsIDcwMCwgLTcwMCksXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoNzAwLCA3MDAsIDcwMClcbiAgICAgICAgICAgICAgICApLnNldE1hdGVyaWFsKG5ldyBNYXRlcmlhbChuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDc5LCAxNjYsIDI0MikpLCAwKS5zZXRMYW1iZXJ0Q29lZmYoMSkpLFxuICAgICAgICAgICAgICAgIC8vbGVmdCBwbGFuZVxuICAgICAgICAgICAgICAgIG5ldyBQb2x5Z29uKFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKC03MDAsIC03MDAsIC03MDApLFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKC03MDAsIC03MDAsIDcwMCksXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoLTcwMCwgNzAwLCA3MDApLFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKC03MDAsIDcwMCwgLTcwMClcbiAgICAgICAgICAgICAgICApLnNldE1hdGVyaWFsKG5ldyBNYXRlcmlhbChuZXcgQ29sb3IobmV3IFJHQkNvbG9yKDI0NSwgMTMwLCAxMzApKSwgMCkuc2V0TGFtYmVydENvZWZmKDEpKSxcbiAgICAgICAgICAgICAgICAvLyBiYWNrIHBsYW5lXG4gICAgICAgICAgICAgICAgbmV3IFBvbHlnb24oXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoNzAwLCAtNzAwLCAtNzAwKSxcbiAgICAgICAgICAgICAgICAgICAgbmV3IFZlY3RvcigtNzAwLCAtNzAwLCAtNzAwKSxcbiAgICAgICAgICAgICAgICAgICAgbmV3IFZlY3RvcigtNzAwLCA3MDAsIC03MDApLFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKDcwMCwgNzAwLCAtNzAwKVxuICAgICAgICAgICAgICAgICkuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKG5ldyBDb2xvcihuZXcgUkdCQ29sb3IoMCwgMCwgMCkpLCAwKS5zZXRMYW1iZXJ0Q29lZmYoMSkpLFxuICAgICAgICAgICAgICAgIG5ldyBTcGhlcmUobmV3IFZlY3RvcigtMjUwLCAtNTAwLCA0NTApLCAyMDApXG4gICAgICAgICAgICAgICAgICAgIC5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWwobmV3IENvbG9yKG5ldyBSR0JDb2xvcigwLCAwLCAwKSksIDEpKSxcbiAgICAgICAgICAgICAgICBuZXcgU3BoZXJlKG5ldyBWZWN0b3IoMjUwLCAtNTAwLCA0MDApLCAyMDApXG4gICAgICAgICAgICAgICAgICAgIC5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWwobmV3IENvbG9yKG5ldyBSR0JDb2xvcigwLCAyNTUsIDApKSwgMCkpXG4gICAgICAgICAgICBdXG4gICAgICAgIH0pXG4gICAgKTtcblxuICAgIHRyYWNlci5yZW5kZXIoZGF0YVswXSwgZGF0YVsxXSwgZGF0YVsyXSwgZGF0YVszXSk7XG59OyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
