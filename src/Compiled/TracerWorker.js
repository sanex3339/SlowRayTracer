"use strict";var Camera_1=require("./Camera"),Color_1=require("./Color/Color"),IntersectPoint_1=require("./IntersectPoint"),Material_1=require("./Material"),Plane_1=require("./Objects/Plane"),Polygon_1=require("./Objects/Polygon"),Ray_1=require("./Ray"),RGBColor_1=require("./Color/RGBColor"),RTMath_1=require("./RTMath"),Scene_1=require("./Scene"),Sphere_1=require("./Objects/Sphere"),Vector_1=require("./Vector"),FloatColor_1=require("./Color/FloatColor"),Tracer=function(){function e(){this.buffer=[],this.screenWidth=250,this.screenHeight=250;for(var e=0;e<this.screenWidth*this.screenHeight*3;e++)this.buffer.push(Color_1.Color.black)}return e.prototype.cosineSampleHemisphere=function(e){var t,r,o=Math.random(),a=Math.random(),n=Math.sqrt(o),c=2*Math.PI*a;return t=Math.abs(e.getCoordinates().x)<.5?Vector_1.Vector.cross(e,new Vector_1.Vector(1,0,0)):Vector_1.Vector.cross(e,new Vector_1.Vector(0,1,0)),r=Vector_1.Vector.cross(e,t),Vector_1.Vector.add(Vector_1.Vector.scale(e,Math.sqrt(1-o)),Vector_1.Vector.add(Vector_1.Vector.scale(t,n*Math.cos(c)),Vector_1.Vector.scale(r,n*Math.sin(c))))},e.prototype.getColor=function(e){var t,r,o,a,n,c=Color_1.Color.black,i=this.trace(e),l=1,s=e.getIteration();if(s>=5){if(Math.random()<=.1)return Color_1.Color.black;l=1/.9}if(!i.getIntersect())return Color_1.Color.black;r=Color_1.Color.black;for(var _=0,g=this.scene.getObjects();_<g.length;_++){var V=g[_];V.getMaterial().getEmission()!=Color_1.Color.black&&(r=r.add(this.getLightPower(e,i,V)))}return c=r.scaled(e.getIteration()).add(i.getOwner().getMaterial().getColor().multiple(i.getOwner().getMaterial().getEmission().scaled(l))),o=this.cosineSampleHemisphere(i.getNormal()),a=Vector_1.Vector.dot(o,e.getDirection())>0?Vector_1.Vector.add(e.getOrigin(),Vector_1.Vector.scale(e.getDirection(),i.getDistanceFromOrigin()*(1+RTMath_1.RTMath.EPSILON))):Vector_1.Vector.add(e.getOrigin(),Vector_1.Vector.scale(e.getDirection(),i.getDistanceFromOrigin()*(1-RTMath_1.RTMath.EPSILON))),t=Vector_1.Vector.dot(o,i.getNormal()),n=this.getColor(new Ray_1.Ray(a,o,++s)),c.add(n.multiple(i.getOwner().getMaterial().getColor()).scaled(t).scaled(.1).scaled(l))},e.prototype.getReflectionColor=function(e,t){var r,o,a=t.getOwner().getMaterial().getReflectionValue();return 0===a?Color_1.Color.black:(o=Vector_1.Vector.reflect(e.getDirection(),t.getNormal()),r=this.getColor(new Ray_1.Ray(t.getHitPoint(),o,e.getIteration())).scaled(a))},e.prototype.getPerspectiveVector=function(e,t){var r=this.scene.getCamera();return Vector_1.Vector.normalize(Vector_1.Vector.add(r.getForwardVector(),Vector_1.Vector.add(Vector_1.Vector.scale(r.getRightVector(),r.recenterX(e)),Vector_1.Vector.scale(r.getUpVector(),r.recenterY(t)))))},e.prototype.getLightPower=function(e,t,r){var o=r.getRandomPoint(),a=this.trace(new Ray_1.Ray(t.getHitPoint(),Vector_1.Vector.substract(Vector_1.Vector.substract(r.getPosition(),o),t.getHitPoint())));return a.getIntersect()&&a.getOwner().getMaterial().getEmissionValue()>0?t.getOwner().getMaterial().getColor():Color_1.Color.black},e.prototype.trace=function(e){for(var t,r=new IntersectPoint_1.IntersectPoint,o=1/0,a=this.scene.getObjects(),n=0,c=a;n<c.length;n++){var i=c[n];t=i.getIntersectData(e),t&&t.distance<o&&(o=t.distance,r.setIntersect(),r.setHitPoint(t.hitPoint),r.setNormal(t.normal),r.setDistanceFromOrigin(t.distance),r.setOwner(i))}return r},e.prototype.render=function(e,t){var r,o,a,n,c=.5,i=1;for(this.screenWidth=e,this.screenHeight=t;;){r=[];for(var l=0,s=0;s<this.screenHeight;s++)for(var _=0;_<this.screenWidth;_++){o=Color_1.Color.black;for(var g=0;i>g;g++)a=0,Math.random()>.5?a+=Math.random()*c:a-=Math.random()*c,n=new Ray_1.Ray(this.scene.getCamera().getPosition(),this.getPerspectiveVector(_+a,s+a)),o=o.add(this.getColor(n));this.buffer[l]=o.divide(i);for(var V in this.buffer[l].getColor())this.buffer[l][V]=Color_1.Color.sRGBEncode(this.buffer[l][V]);r.push(this.buffer[l].getColor().red),r.push(this.buffer[l].getColor().green),r.push(this.buffer[l].getColor().blue),l++}for(var C=0;C<this.buffer.length;C++)this.buffer[C].getColor().red=0,this.buffer[C].getColor().green=0,this.buffer[C].getColor().blue=0;self.postMessage(r)}},e.prototype.setScene=function(e){this.scene=e},e}();onmessage=function(e){var t=e.data;"string"==typeof t&&(t=JSON.parse("["+t+"]"));var r=new Tracer;r.setScene(new Scene_1.Scene({camera:new Camera_1.Camera(new Vector_1.Vector(0,0,-699),new Vector_1.Vector(0,0,1),t[0],t[1]),objects:[new Polygon_1.Polygon(new Vector_1.Vector(-700,700,-700),new Vector_1.Vector(700,700,-700),new Vector_1.Vector(-700,700,700)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(191.25,191.25,191.25))).setLambertCoeff(1)),new Plane_1.Plane(new Vector_1.Vector(0,-1,0),new Vector_1.Vector(0,700,0)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(215,215,215)),new Color_1.Color(new FloatColor_1.FloatColor(30,30,30)))),new Plane_1.Plane(new Vector_1.Vector(-1,0,0),new Vector_1.Vector(700,0,0)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(76.5,255,25.5))).setLambertCoeff(1)),new Plane_1.Plane(new Vector_1.Vector(1,0,0),new Vector_1.Vector(-700,0,0)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(255,76.5,25.5))).setLambertCoeff(1)),new Plane_1.Plane(new Vector_1.Vector(0,0,-1),new Vector_1.Vector(0,0,700)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(191.25,191.25,191.25))).setLambertCoeff(1)),new Plane_1.Plane(new Vector_1.Vector(0,0,1),new Vector_1.Vector(0,0,-700)).setMaterial(new Material_1.Material(Color_1.Color.black).setLambertCoeff(1)),new Sphere_1.Sphere(new Vector_1.Vector(0,-300,400),400).setMaterial(new Material_1.Material(Color_1.Color.gray))]})),r.render(t[0],t[1])};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlRyYWNlcldvcmtlci5qcyIsIlRyYWNlcldvcmtlci50cyJdLCJuYW1lcyI6WyJDYW1lcmFfMSIsInJlcXVpcmUiLCJDb2xvcl8xIiwiSW50ZXJzZWN0UG9pbnRfMSIsIk1hdGVyaWFsXzEiLCJQbGFuZV8xIiwiUG9seWdvbl8xIiwiUmF5XzEiLCJSR0JDb2xvcl8xIiwiUlRNYXRoXzEiLCJTY2VuZV8xIiwiU3BoZXJlXzEiLCJWZWN0b3JfMSIsIkZsb2F0Q29sb3JfMSIsIlRyYWNlciIsIlRyYWNlci5jb25zdHJ1Y3RvciIsIlRyYWNlci5jb3NpbmVTYW1wbGVIZW1pc3BoZXJlIiwiVHJhY2VyLmdldENvbG9yIiwiVHJhY2VyLmdldFJlZmxlY3Rpb25Db2xvciIsIlRyYWNlci5nZXRQZXJzcGVjdGl2ZVZlY3RvciIsIlRyYWNlci5nZXRMaWdodFBvd2VyIiwiVHJhY2VyLnRyYWNlIiwiVHJhY2VyLnJlbmRlciIsIlRyYWNlci5zZXRTY2VuZSIsIm9ubWVzc2FnZSIsIm1lc3NhZ2UiLCJkYXRhIiwiSlNPTiIsInBhcnNlIiwidHJhY2VyIiwic2V0U2NlbmUiLCJTY2VuZSIsImNhbWVyYSIsIkNhbWVyYSIsIlZlY3RvciIsIm9iamVjdHMiLCJQb2x5Z29uIiwic2V0TWF0ZXJpYWwiLCJNYXRlcmlhbCIsIkNvbG9yIiwiUkdCQ29sb3IiLCJzZXRMYW1iZXJ0Q29lZmYiLCJQbGFuZSIsIkZsb2F0Q29sb3IiLCJibGFjayIsIlNwaGVyZSIsImdyYXkiLCJyZW5kZXIiXSwibWFwcGluZ3MiOiJBQUVBLFlDR0EsSUFBQUEsVUFBQUMsUUFBdUIsWUFDdkJDLFFBQUFELFFBQXNCLGlCQUN0QkUsaUJBQUFGLFFBQStCLG9CQUMvQkcsV0FBQUgsUUFBeUIsY0FDekJJLFFBQUFKLFFBQXNCLG1CQUN0QkssVUFBQUwsUUFBd0IscUJBQ3hCTSxNQUFBTixRQUFvQixTQUNwQk8sV0FBQVAsUUFBeUIsb0JBQ3pCUSxTQUFBUixRQUF1QixZQUN2QlMsUUFBQVQsUUFBc0IsV0FD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RUFBRyxFQUFHLEdBQUksR0FBSXRCLFVBQUFzQixPQUFRLEVBQUcsRUFBRyxPQUFPRyxZQUFZLEdBQUlqQyxZQUFBa0MsU0FBU3BDLFFBQUFxQyxNQUFNSyxPQUFPSCxnQkFBZ0IsSUFJOUcsR0FBSTlCLFVBQUFrQyxPQUFPLEdBQUlqQyxVQUFBc0IsT0FBTyxFQUFHLEtBQU0sS0FBTSxLQUNoQ0csWUFBWSxHQUFJakMsWUFBQWtDLFNBQVNwQyxRQUFBcUMsTUFBTU8sV0FLaERqQixFQUFPa0IsT0FBT3JCLEVBQUssR0FBSUEsRUFBSyIsImZpbGUiOiJUcmFjZXJXb3JrZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBuby1kZWZhdWx0LWxpYj1cInRydWVcIi8+XG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwibGliL2xpYi53ZWJ3b3JrZXIuZC50c1wiIC8+XG5cInVzZSBzdHJpY3RcIjtcbnZhciBDYW1lcmFfMSA9IHJlcXVpcmUoXCIuL0NhbWVyYVwiKTtcbnZhciBDb2xvcl8xID0gcmVxdWlyZShcIi4vQ29sb3IvQ29sb3JcIik7XG52YXIgSW50ZXJzZWN0UG9pbnRfMSA9IHJlcXVpcmUoXCIuL0ludGVyc2VjdFBvaW50XCIpO1xudmFyIE1hdGVyaWFsXzEgPSByZXF1aXJlKFwiLi9NYXRlcmlhbFwiKTtcbnZhciBQbGFuZV8xID0gcmVxdWlyZShcIi4vT2JqZWN0cy9QbGFuZVwiKTtcbnZhciBQb2x5Z29uXzEgPSByZXF1aXJlKFwiLi9PYmplY3RzL1BvbHlnb25cIik7XG52YXIgUmF5XzEgPSByZXF1aXJlKFwiLi9SYXlcIik7XG52YXIgUkdCQ29sb3JfMSA9IHJlcXVpcmUoXCIuL0NvbG9yL1JHQkNvbG9yXCIpO1xudmFyIFJUTWF0aF8xID0gcmVxdWlyZShcIi4vUlRNYXRoXCIpO1xudmFyIFNjZW5lXzEgPSByZXF1aXJlKFwiLi9TY2VuZVwiKTtcbnZhciBTcGhlcmVfMSA9IHJlcXVpcmUoXCIuL09iamVjdHMvU3BoZXJlXCIpO1xudmFyIFZlY3Rvcl8xID0gcmVxdWlyZShcIi4vVmVjdG9yXCIpO1xudmFyIEZsb2F0Q29sb3JfMSA9IHJlcXVpcmUoXCIuL0NvbG9yL0Zsb2F0Q29sb3JcIik7XG52YXIgVHJhY2VyID0gKGZ1bmN0aW9uICgpIHtcbiAgICBmdW5jdGlvbiBUcmFjZXIoKSB7XG4gICAgICAgIHRoaXMuYnVmZmVyID0gW107XG4gICAgICAgIHRoaXMuc2NyZWVuV2lkdGggPSAyNTA7XG4gICAgICAgIHRoaXMuc2NyZWVuSGVpZ2h0ID0gMjUwO1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuc2NyZWVuV2lkdGggKiB0aGlzLnNjcmVlbkhlaWdodCAqIDM7IGkrKykge1xuICAgICAgICAgICAgdGhpcy5idWZmZXIucHVzaChDb2xvcl8xLkNvbG9yLmJsYWNrKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBUcmFjZXIucHJvdG90eXBlLmNvc2luZVNhbXBsZUhlbWlzcGhlcmUgPSBmdW5jdGlvbiAobm9ybWFsKSB7XG4gICAgICAgIHZhciB1ID0gTWF0aC5yYW5kb20oKSwgdiA9IE1hdGgucmFuZG9tKCksIHIgPSBNYXRoLnNxcnQodSksIGFuZ2xlID0gMiAqIE1hdGguUEkgKiB2LCBzZGlyLCB0ZGlyO1xuICAgICAgICBpZiAoTWF0aC5hYnMobm9ybWFsLmdldENvb3JkaW5hdGVzKClbJ3gnXSkgPCAwLjUpIHtcbiAgICAgICAgICAgIHNkaXIgPSBWZWN0b3JfMS5WZWN0b3IuY3Jvc3Mobm9ybWFsLCBuZXcgVmVjdG9yXzEuVmVjdG9yKDEsIDAsIDApKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHNkaXIgPSBWZWN0b3JfMS5WZWN0b3IuY3Jvc3Mobm9ybWFsLCBuZXcgVmVjdG9yXzEuVmVjdG9yKDAsIDEsIDApKTtcbiAgICAgICAgfVxuICAgICAgICB0ZGlyID0gVmVjdG9yXzEuVmVjdG9yLmNyb3NzKG5vcm1hbCwgc2Rpcik7XG4gICAgICAgIHJldHVybiBWZWN0b3JfMS5WZWN0b3IuYWRkKFZlY3Rvcl8xLlZlY3Rvci5zY2FsZShub3JtYWwsIE1hdGguc3FydCgxIC0gdSkpLCBWZWN0b3JfMS5WZWN0b3IuYWRkKFZlY3Rvcl8xLlZlY3Rvci5zY2FsZShzZGlyLCByICogTWF0aC5jb3MoYW5nbGUpKSwgVmVjdG9yXzEuVmVjdG9yLnNjYWxlKHRkaXIsIHIgKiBNYXRoLnNpbihhbmdsZSkpKSk7XG4gICAgfTtcbiAgICBUcmFjZXIucHJvdG90eXBlLmdldENvbG9yID0gZnVuY3Rpb24gKHJheSkge1xuICAgICAgICB2YXIgY29sb3IgPSBDb2xvcl8xLkNvbG9yLmJsYWNrLCBjb3N0LCBpbnRlcnNlY3Rpb24gPSB0aGlzLnRyYWNlKHJheSksIGxpZ2h0U2FtcGxpbmdDb2xvciwgbmV3RGlyZWN0aW9uLCBuZXdQb2ludCwgcmFuZEZhY3RvciA9IDEsIHJheUl0ZXJhdGlvbiA9IHJheS5nZXRJdGVyYXRpb24oKSwgdGVtcENvbG9yO1xuICAgICAgICBpZiAocmF5SXRlcmF0aW9uID49IDUpIHtcbiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDw9IDAuMSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBDb2xvcl8xLkNvbG9yLmJsYWNrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmFuZEZhY3RvciA9IDEgLyAoMSAtIDAuMSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFpbnRlcnNlY3Rpb24uZ2V0SW50ZXJzZWN0KCkpIHtcbiAgICAgICAgICAgIHJldHVybiBDb2xvcl8xLkNvbG9yLmJsYWNrO1xuICAgICAgICB9XG4gICAgICAgIGxpZ2h0U2FtcGxpbmdDb2xvciA9IENvbG9yXzEuQ29sb3IuYmxhY2s7XG4gICAgICAgIGZvciAodmFyIF9pID0gMCwgX2EgPSB0aGlzLnNjZW5lLmdldE9iamVjdHMoKTsgX2kgPCBfYS5sZW5ndGg7IF9pKyspIHtcbiAgICAgICAgICAgIHZhciBsaWdodCA9IF9hW19pXTtcbiAgICAgICAgICAgIGlmIChsaWdodC5nZXRNYXRlcmlhbCgpLmdldEVtaXNzaW9uKCkgPT0gQ29sb3JfMS5Db2xvci5ibGFjaykge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGlnaHRTYW1wbGluZ0NvbG9yID0gbGlnaHRTYW1wbGluZ0NvbG9yXG4gICAgICAgICAgICAgICAgLmFkZCh0aGlzLmdldExpZ2h0UG93ZXIocmF5LCBpbnRlcnNlY3Rpb24sIGxpZ2h0KSk7XG4gICAgICAgIH1cbiAgICAgICAgY29sb3IgPSBsaWdodFNhbXBsaW5nQ29sb3Iuc2NhbGVkKHJheS5nZXRJdGVyYXRpb24oKSkuYWRkKGludGVyc2VjdGlvblxuICAgICAgICAgICAgLmdldE93bmVyKClcbiAgICAgICAgICAgIC5nZXRNYXRlcmlhbCgpXG4gICAgICAgICAgICAuZ2V0Q29sb3IoKVxuICAgICAgICAgICAgLm11bHRpcGxlKGludGVyc2VjdGlvblxuICAgICAgICAgICAgLmdldE93bmVyKClcbiAgICAgICAgICAgIC5nZXRNYXRlcmlhbCgpXG4gICAgICAgICAgICAuZ2V0RW1pc3Npb24oKVxuICAgICAgICAgICAgLnNjYWxlZChyYW5kRmFjdG9yKSkpO1xuICAgICAgICBuZXdEaXJlY3Rpb24gPSB0aGlzLmNvc2luZVNhbXBsZUhlbWlzcGhlcmUoaW50ZXJzZWN0aW9uLmdldE5vcm1hbCgpKTtcbiAgICAgICAgaWYgKFZlY3Rvcl8xLlZlY3Rvci5kb3QobmV3RGlyZWN0aW9uLCByYXkuZ2V0RGlyZWN0aW9uKCkpID4gMCkge1xuICAgICAgICAgICAgbmV3UG9pbnQgPSBWZWN0b3JfMS5WZWN0b3IuYWRkKHJheS5nZXRPcmlnaW4oKSwgVmVjdG9yXzEuVmVjdG9yLnNjYWxlKHJheS5nZXREaXJlY3Rpb24oKSwgaW50ZXJzZWN0aW9uLmdldERpc3RhbmNlRnJvbU9yaWdpbigpICogKDEgKyBSVE1hdGhfMS5SVE1hdGguRVBTSUxPTikpKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIG5ld1BvaW50ID0gVmVjdG9yXzEuVmVjdG9yLmFkZChyYXkuZ2V0T3JpZ2luKCksIFZlY3Rvcl8xLlZlY3Rvci5zY2FsZShyYXkuZ2V0RGlyZWN0aW9uKCksIGludGVyc2VjdGlvbi5nZXREaXN0YW5jZUZyb21PcmlnaW4oKSAqICgxIC0gUlRNYXRoXzEuUlRNYXRoLkVQU0lMT04pKSk7XG4gICAgICAgIH1cbiAgICAgICAgY29zdCA9IFZlY3Rvcl8xLlZlY3Rvci5kb3QobmV3RGlyZWN0aW9uLCBpbnRlcnNlY3Rpb24uZ2V0Tm9ybWFsKCkpO1xuICAgICAgICB0ZW1wQ29sb3IgPSB0aGlzLmdldENvbG9yKG5ldyBSYXlfMS5SYXkobmV3UG9pbnQsIG5ld0RpcmVjdGlvbiwgKytyYXlJdGVyYXRpb24pKTtcbiAgICAgICAgcmV0dXJuIGNvbG9yLmFkZCh0ZW1wQ29sb3JcbiAgICAgICAgICAgIC5tdWx0aXBsZShpbnRlcnNlY3Rpb25cbiAgICAgICAgICAgIC5nZXRPd25lcigpXG4gICAgICAgICAgICAuZ2V0TWF0ZXJpYWwoKVxuICAgICAgICAgICAgLmdldENvbG9yKCkpXG4gICAgICAgICAgICAuc2NhbGVkKGNvc3QpXG4gICAgICAgICAgICAuc2NhbGVkKDAuMSlcbiAgICAgICAgICAgIC5zY2FsZWQocmFuZEZhY3RvcikpO1xuICAgIH07XG4gICAgVHJhY2VyLnByb3RvdHlwZS5nZXRSZWZsZWN0aW9uQ29sb3IgPSBmdW5jdGlvbiAocmF5LCBpbnRlcnNlY3QpIHtcbiAgICAgICAgdmFyIHJlZmxlY3Rpb25Db2xvciwgcmVmbGVjdGlvblZhbHVlID0gaW50ZXJzZWN0LmdldE93bmVyKCkuZ2V0TWF0ZXJpYWwoKS5nZXRSZWZsZWN0aW9uVmFsdWUoKSwgcmVmbGVjdGVkUmF5O1xuICAgICAgICBpZiAocmVmbGVjdGlvblZhbHVlID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gQ29sb3JfMS5Db2xvci5ibGFjaztcbiAgICAgICAgfVxuICAgICAgICByZWZsZWN0ZWRSYXkgPSBWZWN0b3JfMS5WZWN0b3IucmVmbGVjdChyYXkuZ2V0RGlyZWN0aW9uKCksIGludGVyc2VjdC5nZXROb3JtYWwoKSk7XG4gICAgICAgIHJlZmxlY3Rpb25Db2xvciA9IHRoaXMuZ2V0Q29sb3IobmV3IFJheV8xLlJheShpbnRlcnNlY3QuZ2V0SGl0UG9pbnQoKSwgcmVmbGVjdGVkUmF5LCByYXkuZ2V0SXRlcmF0aW9uKCkpKS5zY2FsZWQocmVmbGVjdGlvblZhbHVlKTtcbiAgICAgICAgcmV0dXJuIHJlZmxlY3Rpb25Db2xvcjtcbiAgICB9O1xuICAgIFRyYWNlci5wcm90b3R5cGUuZ2V0UGVyc3BlY3RpdmVWZWN0b3IgPSBmdW5jdGlvbiAoeCwgeSkge1xuICAgICAgICB2YXIgY2FtZXJhID0gdGhpcy5zY2VuZS5nZXRDYW1lcmEoKTtcbiAgICAgICAgcmV0dXJuIFZlY3Rvcl8xLlZlY3Rvci5ub3JtYWxpemUoVmVjdG9yXzEuVmVjdG9yLmFkZChjYW1lcmEuZ2V0Rm9yd2FyZFZlY3RvcigpLCBWZWN0b3JfMS5WZWN0b3IuYWRkKFZlY3Rvcl8xLlZlY3Rvci5zY2FsZShjYW1lcmEuZ2V0UmlnaHRWZWN0b3IoKSwgY2FtZXJhLnJlY2VudGVyWCh4KSksIFZlY3Rvcl8xLlZlY3Rvci5zY2FsZShjYW1lcmEuZ2V0VXBWZWN0b3IoKSwgY2FtZXJhLnJlY2VudGVyWSh5KSkpKSk7XG4gICAgfTtcbiAgICBUcmFjZXIucHJvdG90eXBlLmdldExpZ2h0UG93ZXIgPSBmdW5jdGlvbiAocmF5LCBpbnRlcnNlY3QsIG9iamVjdCkge1xuICAgICAgICB2YXIgbCA9IG9iamVjdC5nZXRSYW5kb21Qb2ludCgpO1xuICAgICAgICB2YXIgc2hhZG93UmF5ID0gdGhpcy50cmFjZShuZXcgUmF5XzEuUmF5KGludGVyc2VjdC5nZXRIaXRQb2ludCgpLCBWZWN0b3JfMS5WZWN0b3Iuc3Vic3RyYWN0KFZlY3Rvcl8xLlZlY3Rvci5zdWJzdHJhY3Qob2JqZWN0LmdldFBvc2l0aW9uKCksIGwpLCBpbnRlcnNlY3QuZ2V0SGl0UG9pbnQoKSkpKTtcbiAgICAgICAgaWYgKHNoYWRvd1JheS5nZXRJbnRlcnNlY3QoKSAmJlxuICAgICAgICAgICAgc2hhZG93UmF5LmdldE93bmVyKCkuZ2V0TWF0ZXJpYWwoKS5nZXRFbWlzc2lvblZhbHVlKCkgPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4gaW50ZXJzZWN0XG4gICAgICAgICAgICAgICAgLmdldE93bmVyKClcbiAgICAgICAgICAgICAgICAuZ2V0TWF0ZXJpYWwoKVxuICAgICAgICAgICAgICAgIC5nZXRDb2xvcigpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIENvbG9yXzEuQ29sb3IuYmxhY2s7XG4gICAgICAgIH1cbiAgICAgICAgLypsZXQgbGlnaHRQb3dlciA9IG9iamVjdC5nZXRNYXRlcmlhbCgpLmdldEVtaXNzaW9uKCksXG4gICAgICAgICAgICBsaWdodFJhbmRvbVBvaW50OiBWZWN0b3IsXG4gICAgICAgICAgICBzaGFkb3dSYXk6IEludGVyc2VjdFBvaW50LFxuICAgICAgICAgICAgcmVzdWx0UG93ZXI6IG51bWJlciA9IDA7XG5cbiAgICAgICAgbGlnaHRSYW5kb21Qb2ludCA9IG9iamVjdC5nZXRSYW5kb21Qb2ludCgpO1xuXG4gICAgICAgIHNoYWRvd1JheSA9IHRoaXMudHJhY2UoXG4gICAgICAgICAgICBuZXcgUmF5KFxuICAgICAgICAgICAgICAgIGludGVyc2VjdC5nZXRIaXRQb2ludCgpLFxuICAgICAgICAgICAgICAgIFZlY3Rvci5zdWJzdHJhY3QoXG4gICAgICAgICAgICAgICAgICAgIFZlY3Rvci5zdWJzdHJhY3QoXG4gICAgICAgICAgICAgICAgICAgICAgICBvYmplY3QuZ2V0UG9zaXRpb24oKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0UmFuZG9tUG9pbnRcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0LmdldEhpdFBvaW50KClcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgc2hhZG93UmF5LmdldEludGVyc2VjdCgpICYmXG4gICAgICAgICAgICBzaGFkb3dSYXkuZ2V0T3duZXIoKS5nZXRNYXRlcmlhbCgpLmdldEVtaXNzaW9uVmFsdWUoKSA+IDBcbiAgICAgICAgKSB7XG4gICAgICAgICAgICByZXN1bHRQb3dlciA9IDE7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0UG93ZXI7XG5cbiAgICAgICAgLypsaWdodFJhbmRvbVBvaW50ID0gdGhpcy5jb3NpbmVTYW1wbGVIZW1pc3BoZXJlKFxuICAgICAgICAgICAgaW50ZXJzZWN0LmdldE93bmVyKCkuZ2V0Tm9ybWFsKGludGVyc2VjdC5nZXRIaXRQb2ludCgpKVxuICAgICAgICApO1xuXG4gICAgICAgIHNoYWRvd1JheSA9IHRoaXMudHJhY2UoXG4gICAgICAgICAgICBuZXcgUmF5KFxuICAgICAgICAgICAgICAgIGludGVyc2VjdC5nZXRIaXRQb2ludCgpLFxuICAgICAgICAgICAgICAgIGxpZ2h0UmFuZG9tUG9pbnRcbiAgICAgICAgICAgIClcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoXG4gICAgICAgICAgICBzaGFkb3dSYXkuZ2V0SW50ZXJzZWN0KCkgJiZcbiAgICAgICAgICAgIHNoYWRvd1JheS5nZXRPd25lcigpIGluc3RhbmNlb2YgQWJzdHJhY3RMaWdodFxuICAgICAgICApIHtcbiAgICAgICAgICAgIHJlc3VsdFBvd2VyID0gKFxuICAgICAgICAgICAgICAgIChcbiAgICAgICAgICAgICAgICAgICAgVmVjdG9yLnN1YnN0cmFjdChcbiAgICAgICAgICAgICAgICAgICAgICAgIFZlY3Rvci5zdWJzdHJhY3QoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHQuZ2V0UG9zaXRpb24oKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodFJhbmRvbVBvaW50XG4gICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0LmdldEhpdFBvaW50KClcbiAgICAgICAgICAgICAgICAgICAgKS5nZXRMZW5ndGgoKSAqIChsaWdodFBvd2VyIC8gbGlnaHQuZ2V0RmFkZVJhZGl1cygpKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmIChyZXN1bHRQb3dlciA8IDApIHtcbiAgICAgICAgICAgICAgICByZXN1bHRQb3dlciA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0qL1xuICAgICAgICAvKnJldHVybiByZXN1bHRQb3dlcjsqL1xuICAgIH07XG4gICAgVHJhY2VyLnByb3RvdHlwZS50cmFjZSA9IGZ1bmN0aW9uIChyYXkpIHtcbiAgICAgICAgdmFyIGludGVyc2VjdGlvbiA9IG5ldyBJbnRlcnNlY3RQb2ludF8xLkludGVyc2VjdFBvaW50KCksIGludGVyc2VjdERhdGEsIG1pbkRpc3RhbmNlID0gSW5maW5pdHksIHNjZW5lT2JqZWN0cyA9IHRoaXMuc2NlbmUuZ2V0T2JqZWN0cygpO1xuICAgICAgICBmb3IgKHZhciBfaSA9IDAsIHNjZW5lT2JqZWN0c18xID0gc2NlbmVPYmplY3RzOyBfaSA8IHNjZW5lT2JqZWN0c18xLmxlbmd0aDsgX2krKykge1xuICAgICAgICAgICAgdmFyIG9iamVjdCA9IHNjZW5lT2JqZWN0c18xW19pXTtcbiAgICAgICAgICAgIGludGVyc2VjdERhdGEgPSBvYmplY3QuZ2V0SW50ZXJzZWN0RGF0YShyYXkpO1xuICAgICAgICAgICAgaWYgKGludGVyc2VjdERhdGEgJiZcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3REYXRhWydkaXN0YW5jZSddIDwgbWluRGlzdGFuY2UpIHtcbiAgICAgICAgICAgICAgICBtaW5EaXN0YW5jZSA9IGludGVyc2VjdERhdGFbJ2Rpc3RhbmNlJ107XG4gICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uLnNldEludGVyc2VjdCgpO1xuICAgICAgICAgICAgICAgIGludGVyc2VjdGlvbi5zZXRIaXRQb2ludChpbnRlcnNlY3REYXRhWydoaXRQb2ludCddKTtcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb24uc2V0Tm9ybWFsKGludGVyc2VjdERhdGFbJ25vcm1hbCddKTtcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb24uc2V0RGlzdGFuY2VGcm9tT3JpZ2luKGludGVyc2VjdERhdGFbJ2Rpc3RhbmNlJ10pO1xuICAgICAgICAgICAgICAgIGludGVyc2VjdGlvbi5zZXRPd25lcihvYmplY3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpbnRlcnNlY3Rpb247XG4gICAgfTtcbiAgICBUcmFjZXIucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uIChzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0KSB7XG4gICAgICAgIHZhciByYW5kb011bHRpcGxpZXIgPSAwLjUsIHNwcCA9IDE7XG4gICAgICAgIHZhciBidWZmZXIsIGNvbG9yLCByYW5kLCByYXk7XG4gICAgICAgIHRoaXMuc2NyZWVuV2lkdGggPSBzY3JlZW5XaWR0aDtcbiAgICAgICAgdGhpcy5zY3JlZW5IZWlnaHQgPSBzY3JlZW5IZWlnaHQ7XG4gICAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgICAgICBidWZmZXIgPSBbXTtcbiAgICAgICAgICAgIHZhciBpID0gMDtcbiAgICAgICAgICAgIGZvciAodmFyIHkgPSAwOyB5IDwgdGhpcy5zY3JlZW5IZWlnaHQ7IHkrKykge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIHggPSAwOyB4IDwgdGhpcy5zY3JlZW5XaWR0aDsgeCsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbG9yID0gQ29sb3JfMS5Db2xvci5ibGFjaztcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaXRlcmF0aW9uID0gMDsgaXRlcmF0aW9uIDwgc3BwOyBpdGVyYXRpb24rKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmFuZCA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmQgKz0gTWF0aC5yYW5kb20oKSAqIHJhbmRvTXVsdGlwbGllcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmQgLT0gTWF0aC5yYW5kb20oKSAqIHJhbmRvTXVsdGlwbGllcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJheSA9IG5ldyBSYXlfMS5SYXkodGhpcy5zY2VuZS5nZXRDYW1lcmEoKS5nZXRQb3NpdGlvbigpLCB0aGlzLmdldFBlcnNwZWN0aXZlVmVjdG9yKHggKyByYW5kLCB5ICsgcmFuZCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3IgPSBjb2xvci5hZGQodGhpcy5nZXRDb2xvcihyYXkpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmJ1ZmZlcltpXSA9IGNvbG9yLmRpdmlkZShzcHApO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBjb21wb25lbnQgaW4gdGhpcy5idWZmZXJbaV0uZ2V0Q29sb3IoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5idWZmZXJbaV1bY29tcG9uZW50XSA9IENvbG9yXzEuQ29sb3Iuc1JHQkVuY29kZSh0aGlzLmJ1ZmZlcltpXVtjb21wb25lbnRdKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaCh0aGlzLmJ1ZmZlcltpXS5nZXRDb2xvcigpWydyZWQnXSk7XG4gICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKHRoaXMuYnVmZmVyW2ldLmdldENvbG9yKClbJ2dyZWVuJ10pO1xuICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaCh0aGlzLmJ1ZmZlcltpXS5nZXRDb2xvcigpWydibHVlJ10pO1xuICAgICAgICAgICAgICAgICAgICBpKys7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yICh2YXIgaV8xID0gMDsgaV8xIDwgdGhpcy5idWZmZXIubGVuZ3RoOyBpXzErKykge1xuICAgICAgICAgICAgICAgIHRoaXMuYnVmZmVyW2lfMV0uZ2V0Q29sb3IoKVsncmVkJ10gPSAwLjA7XG4gICAgICAgICAgICAgICAgdGhpcy5idWZmZXJbaV8xXS5nZXRDb2xvcigpWydncmVlbiddID0gMC4wO1xuICAgICAgICAgICAgICAgIHRoaXMuYnVmZmVyW2lfMV0uZ2V0Q29sb3IoKVsnYmx1ZSddID0gMC4wO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2VsZi5wb3N0TWVzc2FnZShidWZmZXIpO1xuICAgICAgICB9XG4gICAgfTtcbiAgICBUcmFjZXIucHJvdG90eXBlLnNldFNjZW5lID0gZnVuY3Rpb24gKHNjZW5lKSB7XG4gICAgICAgIHRoaXMuc2NlbmUgPSBzY2VuZTtcbiAgICB9O1xuICAgIHJldHVybiBUcmFjZXI7XG59KSgpO1xub25tZXNzYWdlID0gZnVuY3Rpb24gKG1lc3NhZ2UpIHtcbiAgICB2YXIgZGF0YSA9IG1lc3NhZ2UuZGF0YTtcbiAgICBpZiAodHlwZW9mIChkYXRhKSA9PSAnc3RyaW5nJykge1xuICAgICAgICBkYXRhID0gSlNPTi5wYXJzZSgnWycgKyBkYXRhICsgJ10nKTtcbiAgICB9XG4gICAgdmFyIHRyYWNlciA9IG5ldyBUcmFjZXIoKTtcbiAgICB0cmFjZXIuc2V0U2NlbmUobmV3IFNjZW5lXzEuU2NlbmUoe1xuICAgICAgICBjYW1lcmE6IG5ldyBDYW1lcmFfMS5DYW1lcmEobmV3IFZlY3Rvcl8xLlZlY3RvcigwLCAwLCAtNjk5KSwgbmV3IFZlY3Rvcl8xLlZlY3RvcigwLCAwLCAxKSwgZGF0YVswXSwgZGF0YVsxXSksXG4gICAgICAgIG9iamVjdHM6IFtcbiAgICAgICAgICAgIC8qbmV3IFNwaGVyZShuZXcgVmVjdG9yKDAsIDYzMCwgMCksIDE1MClcbiAgICAgICAgICAgICAgICAuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKENvbG9yLmdyYXksIG5ldyBDb2xvcihuZXcgRmxvYXRDb2xvcigxMDAwMCwgMTAwMDAsIDEwMDAwKSkpKSwqL1xuICAgICAgICAgICAgbmV3IFBvbHlnb25fMS5Qb2x5Z29uKG5ldyBWZWN0b3JfMS5WZWN0b3IoLTcwMCwgNzAwLCAtNzAwKSwgbmV3IFZlY3Rvcl8xLlZlY3Rvcig3MDAsIDcwMCwgLTcwMCksIG5ldyBWZWN0b3JfMS5WZWN0b3IoLTcwMCwgNzAwLCA3MDApKS5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWxfMS5NYXRlcmlhbChuZXcgQ29sb3JfMS5Db2xvcihuZXcgUkdCQ29sb3JfMS5SR0JDb2xvcigwLjc1ICogMjU1LCAwLjc1ICogMjU1LCAwLjc1ICogMjU1KSkpLnNldExhbWJlcnRDb2VmZigxKSksXG4gICAgICAgICAgICBuZXcgUGxhbmVfMS5QbGFuZShuZXcgVmVjdG9yXzEuVmVjdG9yKDAsIC0xLCAwKSwgbmV3IFZlY3Rvcl8xLlZlY3RvcigwLCA3MDAsIDApKVxuICAgICAgICAgICAgICAgIC5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWxfMS5NYXRlcmlhbChuZXcgQ29sb3JfMS5Db2xvcihuZXcgUkdCQ29sb3JfMS5SR0JDb2xvcigyMTUsIDIxNSwgMjE1KSksIG5ldyBDb2xvcl8xLkNvbG9yKG5ldyBGbG9hdENvbG9yXzEuRmxvYXRDb2xvcigzMCwgMzAsIDMwKSkpKSxcbiAgICAgICAgICAgIG5ldyBQbGFuZV8xLlBsYW5lKG5ldyBWZWN0b3JfMS5WZWN0b3IoLTEsIDAsIDApLCBuZXcgVmVjdG9yXzEuVmVjdG9yKDcwMCwgMCwgMCkpLnNldE1hdGVyaWFsKG5ldyBNYXRlcmlhbF8xLk1hdGVyaWFsKG5ldyBDb2xvcl8xLkNvbG9yKG5ldyBSR0JDb2xvcl8xLlJHQkNvbG9yKDAuMyAqIDI1NSwgMjU1LCAwLjEgKiAyNTUpKSkuc2V0TGFtYmVydENvZWZmKDEpKSxcbiAgICAgICAgICAgIG5ldyBQbGFuZV8xLlBsYW5lKG5ldyBWZWN0b3JfMS5WZWN0b3IoMSwgMCwgMCksIG5ldyBWZWN0b3JfMS5WZWN0b3IoLTcwMCwgMCwgMCkpLnNldE1hdGVyaWFsKG5ldyBNYXRlcmlhbF8xLk1hdGVyaWFsKG5ldyBDb2xvcl8xLkNvbG9yKG5ldyBSR0JDb2xvcl8xLlJHQkNvbG9yKDI1NSwgMC4zICogMjU1LCAwLjEgKiAyNTUpKSkuc2V0TGFtYmVydENvZWZmKDEpKSxcbiAgICAgICAgICAgIG5ldyBQbGFuZV8xLlBsYW5lKG5ldyBWZWN0b3JfMS5WZWN0b3IoMCwgMCwgLTEpLCBuZXcgVmVjdG9yXzEuVmVjdG9yKDAsIDAsIDcwMCkpLnNldE1hdGVyaWFsKG5ldyBNYXRlcmlhbF8xLk1hdGVyaWFsKG5ldyBDb2xvcl8xLkNvbG9yKG5ldyBSR0JDb2xvcl8xLlJHQkNvbG9yKDAuNzUgKiAyNTUsIDAuNzUgKiAyNTUsIDAuNzUgKiAyNTUpKSkuc2V0TGFtYmVydENvZWZmKDEpKSxcbiAgICAgICAgICAgIG5ldyBQbGFuZV8xLlBsYW5lKG5ldyBWZWN0b3JfMS5WZWN0b3IoMCwgMCwgMSksIG5ldyBWZWN0b3JfMS5WZWN0b3IoMCwgMCwgLTcwMCkpLnNldE1hdGVyaWFsKG5ldyBNYXRlcmlhbF8xLk1hdGVyaWFsKENvbG9yXzEuQ29sb3IuYmxhY2spLnNldExhbWJlcnRDb2VmZigxKSksXG4gICAgICAgICAgICAvLyBib3R0b20gcGxhbmVcbiAgICAgICAgICAgIC8qbmV3IFNwaGVyZShuZXcgVmVjdG9yKC0yNTAsIC01MDAsIDQ1MCksIDIwMClcbiAgICAgICAgICAgICAgICAuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKENvbG9yLmJsYWNrLCAxKSksKi9cbiAgICAgICAgICAgIG5ldyBTcGhlcmVfMS5TcGhlcmUobmV3IFZlY3Rvcl8xLlZlY3RvcigwLCAtMzAwLCA0MDApLCA0MDApXG4gICAgICAgICAgICAgICAgLnNldE1hdGVyaWFsKG5ldyBNYXRlcmlhbF8xLk1hdGVyaWFsKENvbG9yXzEuQ29sb3IuZ3JheSkpXG4gICAgICAgIF1cbiAgICB9KSk7XG4gICAgdHJhY2VyLnJlbmRlcihkYXRhWzBdLCBkYXRhWzFdKTtcbn07XG4iLCIvLy8gPHJlZmVyZW5jZSBuby1kZWZhdWx0LWxpYj1cInRydWVcIi8+XG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwibGliL2xpYi53ZWJ3b3JrZXIuZC50c1wiIC8+XG5cbmltcG9ydCB7IEFic3RyYWN0TGlnaHQgfSBmcm9tIFwiLi9MaWdodHMvQWJzdHJhY3RMaWdodFwiO1xuaW1wb3J0IHsgQWJzdHJhY3RPYmplY3QgfSBmcm9tIFwiLi9PYmplY3RzL0Fic3RyYWN0T2JqZWN0XCI7XG5pbXBvcnQgeyBDYW1lcmEgfSBmcm9tIFwiLi9DYW1lcmFcIjtcbmltcG9ydCB7IENvbG9yIH0gZnJvbSBcIi4vQ29sb3IvQ29sb3JcIjtcbmltcG9ydCB7IEludGVyc2VjdFBvaW50IH0gZnJvbSBcIi4vSW50ZXJzZWN0UG9pbnRcIjtcbmltcG9ydCB7IE1hdGVyaWFsIH0gZnJvbSBcIi4vTWF0ZXJpYWxcIjtcbmltcG9ydCB7IFBsYW5lIH0gZnJvbSBcIi4vT2JqZWN0cy9QbGFuZVwiO1xuaW1wb3J0IHsgUG9seWdvbiB9IGZyb20gXCIuL09iamVjdHMvUG9seWdvblwiO1xuaW1wb3J0IHsgUmF5IH0gZnJvbSBcIi4vUmF5XCI7XG5pbXBvcnQgeyBSR0JDb2xvciB9IGZyb20gXCIuL0NvbG9yL1JHQkNvbG9yXCI7XG5pbXBvcnQgeyBSVE1hdGggfSBmcm9tIFwiLi9SVE1hdGhcIjtcbmltcG9ydCB7IFNjZW5lIH0gZnJvbSBcIi4vU2NlbmVcIjtcbmltcG9ydCB7IFNwaGVyZSB9IGZyb20gXCIuL09iamVjdHMvU3BoZXJlXCI7XG5pbXBvcnQgeyBTcGhlcmljYWxMaWdodCB9IGZyb20gXCIuL0xpZ2h0cy9TcGhlcmljYWxMaWdodFwiO1xuaW1wb3J0IHsgVmVjdG9yIH0gZnJvbSBcIi4vVmVjdG9yXCI7XG5pbXBvcnQge0Zsb2F0Q29sb3J9IGZyb20gXCIuL0NvbG9yL0Zsb2F0Q29sb3JcIjtcblxuY2xhc3MgVHJhY2VyIHtcbiAgICBwcml2YXRlIGJ1ZmZlcjogQ29sb3JbXSA9IFtdO1xuICAgIHByaXZhdGUgc2NlbmU6IFNjZW5lO1xuICAgIHByaXZhdGUgc2NyZWVuV2lkdGg6IG51bWJlciA9IDI1MDtcbiAgICBwcml2YXRlIHNjcmVlbkhlaWdodDogbnVtYmVyID0gMjUwO1xuXG4gICAgY29uc3RydWN0b3IgKCkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc2NyZWVuV2lkdGggKiB0aGlzLnNjcmVlbkhlaWdodCAqIDM7IGkrKykge1xuICAgICAgICAgICAgdGhpcy5idWZmZXIucHVzaChDb2xvci5ibGFjayk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGNvc2luZVNhbXBsZUhlbWlzcGhlcmUgKG5vcm1hbDogVmVjdG9yKTogVmVjdG9yIHtcbiAgICAgICAgbGV0IHU6IG51bWJlciA9IE1hdGgucmFuZG9tKCksXG4gICAgICAgICAgICB2OiBudW1iZXIgPSBNYXRoLnJhbmRvbSgpLFxuICAgICAgICAgICAgcjogbnVtYmVyID0gTWF0aC5zcXJ0KHUpLFxuICAgICAgICAgICAgYW5nbGU6IG51bWJlciA9IDIgKiBNYXRoLlBJICogdixcbiAgICAgICAgICAgIHNkaXI6IFZlY3RvcixcbiAgICAgICAgICAgIHRkaXI6IFZlY3RvcjtcblxuICAgICAgICBpZiAoTWF0aC5hYnMobm9ybWFsLmdldENvb3JkaW5hdGVzKClbJ3gnXSkgPCAwLjUpIHtcbiAgICAgICAgICAgIHNkaXIgPSBWZWN0b3IuY3Jvc3Mobm9ybWFsLCBuZXcgVmVjdG9yKDEsMCwwKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzZGlyID0gVmVjdG9yLmNyb3NzKG5vcm1hbCwgbmV3IFZlY3RvcigwLDEsMCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGRpciA9IFZlY3Rvci5jcm9zcyhub3JtYWwsIHNkaXIpO1xuXG4gICAgICAgIHJldHVybiBWZWN0b3IuYWRkKFxuICAgICAgICAgICAgVmVjdG9yLnNjYWxlKG5vcm1hbCwgIE1hdGguc3FydCgxIC0gdSkpLFxuICAgICAgICAgICAgVmVjdG9yLmFkZChcbiAgICAgICAgICAgICAgICBWZWN0b3Iuc2NhbGUoc2RpciwgciAqIE1hdGguY29zKGFuZ2xlKSksXG4gICAgICAgICAgICAgICAgVmVjdG9yLnNjYWxlKHRkaXIsIHIgKiBNYXRoLnNpbihhbmdsZSkpXG4gICAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRDb2xvciAocmF5OiBSYXkpOiBDb2xvciB7XG4gICAgICAgIGxldCBjb2xvcjogQ29sb3IgPSBDb2xvci5ibGFjayxcbiAgICAgICAgICAgIGNvc3Q6IG51bWJlcixcbiAgICAgICAgICAgIGludGVyc2VjdGlvbiA9IHRoaXMudHJhY2UocmF5KSxcbiAgICAgICAgICAgIGxpZ2h0U2FtcGxpbmdDb2xvcjogQ29sb3IsXG4gICAgICAgICAgICBuZXdEaXJlY3Rpb246IFZlY3RvcixcbiAgICAgICAgICAgIG5ld1BvaW50OiBWZWN0b3IsXG4gICAgICAgICAgICByYW5kRmFjdG9yID0gMSxcbiAgICAgICAgICAgIHJheUl0ZXJhdGlvbjogbnVtYmVyID0gcmF5LmdldEl0ZXJhdGlvbigpLFxuICAgICAgICAgICAgdGVtcENvbG9yOiBDb2xvcjtcblxuICAgICAgICBpZiAocmF5SXRlcmF0aW9uID49IDUpIHtcbiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpIDw9IDAuMSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBDb2xvci5ibGFjaztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmFuZEZhY3RvciA9IDEgLyAoMSAtIDAuMSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWludGVyc2VjdGlvbi5nZXRJbnRlcnNlY3QoKSkge1xuICAgICAgICAgICAgcmV0dXJuIENvbG9yLmJsYWNrO1xuICAgICAgICB9XG5cbiAgICAgICAgbGlnaHRTYW1wbGluZ0NvbG9yID0gQ29sb3IuYmxhY2s7XG5cbiAgICAgICAgZm9yIChsZXQgbGlnaHQgb2YgdGhpcy5zY2VuZS5nZXRPYmplY3RzKCkpIHtcbiAgICAgICAgICAgIGlmIChsaWdodC5nZXRNYXRlcmlhbCgpLmdldEVtaXNzaW9uKCkgPT0gQ29sb3IuYmxhY2spIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbGlnaHRTYW1wbGluZ0NvbG9yID0gbGlnaHRTYW1wbGluZ0NvbG9yXG4gICAgICAgICAgICAgICAgLmFkZCh0aGlzLmdldExpZ2h0UG93ZXIocmF5LCBpbnRlcnNlY3Rpb24sIGxpZ2h0KSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb2xvciA9IGxpZ2h0U2FtcGxpbmdDb2xvci5zY2FsZWQocmF5LmdldEl0ZXJhdGlvbigpKS5hZGQoXG4gICAgICAgICAgICBpbnRlcnNlY3Rpb25cbiAgICAgICAgICAgICAgICAuZ2V0T3duZXIoKVxuICAgICAgICAgICAgICAgIC5nZXRNYXRlcmlhbCgpXG4gICAgICAgICAgICAgICAgLmdldENvbG9yKClcbiAgICAgICAgICAgICAgICAubXVsdGlwbGUoXG4gICAgICAgICAgICAgICAgICAgIGludGVyc2VjdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgLmdldE93bmVyKClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRNYXRlcmlhbCgpXG4gICAgICAgICAgICAgICAgICAgICAgICAuZ2V0RW1pc3Npb24oKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnNjYWxlZChyYW5kRmFjdG9yKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgKTtcblxuICAgICAgICBuZXdEaXJlY3Rpb24gPSB0aGlzLmNvc2luZVNhbXBsZUhlbWlzcGhlcmUoaW50ZXJzZWN0aW9uLmdldE5vcm1hbCgpKTtcblxuICAgICAgICBpZiAoVmVjdG9yLmRvdChuZXdEaXJlY3Rpb24sIHJheS5nZXREaXJlY3Rpb24oKSkgPiAwKSB7XG4gICAgICAgICAgICBuZXdQb2ludCA9IFZlY3Rvci5hZGQoXG4gICAgICAgICAgICAgICAgcmF5LmdldE9yaWdpbigpLFxuICAgICAgICAgICAgICAgIFZlY3Rvci5zY2FsZShcbiAgICAgICAgICAgICAgICAgICAgcmF5LmdldERpcmVjdGlvbigpLFxuICAgICAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb24uZ2V0RGlzdGFuY2VGcm9tT3JpZ2luKCkgKiAoMSArIFJUTWF0aC5FUFNJTE9OKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBuZXdQb2ludCA9IFZlY3Rvci5hZGQoXG4gICAgICAgICAgICAgICAgcmF5LmdldE9yaWdpbigpLFxuICAgICAgICAgICAgICAgIFZlY3Rvci5zY2FsZShcbiAgICAgICAgICAgICAgICAgICAgcmF5LmdldERpcmVjdGlvbigpLFxuICAgICAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb24uZ2V0RGlzdGFuY2VGcm9tT3JpZ2luKCkgKiAoMSAtIFJUTWF0aC5FUFNJTE9OKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBjb3N0ID0gVmVjdG9yLmRvdChuZXdEaXJlY3Rpb24sIGludGVyc2VjdGlvbi5nZXROb3JtYWwoKSk7XG4gICAgICAgIHRlbXBDb2xvciA9IHRoaXMuZ2V0Q29sb3IoXG4gICAgICAgICAgICBuZXcgUmF5KFxuICAgICAgICAgICAgICAgIG5ld1BvaW50LFxuICAgICAgICAgICAgICAgIG5ld0RpcmVjdGlvbixcbiAgICAgICAgICAgICAgICArK3JheUl0ZXJhdGlvblxuICAgICAgICAgICAgKVxuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiBjb2xvci5hZGQoXG4gICAgICAgICAgICB0ZW1wQ29sb3JcbiAgICAgICAgICAgICAgICAubXVsdGlwbGUoXG4gICAgICAgICAgICAgICAgICAgIGludGVyc2VjdGlvblxuICAgICAgICAgICAgICAgICAgICAgICAgLmdldE93bmVyKClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRNYXRlcmlhbCgpXG4gICAgICAgICAgICAgICAgICAgICAgICAuZ2V0Q29sb3IoKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAuc2NhbGVkKGNvc3QpXG4gICAgICAgICAgICAgICAgLnNjYWxlZCgwLjEpXG4gICAgICAgICAgICAgICAgLnNjYWxlZChyYW5kRmFjdG9yKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0UmVmbGVjdGlvbkNvbG9yIChyYXk6IFJheSwgaW50ZXJzZWN0OiBhbnkpOiBhbnkge1xuICAgICAgICBsZXQgcmVmbGVjdGlvbkNvbG9yOiBDb2xvcixcbiAgICAgICAgICAgIHJlZmxlY3Rpb25WYWx1ZTogbnVtYmVyID0gaW50ZXJzZWN0LmdldE93bmVyKCkuZ2V0TWF0ZXJpYWwoKS5nZXRSZWZsZWN0aW9uVmFsdWUoKSxcbiAgICAgICAgICAgIHJlZmxlY3RlZFJheTogVmVjdG9yO1xuXG4gICAgICAgIGlmIChyZWZsZWN0aW9uVmFsdWUgPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBDb2xvci5ibGFjaztcbiAgICAgICAgfVxuXG4gICAgICAgIHJlZmxlY3RlZFJheSA9IFZlY3Rvci5yZWZsZWN0KFxuICAgICAgICAgICAgcmF5LmdldERpcmVjdGlvbigpLFxuICAgICAgICAgICAgaW50ZXJzZWN0LmdldE5vcm1hbCgpXG4gICAgICAgICk7XG5cbiAgICAgICAgcmVmbGVjdGlvbkNvbG9yID0gdGhpcy5nZXRDb2xvcihcbiAgICAgICAgICAgIG5ldyBSYXkoaW50ZXJzZWN0LmdldEhpdFBvaW50KCksIHJlZmxlY3RlZFJheSwgcmF5LmdldEl0ZXJhdGlvbigpKVxuICAgICAgICApLnNjYWxlZChyZWZsZWN0aW9uVmFsdWUpO1xuXG4gICAgICAgIHJldHVybiByZWZsZWN0aW9uQ29sb3I7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRQZXJzcGVjdGl2ZVZlY3RvciAoeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcbiAgICAgICAgbGV0IGNhbWVyYTogQ2FtZXJhID0gdGhpcy5zY2VuZS5nZXRDYW1lcmEoKTtcblxuICAgICAgICByZXR1cm4gVmVjdG9yLm5vcm1hbGl6ZShcbiAgICAgICAgICAgIFZlY3Rvci5hZGQoXG4gICAgICAgICAgICAgICAgY2FtZXJhLmdldEZvcndhcmRWZWN0b3IoKSxcbiAgICAgICAgICAgICAgICBWZWN0b3IuYWRkKFxuICAgICAgICAgICAgICAgICAgICBWZWN0b3Iuc2NhbGUoXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW1lcmEuZ2V0UmlnaHRWZWN0b3IoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbWVyYS5yZWNlbnRlclgoeClcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgVmVjdG9yLnNjYWxlKFxuICAgICAgICAgICAgICAgICAgICAgICAgY2FtZXJhLmdldFVwVmVjdG9yKCksXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW1lcmEucmVjZW50ZXJZKHkpXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRMaWdodFBvd2VyIChyYXk6IFJheSwgaW50ZXJzZWN0OiBhbnksIG9iamVjdDogQWJzdHJhY3RPYmplY3QpOiBhbnkge1xuICAgICAgICBsZXQgbCA9IG9iamVjdC5nZXRSYW5kb21Qb2ludCgpO1xuXG4gICAgICAgIGxldCBzaGFkb3dSYXkgPSB0aGlzLnRyYWNlKFxuICAgICAgICAgICAgbmV3IFJheShcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3QuZ2V0SGl0UG9pbnQoKSxcbiAgICAgICAgICAgICAgICBWZWN0b3Iuc3Vic3RyYWN0KFxuICAgICAgICAgICAgICAgICAgICBWZWN0b3Iuc3Vic3RyYWN0KFxuICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0LmdldFBvc2l0aW9uKCksXG4gICAgICAgICAgICAgICAgICAgICAgICBsXG4gICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgIGludGVyc2VjdC5nZXRIaXRQb2ludCgpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIHNoYWRvd1JheS5nZXRJbnRlcnNlY3QoKSAmJlxuICAgICAgICAgICAgc2hhZG93UmF5LmdldE93bmVyKCkuZ2V0TWF0ZXJpYWwoKS5nZXRFbWlzc2lvblZhbHVlKCkgPiAwXG4gICAgICAgICkge1xuICAgICAgICAgICAgcmV0dXJuIGludGVyc2VjdFxuICAgICAgICAgICAgICAgIC5nZXRPd25lcigpXG4gICAgICAgICAgICAgICAgLmdldE1hdGVyaWFsKClcbiAgICAgICAgICAgICAgICAuZ2V0Q29sb3IoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBDb2xvci5ibGFjaztcbiAgICAgICAgfVxuXG4gICAgICAgIC8qbGV0IGxpZ2h0UG93ZXIgPSBvYmplY3QuZ2V0TWF0ZXJpYWwoKS5nZXRFbWlzc2lvbigpLFxuICAgICAgICAgICAgbGlnaHRSYW5kb21Qb2ludDogVmVjdG9yLFxuICAgICAgICAgICAgc2hhZG93UmF5OiBJbnRlcnNlY3RQb2ludCxcbiAgICAgICAgICAgIHJlc3VsdFBvd2VyOiBudW1iZXIgPSAwO1xuXG4gICAgICAgIGxpZ2h0UmFuZG9tUG9pbnQgPSBvYmplY3QuZ2V0UmFuZG9tUG9pbnQoKTtcblxuICAgICAgICBzaGFkb3dSYXkgPSB0aGlzLnRyYWNlKFxuICAgICAgICAgICAgbmV3IFJheShcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3QuZ2V0SGl0UG9pbnQoKSxcbiAgICAgICAgICAgICAgICBWZWN0b3Iuc3Vic3RyYWN0KFxuICAgICAgICAgICAgICAgICAgICBWZWN0b3Iuc3Vic3RyYWN0KFxuICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0LmdldFBvc2l0aW9uKCksXG4gICAgICAgICAgICAgICAgICAgICAgICBsaWdodFJhbmRvbVBvaW50XG4gICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgIGludGVyc2VjdC5nZXRIaXRQb2ludCgpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIHNoYWRvd1JheS5nZXRJbnRlcnNlY3QoKSAmJlxuICAgICAgICAgICAgc2hhZG93UmF5LmdldE93bmVyKCkuZ2V0TWF0ZXJpYWwoKS5nZXRFbWlzc2lvblZhbHVlKCkgPiAwXG4gICAgICAgICkge1xuICAgICAgICAgICAgcmVzdWx0UG93ZXIgPSAxO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdFBvd2VyO1xuXG4gICAgICAgIC8qbGlnaHRSYW5kb21Qb2ludCA9IHRoaXMuY29zaW5lU2FtcGxlSGVtaXNwaGVyZShcbiAgICAgICAgICAgIGludGVyc2VjdC5nZXRPd25lcigpLmdldE5vcm1hbChpbnRlcnNlY3QuZ2V0SGl0UG9pbnQoKSlcbiAgICAgICAgKTtcblxuICAgICAgICBzaGFkb3dSYXkgPSB0aGlzLnRyYWNlKFxuICAgICAgICAgICAgbmV3IFJheShcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3QuZ2V0SGl0UG9pbnQoKSxcbiAgICAgICAgICAgICAgICBsaWdodFJhbmRvbVBvaW50XG4gICAgICAgICAgICApXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgc2hhZG93UmF5LmdldEludGVyc2VjdCgpICYmXG4gICAgICAgICAgICBzaGFkb3dSYXkuZ2V0T3duZXIoKSBpbnN0YW5jZW9mIEFic3RyYWN0TGlnaHRcbiAgICAgICAgKSB7XG4gICAgICAgICAgICByZXN1bHRQb3dlciA9IChcbiAgICAgICAgICAgICAgICAoXG4gICAgICAgICAgICAgICAgICAgIFZlY3Rvci5zdWJzdHJhY3QoXG4gICAgICAgICAgICAgICAgICAgICAgICBWZWN0b3Iuc3Vic3RyYWN0KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0LmdldFBvc2l0aW9uKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHRSYW5kb21Qb2ludFxuICAgICAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGludGVyc2VjdC5nZXRIaXRQb2ludCgpXG4gICAgICAgICAgICAgICAgICAgICkuZ2V0TGVuZ3RoKCkgKiAobGlnaHRQb3dlciAvIGxpZ2h0LmdldEZhZGVSYWRpdXMoKSlcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBpZiAocmVzdWx0UG93ZXIgPCAwKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0UG93ZXIgPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICB9Ki9cblxuICAgICAgICAvKnJldHVybiByZXN1bHRQb3dlcjsqL1xuICAgIH1cblxuICAgIHByaXZhdGUgdHJhY2UgKHJheTogUmF5KTogSW50ZXJzZWN0UG9pbnQge1xuICAgICAgICBsZXQgaW50ZXJzZWN0aW9uID0gbmV3IEludGVyc2VjdFBvaW50KCksXG4gICAgICAgICAgICBpbnRlcnNlY3REYXRhOiBhbnksXG4gICAgICAgICAgICBtaW5EaXN0YW5jZTogbnVtYmVyID0gSW5maW5pdHksXG4gICAgICAgICAgICBzY2VuZU9iamVjdHM6IEFic3RyYWN0T2JqZWN0W10gPSB0aGlzLnNjZW5lLmdldE9iamVjdHMoKTtcblxuICAgICAgICBmb3IgKGxldCBvYmplY3Qgb2Ygc2NlbmVPYmplY3RzKSB7XG4gICAgICAgICAgICBpbnRlcnNlY3REYXRhID0gb2JqZWN0LmdldEludGVyc2VjdERhdGEocmF5KTtcblxuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIGludGVyc2VjdERhdGEgJiZcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3REYXRhWydkaXN0YW5jZSddIDwgbWluRGlzdGFuY2VcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIG1pbkRpc3RhbmNlID0gaW50ZXJzZWN0RGF0YVsnZGlzdGFuY2UnXTtcblxuICAgICAgICAgICAgICAgIGludGVyc2VjdGlvbi5zZXRJbnRlcnNlY3QoKTtcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb24uc2V0SGl0UG9pbnQoaW50ZXJzZWN0RGF0YVsnaGl0UG9pbnQnXSk7XG4gICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uLnNldE5vcm1hbChpbnRlcnNlY3REYXRhWydub3JtYWwnXSk7XG4gICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uLnNldERpc3RhbmNlRnJvbU9yaWdpbihpbnRlcnNlY3REYXRhWydkaXN0YW5jZSddKTtcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb24uc2V0T3duZXIob2JqZWN0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBpbnRlcnNlY3Rpb247XG4gICAgfVxuXG4gICAgcHVibGljIHJlbmRlciAoc2NyZWVuV2lkdGg6IG51bWJlciwgc2NyZWVuSGVpZ2h0OiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgcmFuZG9NdWx0aXBsaWVyID0gMC41LFxuICAgICAgICAgICAgICBzcHAgPSAxO1xuXG4gICAgICAgIGxldCBidWZmZXI6IG51bWJlcltdLFxuICAgICAgICAgICAgY29sb3I6IENvbG9yLFxuICAgICAgICAgICAgcmFuZDogbnVtYmVyLFxuICAgICAgICAgICAgcmF5OiBSYXk7XG5cbiAgICAgICAgdGhpcy5zY3JlZW5XaWR0aCA9IHNjcmVlbldpZHRoO1xuICAgICAgICB0aGlzLnNjcmVlbkhlaWdodCA9IHNjcmVlbkhlaWdodDtcblxuICAgICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAgICAgYnVmZmVyID0gW107XG5cbiAgICAgICAgICAgIGxldCBpID0gMDtcblxuICAgICAgICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCB0aGlzLnNjcmVlbkhlaWdodDsgeSsrKSB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0aGlzLnNjcmVlbldpZHRoOyB4KyspIHtcbiAgICAgICAgICAgICAgICAgICAgY29sb3IgPSBDb2xvci5ibGFjaztcblxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpdGVyYXRpb24gPSAwOyBpdGVyYXRpb24gPCBzcHA7IGl0ZXJhdGlvbisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByYW5kID0gMDtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGgucmFuZG9tKCkgPiAwLjUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5kICs9IE1hdGgucmFuZG9tKCkgKiByYW5kb011bHRpcGxpZXI7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmQgLT0gTWF0aC5yYW5kb20oKSAqIHJhbmRvTXVsdGlwbGllcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgcmF5ID0gbmV3IFJheShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNjZW5lLmdldENhbWVyYSgpLmdldFBvc2l0aW9uKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRQZXJzcGVjdGl2ZVZlY3Rvcih4ICsgcmFuZCwgeSArIHJhbmQpXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xvciA9IGNvbG9yLmFkZCh0aGlzLmdldENvbG9yKHJheSkpXG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB0aGlzLmJ1ZmZlcltpXSA9IGNvbG9yLmRpdmlkZShzcHApO1xuXG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGNvbXBvbmVudCBpbiB0aGlzLmJ1ZmZlcltpXS5nZXRDb2xvcigpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJ1ZmZlcltpXVtjb21wb25lbnRdID0gQ29sb3Iuc1JHQkVuY29kZSh0aGlzLmJ1ZmZlcltpXVtjb21wb25lbnRdKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKHRoaXMuYnVmZmVyW2ldLmdldENvbG9yKClbJ3JlZCddKTtcbiAgICAgICAgICAgICAgICAgICAgYnVmZmVyLnB1c2godGhpcy5idWZmZXJbaV0uZ2V0Q29sb3IoKVsnZ3JlZW4nXSk7XG4gICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKHRoaXMuYnVmZmVyW2ldLmdldENvbG9yKClbJ2JsdWUnXSk7XG5cbiAgICAgICAgICAgICAgICAgICAgaSsrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZm9yKGxldCAgaSA9IDA7IGkgPCB0aGlzLmJ1ZmZlci5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHRoaXMuYnVmZmVyW2ldLmdldENvbG9yKClbJ3JlZCddID0gMC4wO1xuICAgICAgICAgICAgICAgIHRoaXMuYnVmZmVyW2ldLmdldENvbG9yKClbJ2dyZWVuJ10gPSAwLjA7XG4gICAgICAgICAgICAgICAgdGhpcy5idWZmZXJbaV0uZ2V0Q29sb3IoKVsnYmx1ZSddID0gMC4wO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZWxmLnBvc3RNZXNzYWdlKGJ1ZmZlcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0U2NlbmUgKHNjZW5lOiBTY2VuZSk6IHZvaWQge1xuICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7XG4gICAgfVxufVxuXG5vbm1lc3NhZ2UgPSBmdW5jdGlvbiAobWVzc2FnZSkge1xuICAgIHZhciBkYXRhID0gbWVzc2FnZS5kYXRhO1xuXG4gICAgaWYgKHR5cGVvZihkYXRhKSA9PSAnc3RyaW5nJykge1xuICAgICAgICBkYXRhID0gSlNPTi5wYXJzZSgnWycrZGF0YSsnXScpO1xuICAgIH1cblxuICAgIGxldCB0cmFjZXIgPSBuZXcgVHJhY2VyKCk7XG5cbiAgICB0cmFjZXIuc2V0U2NlbmUoXG4gICAgICAgIG5ldyBTY2VuZSh7XG4gICAgICAgICAgICBjYW1lcmE6IG5ldyBDYW1lcmEoXG4gICAgICAgICAgICAgICAgbmV3IFZlY3RvcigwLCAwLCAtNjk5KSxcbiAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKDAsIDAsIDEpLFxuICAgICAgICAgICAgICAgIGRhdGFbMF0sXG4gICAgICAgICAgICAgICAgZGF0YVsxXVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIG9iamVjdHM6IFtcbiAgICAgICAgICAgICAgICAvKm5ldyBTcGhlcmUobmV3IFZlY3RvcigwLCA2MzAsIDApLCAxNTApXG4gICAgICAgICAgICAgICAgICAgIC5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWwoQ29sb3IuZ3JheSwgbmV3IENvbG9yKG5ldyBGbG9hdENvbG9yKDEwMDAwLCAxMDAwMCwgMTAwMDApKSkpLCovXG4gICAgICAgICAgICAgICAgbmV3IFBvbHlnb24oXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoLTcwMCwgNzAwLCAtNzAwKSxcbiAgICAgICAgICAgICAgICAgICAgbmV3IFZlY3Rvcig3MDAsIDcwMCwgLTcwMCksXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoLTcwMCwgNzAwLCA3MDApXG4gICAgICAgICAgICAgICAgKS5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWwobmV3IENvbG9yKG5ldyBSR0JDb2xvcigwLjc1ICogMjU1LCAwLjc1ICogMjU1LCAwLjc1ICogMjU1KSkpLnNldExhbWJlcnRDb2VmZigxKSksXG4gICAgICAgICAgICAgICAgbmV3IFBsYW5lKG5ldyBWZWN0b3IoMCwgLTEsIDApLCBuZXcgVmVjdG9yICgwLCA3MDAsIDApKVxuICAgICAgICAgICAgICAgICAgICAuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKG5ldyBDb2xvcihuZXcgUkdCQ29sb3IoMjE1LCAyMTUsIDIxNSkpLCBuZXcgQ29sb3IobmV3IEZsb2F0Q29sb3IoMzAsIDMwLCAzMCkpKSksXG4gICAgICAgICAgICAgICAgbmV3IFBsYW5lKG5ldyBWZWN0b3IoLTEsIDAsIDApLCBuZXcgVmVjdG9yICg3MDAsIDAsIDApKS5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWwobmV3IENvbG9yKG5ldyBSR0JDb2xvcigwLjMgKiAyNTUsIDI1NSwgMC4xICogMjU1KSkpLnNldExhbWJlcnRDb2VmZigxKSksXG4gICAgICAgICAgICAgICAgbmV3IFBsYW5lKG5ldyBWZWN0b3IoMSwgMCwgMCksIG5ldyBWZWN0b3IgKC03MDAsIDAsIDApKS5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWwobmV3IENvbG9yKG5ldyBSR0JDb2xvcigyNTUsIDAuMyAqIDI1NSwgMC4xICogMjU1KSkpLnNldExhbWJlcnRDb2VmZigxKSksXG4gICAgICAgICAgICAgICAgbmV3IFBsYW5lKG5ldyBWZWN0b3IoMCwgMCwgLTEpLCBuZXcgVmVjdG9yICgwLCAwLCA3MDApKS5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWwobmV3IENvbG9yKG5ldyBSR0JDb2xvcigwLjc1ICogMjU1LCAwLjc1ICogMjU1LCAwLjc1ICogMjU1KSkpLnNldExhbWJlcnRDb2VmZigxKSksXG4gICAgICAgICAgICAgICAgbmV3IFBsYW5lKG5ldyBWZWN0b3IoMCwgMCwgMSksIG5ldyBWZWN0b3IgKDAsIDAsIC03MDApKS5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWwoQ29sb3IuYmxhY2spLnNldExhbWJlcnRDb2VmZigxKSksXG4gICAgICAgICAgICAgICAgLy8gYm90dG9tIHBsYW5lXG4gICAgICAgICAgICAgICAgLypuZXcgU3BoZXJlKG5ldyBWZWN0b3IoLTI1MCwgLTUwMCwgNDUwKSwgMjAwKVxuICAgICAgICAgICAgICAgICAgICAuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKENvbG9yLmJsYWNrLCAxKSksKi9cbiAgICAgICAgICAgICAgICBuZXcgU3BoZXJlKG5ldyBWZWN0b3IoMCwgLTMwMCwgNDAwKSwgNDAwKVxuICAgICAgICAgICAgICAgICAgICAuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKENvbG9yLmdyYXkpKVxuICAgICAgICAgICAgXVxuICAgICAgICB9KVxuICAgICk7XG5cbiAgICB0cmFjZXIucmVuZGVyKGRhdGFbMF0sIGRhdGFbMV0pO1xufTsiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
