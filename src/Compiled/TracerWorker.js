var Camera_1=require("./Camera"),Color_1=require("./Color/Color"),IntersectPoint_1=require("./IntersectPoint"),Material_1=require("./Material"),Plane_1=require("./Objects/Plane"),Ray_1=require("./Ray"),RGBColor_1=require("./Color/RGBColor"),Scene_1=require("./Scene"),Sphere_1=require("./Objects/Sphere"),Vector_1=require("./Vector"),FloatColor_1=require("./Color/FloatColor"),Tracer=function(){function e(){this.buffer=[],this.screenWidth=250,this.screenHeight=250;for(var e=0;e<this.screenWidth*this.screenHeight*3;e++)this.buffer.push(Color_1.Color.black)}return e.prototype.cosineSampleHemisphere=function(e){var t,r,o=Math.random(),a=Math.random(),n=Math.sqrt(o),c=2*Math.PI*a;return t=Math.abs(e.getCoordinates().x)<.5?Vector_1.Vector.cross(e,new Vector_1.Vector(1,0,0)):Vector_1.Vector.cross(e,new Vector_1.Vector(0,1,0)),r=Vector_1.Vector.cross(e,t),Vector_1.Vector.add(Vector_1.Vector.scale(e,Math.sqrt(1-o)),Vector_1.Vector.add(Vector_1.Vector.scale(t,n*Math.cos(c)),Vector_1.Vector.scale(r,n*Math.sin(c))))},e.prototype.getColor=function(e){var t=this.trace(e),r=Color_1.Color.black,o=Color_1.Color.black,a=e.getIteration();return e.setIteration(--a),0===a?Color_1.Color.black:t.getIntersect()?(r=this.getDiffuseColor(e,t),o=this.getReflectionColor(e,t),r.add(o)):Color_1.Color.black},e.prototype.getDiffuseColor=function(e,t,r){void 0===r&&(r=!0);for(var o,a=Color_1.Color.black,n=(Color_1.Color.black,0),c=this.scene.getObjects();n<c.length;n++){var i=c[n];0!==i.getMaterial().getEmissionValue()}o=0===t.getOwner().getMaterial().getEmissionValue()?0:.9;var l=a.add(t.getOwner().getMaterial().getColor().add(t.getOwner().getMaterial().getEmission()));return Math.random()<o?l:this.getColor(new Ray_1.Ray(t.getHitPoint(),this.cosineSampleHemisphere(t.getOwner().getNormal(t.getHitPoint())),e.getIteration())).multiple(l)},e.prototype.getReflectionColor=function(e,t){var r,o,a=t.getOwner().getMaterial().getReflectionValue();return 0===a?Color_1.Color.black:(o=Vector_1.Vector.reflect(e.getDirection(),t.getNormal()),r=this.getColor(new Ray_1.Ray(t.getHitPoint(),o,e.getIteration())).scaled(a))},e.prototype.getPerspectiveVector=function(e,t){var r=this.scene.getCamera();return Vector_1.Vector.normalize(Vector_1.Vector.add(r.getForwardVector(),Vector_1.Vector.add(Vector_1.Vector.scale(r.getRightVector(),r.recenterX(e)),Vector_1.Vector.scale(r.getUpVector(),r.recenterY(t)))))},e.prototype.getLightPower=function(e,t,r){var o=r.getRandomPoint(),a=Math.sqrt(1-Math.pow(r.getRadius(),2)/Vector_1.Vector.dot(Vector_1.Vector.substract(t.getHitPoint(),r.getPosition()),Vector_1.Vector.substract(t.getHitPoint(),r.getPosition()))),n=this.trace(new Ray_1.Ray(t.getHitPoint(),Vector_1.Vector.substract(Vector_1.Vector.substract(r.getPosition(),o),t.getHitPoint())));if(n.getIntersect()&&n.getOwner().getMaterial().getEmissionValue()>0){var c=2*Math.PI*(1-a),i=Vector_1.Vector.dot(t.getNormal(),e.getDirection())<0?t.getNormal():Vector_1.Vector.scale(t.getNormal(),-1);return t.getOwner().getMaterial().getColor().add(r.getMaterial().getEmission().scaled(Vector_1.Vector.dot(o,i)).scaled(c)).scaled(1/Math.PI)}return Color_1.Color.black},e.prototype.trace=function(e){for(var t,r=new IntersectPoint_1.IntersectPoint,o=1/0,a=this.scene.getObjects(),n=0,c=a;n<c.length;n++){var i=c[n];t=i.getIntersectData(e),t&&t.distance<o&&(o=t.distance,r.setIntersect(),r.setHitPoint(t.hitPoint),r.setNormal(t.normal),r.setDistanceFromOrigin(t.distance),r.setOwner(i))}return r},e.prototype.render=function(e,t){var r,o,a,n=.5;for(this.screenWidth=e,this.screenHeight=t;;){r=[];for(var c=0;1>c;c++)for(var i=0,l=0;l<this.screenHeight;l++)for(var s=0;s<this.screenWidth;s++){o=0,Math.random()>.5?o+=Math.random()*n:o-=Math.random()*n,a=new Ray_1.Ray(this.scene.getCamera().getPosition(),this.getPerspectiveVector(s+o,l+o)),this.buffer[i]=Color_1.Color.black.add(this.getColor(a));for(var _ in this.buffer[i].getColor())this.buffer[i][_]=Color_1.Color.sRGBEncode(this.buffer[i][_]);r.push(this.buffer[i].getColor().red),r.push(this.buffer[i].getColor().green),r.push(this.buffer[i].getColor().blue),i++}for(var i=0;i<this.buffer.length;i++)this.buffer[i].getColor().red=0,this.buffer[i].getColor().green=0,this.buffer[i].getColor().blue=0;self.postMessage(r)}},e.prototype.setScene=function(e){this.scene=e},e}();onmessage=function(e){var t=e.data;"string"==typeof t&&(t=JSON.parse("["+t+"]"));var r=new Tracer;r.setScene(new Scene_1.Scene({camera:new Camera_1.Camera(new Vector_1.Vector(0,0,-699),new Vector_1.Vector(0,0,1),t[0],t[1]),objects:[new Sphere_1.Sphere(new Vector_1.Vector(0,630,0),60).setMaterial(new Material_1.Material(Color_1.Color.gray,new Color_1.Color(new FloatColor_1.FloatColor(400,400,400)))),new Plane_1.Plane(new Vector_1.Vector(0,1,0),new Vector_1.Vector(0,-700,0)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(191.25,191.25,191.25))).setLambertCoeff(1)),new Plane_1.Plane(new Vector_1.Vector(0,-1,0),new Vector_1.Vector(0,700,0)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(191.25,191.25,191.25))).setLambertCoeff(1)),new Plane_1.Plane(new Vector_1.Vector(-1,0,0),new Vector_1.Vector(700,0,0)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(76.5,255,25.5))).setLambertCoeff(1)),new Plane_1.Plane(new Vector_1.Vector(1,0,0),new Vector_1.Vector(-700,0,0)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(255,76.5,25.5))).setLambertCoeff(1)),new Plane_1.Plane(new Vector_1.Vector(0,0,-1),new Vector_1.Vector(0,0,700)).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(191.25,191.25,191.25))).setLambertCoeff(1)),new Plane_1.Plane(new Vector_1.Vector(0,0,1),new Vector_1.Vector(0,0,-700)).setMaterial(new Material_1.Material(Color_1.Color.black).setLambertCoeff(1)),new Sphere_1.Sphere(new Vector_1.Vector(0,-300,400),400).setMaterial(new Material_1.Material(Color_1.Color.gray))]})),r.render(t[0],t[1])};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlRyYWNlcldvcmtlci50cyJdLCJuYW1lcyI6WyJDYW1lcmFfMSIsInJlcXVpcmUiLCJDb2xvcl8xIiwiSW50ZXJzZWN0UG9pbnRfMSIsIk1hdGVyaWFsXzEiLCJQbGFuZV8xIiwiUmF5XzEiLCJSR0JDb2xvcl8xIiwiU2NlbmVfMSIsIlNwaGVyZV8xIiwiVmVjdG9yXzEiLCJGbG9hdENvbG9yXzEiLCJUcmFjZXIiLCJUcmFjZXIuY29uc3RydWN0b3IiLCJUcmFjZXIuY29zaW5lU2FtcGxlSGVtaXNwaGVyZSIsIlRyYWNlci5nZXRDb2xvciIsIlRyYWNlci5nZXREaWZmdXNlQ29sb3IiLCJUcmFjZXIuZ2V0UmVmbGVjdGlvbkNvbG9yIiwiVHJhY2VyLmdldFBlcnNwZWN0aXZlVmVjdG9yIiwiVHJhY2VyLmdldExpZ2h0UG93ZXIiLCJUcmFjZXIudHJhY2UiLCJUcmFjZXIucmVuZGVyIiwiVHJhY2VyLnNldFNjZW5lIiwib25tZXNzYWdlIiwibWVzc2FnZSIsImRhdGEiLCJKU09OIiwicGFyc2UiLCJ0cmFjZXIiLCJzZXRTY2VuZSIsIlNjZW5lIiwiY2FtZXJhIiwiQ2FtZXJhIiwiVmVjdG9yIiwib2JqZWN0cyIsIlNwaGVyZSIsInNldE1hdGVyaWFsIiwiTWF0ZXJpYWwiLCJDb2xvciIsImdyYXkiLCJGbG9hdENvbG9yIiwiUGxhbmUiLCJSR0JDb2xvciIsInNldExhbWJlcnRDb2VmZiIsImJsYWNrIiwicmVuZGVyIl0sIm1hcHBpbmdzIjoiQUFLQSxHQUFBQSxVQUFBQyxRQUF1QixZQUN2QkMsUUFBQUQsUUFBc0IsaUJBQ3RCRSxpQkFBQUYsUUFBK0Isb0JBQy9CRyxXQUFBSCxRQUF5QixjQUN6QkksUUFBQUosUUFBc0IsbUJBRXRCSyxNQUFBTCxRQUFvQixTQUNwQk0sV0FBQU4sUUFBeUIsb0JBRXpCTyxRQUFBUCxRQUFzQixXQUN0QlEsU0FBQVIsUUFBdUIsb0JBRXZCUyxTQUFBVCxRQUF1QixZQUN2QlUsYUFBQVYsUUFBeUIsc0JBRXpCVyxPQUFBLFdBTUlBLFFBQUFBLEtBTFFDLEtBQUFBLFVBRUFBLEtBQUFBLFlBQXNCQSxJQUN0QkEsS0FBQUEsYUFBdUJBLEdBRzNCQSxLQUFLQSxHQUFJQSxHQUFJQSxFQUFHQSxFQUFJQSxLQUFLQSxZQUFjQSxLQUFLQSxhQUFlQSxFQUFHQSxJQUMxREEsS0FBS0EsT0FBT0EsS0FBS0EsUUFBQUEsTUFBTUEsT0EyVW5DRCxNQXZVWUEsR0FBQUEsVUFBQUEsdUJBQVJBLFNBQWdDQSxHQUM1QkUsR0FLSUEsR0FDQUEsRUFOQUEsRUFBSUEsS0FBS0EsU0FDVEEsRUFBSUEsS0FBS0EsU0FDVEEsRUFBSUEsS0FBS0EsS0FBS0EsR0FDZEEsRUFBUUEsRUFBSUEsS0FBS0EsR0FBS0EsQ0FhMUJBLE9BUElBLEdBREFBLEtBQUtBLElBQUlBLEVBQU9BLGlCQUFvQkEsR0FBS0EsR0FDbENBLFNBQUFBLE9BQU9BLE1BQU1BLEVBQVFBLEdBQUlBLFVBQUFBLE9BQU9BLEVBQUVBLEVBQUVBLElBRXBDQSxTQUFBQSxPQUFPQSxNQUFNQSxFQUFRQSxHQUFJQSxVQUFBQSxPQUFPQSxFQUFFQSxFQUFFQSxJQUcvQ0EsRUFBT0EsU0FBQUEsT0FBT0EsTUFBTUEsRUFBUUEsR0FFckJBLFNBQUFBLE9BQU9BLElBQ1ZBLFNBQUFBLE9BQU9BLE1BQU1BLEVBQVNBLEtBQUtBLEtBQUtBLEVBQUlBLElBQ3BDQSxTQUFBQSxPQUFPQSxJQUNIQSxTQUFBQSxPQUFPQSxNQUFNQSxFQUFNQSxFQUFJQSxLQUFLQSxJQUFJQSxJQUNoQ0EsU0FBQUEsT0FBT0EsTUFBTUEsRUFBTUEsRUFBSUEsS0FBS0EsSUFBSUEsT0FLcENGLEVBQUFBLFVBQUFBLFNBQVJBLFNBQWtCQSxHQUNkRyxHQUFJQSxHQUFlQSxLQUFLQSxNQUFNQSxHQUMxQkEsRUFBc0JBLFFBQUFBLE1BQU1BLE1BQzVCQSxFQUFzQkEsUUFBQUEsTUFBTUEsTUFDNUJBLEVBQXVCQSxFQUFJQSxjQUkvQkEsT0FGQUEsR0FBSUEsZUFBZUEsR0FFRUEsSUFBakJBLEVBQ09BLFFBQUFBLE1BQU1BLE1BR1pBLEVBQWFBLGdCQUlsQkEsRUFBZUEsS0FBS0EsZ0JBQWdCQSxFQUFLQSxHQUN6Q0EsRUFBZUEsS0FBS0EsbUJBQW1CQSxFQUFLQSxHQUVyQ0EsRUFBYUEsSUFBSUEsSUFOYkEsUUFBQUEsTUFBTUEsT0FTYkgsRUFBQUEsVUFBQUEsZ0JBQVJBLFNBQXlCQSxFQUFVQSxFQUFnQkEsR0FBQUksU0FBQUEsSUFBQUEsR0FBQUEsRUFNL0NBLEtBQWtCQSxHQUxkQSxHQUVBQSxFQUFZQSxRQUFBQSxNQUFNQSxNQUdKQSxHQUZEQSxRQUFBQSxNQUFNQSxNQUVMQSxHQUFBQSxFQUFBQSxLQUFLQSxNQUFNQSxhQUF4QkEsRUFBQUEsRUFBQUEsT0FBQUEsSUFBcUNBLENBQXJDQSxHQUFJQSxHQUFLQSxFQUFBQSxFQUNxQ0EsS0FBM0NBLEVBQU1BLGNBQWNBLG1CQVV4QkEsRUFGMERBLElBQTFEQSxFQUFVQSxXQUFXQSxjQUFjQSxtQkFFL0JBLEVBRUFBLEVBR1JBLElBQUlBLEdBQVFBLEVBQVVBLElBQUlBLEVBQVVBLFdBQVdBLGNBQWNBLFdBQVdBLElBQUlBLEVBQVVBLFdBQVdBLGNBQWNBLGVBRS9HQSxPQUFJQSxNQUFLQSxTQUFXQSxFQUNUQSxFQUdKQSxLQUFLQSxTQUNSQSxHQUFJQSxPQUFBQSxJQUNBQSxFQUFVQSxjQUNWQSxLQUFLQSx1QkFDREEsRUFBVUEsV0FBV0EsVUFBVUEsRUFBVUEsZ0JBRTdDQSxFQUFJQSxpQkFFVkEsU0FBU0EsSUFHUEosRUFBQUEsVUFBQUEsbUJBQVJBLFNBQTRCQSxFQUFVQSxHQUNsQ0ssR0FBSUEsR0FFQUEsRUFEQUEsRUFBMEJBLEVBQVVBLFdBQVdBLGNBQWNBLG9CQUdqRUEsT0FBd0JBLEtBQXBCQSxFQUNPQSxRQUFBQSxNQUFNQSxPQUdqQkEsRUFBZUEsU0FBQUEsT0FBT0EsUUFDbEJBLEVBQUlBLGVBQ0pBLEVBQVVBLGFBR2RBLEVBQWtCQSxLQUFLQSxTQUNuQkEsR0FBSUEsT0FBQUEsSUFBSUEsRUFBVUEsY0FBZUEsRUFBY0EsRUFBSUEsaUJBQ3JEQSxPQUFPQSxLQUtMTCxFQUFBQSxVQUFBQSxxQkFBUkEsU0FBOEJBLEVBQVdBLEdBQ3JDTSxHQUFJQSxHQUFpQkEsS0FBS0EsTUFBTUEsV0FFaENBLE9BQU9BLFVBQUFBLE9BQU9BLFVBQ1ZBLFNBQUFBLE9BQU9BLElBQ0hBLEVBQU9BLG1CQUNQQSxTQUFBQSxPQUFPQSxJQUNIQSxTQUFBQSxPQUFPQSxNQUNIQSxFQUFPQSxpQkFDUEEsRUFBT0EsVUFBVUEsSUFFckJBLFNBQUFBLE9BQU9BLE1BQ0hBLEVBQU9BLGNBQ1BBLEVBQU9BLFVBQVVBLFFBTzdCTixFQUFBQSxVQUFBQSxjQUFSQSxTQUF1QkEsRUFBVUEsRUFBZ0JBLEdBQzdDTyxHQUFJQSxHQUFJQSxFQUFPQSxpQkFFWEEsRUFBWUEsS0FBS0EsS0FDakJBLEVBQUlBLEtBQUFBLElBQUFBLEVBQU9BLFlBQWVBLEdBQUlBLFNBQUFBLE9BQU9BLElBQUlBLFNBQUFBLE9BQU9BLFVBQVVBLEVBQVVBLGNBQWVBLEVBQU9BLGVBQWdCQSxTQUFBQSxPQUFPQSxVQUFVQSxFQUFVQSxjQUFlQSxFQUFPQSxpQkFHM0pBLEVBQVlBLEtBQUtBLE1BQ2pCQSxHQUFJQSxPQUFBQSxJQUNBQSxFQUFVQSxjQUNWQSxTQUFBQSxPQUFPQSxVQUNIQSxTQUFBQSxPQUFPQSxVQUNIQSxFQUFPQSxjQUNQQSxHQUVKQSxFQUFVQSxnQkFLdEJBLElBQ0lBLEVBQVVBLGdCQUNWQSxFQUFVQSxXQUFXQSxjQUFjQSxtQkFBcUJBLEVBQzFEQSxDQUNFQSxHQUFJQSxHQUFRQSxFQUFJQSxLQUFLQSxJQUFNQSxFQUFJQSxHQUUzQkEsRUFBS0EsU0FBQUEsT0FBT0EsSUFBSUEsRUFBVUEsWUFBYUEsRUFBSUEsZ0JBQWtCQSxFQUFJQSxFQUFVQSxZQUFjQSxTQUFBQSxPQUFPQSxNQUFNQSxFQUFVQSxZQUFhQSxHQUVqSUEsT0FBT0EsR0FDRkEsV0FDQUEsY0FDQUEsV0FDQUEsSUFDR0EsRUFDS0EsY0FDQUEsY0FDQUEsT0FDR0EsU0FBQUEsT0FBT0EsSUFDSEEsRUFDQUEsSUFHUEEsT0FBT0EsSUFFZkEsT0FBT0EsRUFBSUEsS0FBS0EsSUFFckJBLE1BQU9BLFNBQUFBLE1BQU1BLE9BbUViUCxFQUFBQSxVQUFBQSxNQUFSQSxTQUFlQSxHQU1YUSxJQUFtQkEsR0FKZkEsR0FEQUEsRUFBZUEsR0FBSUEsa0JBQUFBLGVBRW5CQSxFQUFzQkEsRUFBQUEsRUFDdEJBLEVBQWlDQSxLQUFLQSxNQUFNQSxhQUU3QkEsRUFBQUEsRUFBQUEsRUFBQUEsRUFBZEEsRUFBQUEsRUFBQUEsT0FBQUEsSUFBMkJBLENBQTNCQSxHQUFJQSxHQUFNQSxFQUFBQSxFQUNYQSxHQUFnQkEsRUFBT0EsaUJBQWlCQSxHQUdwQ0EsR0FDQUEsRUFBd0JBLFNBQUlBLElBRTVCQSxFQUFjQSxFQUF3QkEsU0FFdENBLEVBQWFBLGVBQ2JBLEVBQWFBLFlBQVlBLEVBQXdCQSxVQUNqREEsRUFBYUEsVUFBVUEsRUFBc0JBLFFBQzdDQSxFQUFhQSxzQkFBc0JBLEVBQXdCQSxVQUMzREEsRUFBYUEsU0FBU0EsSUFJOUJBLE1BQU9BLElBR0pSLEVBQUFBLFVBQUFBLE9BQVBBLFNBQWVBLEVBQXFCQSxHQUNoQ1MsR0FFSUEsR0FFQUEsRUFDQUEsRUFMRUEsRUFBa0JBLEVBVXhCQSxLQUhBQSxLQUFLQSxZQUFjQSxFQUNuQkEsS0FBS0EsYUFBZUEsSUFFUEEsQ0FDVEEsSUFFQUEsS0FBS0EsR0FBSUEsR0FBWUEsRUFBZUEsRUFBWkEsRUFBZUEsSUFHbkNBLElBQUtBLEdBRkRBLEdBQUlBLEVBRUNBLEVBQUlBLEVBQUdBLEVBQUlBLEtBQUtBLGFBQWNBLElBQ25DQSxJQUFLQSxHQUFJQSxHQUFJQSxFQUFHQSxFQUFJQSxLQUFLQSxZQUFhQSxJQUFLQSxDQUN2Q0EsRUFBT0EsRUFFSEEsS0FBS0EsU0FBV0EsR0FDaEJBLEdBQVFBLEtBQUtBLFNBQVdBLEVBRXhCQSxHQUFRQSxLQUFLQSxTQUFXQSxFQUc1QkEsRUFBTUEsR0FBSUEsT0FBQUEsSUFDTkEsS0FBS0EsTUFBTUEsWUFBWUEsY0FDdkJBLEtBQUtBLHFCQUFxQkEsRUFBSUEsRUFBTUEsRUFBSUEsSUFHNUNBLEtBQUtBLE9BQU9BLEdBQUtBLFFBQUFBLE1BQU1BLE1BQU1BLElBQUlBLEtBQUtBLFNBQVNBLEdBRS9DQSxLQUFLQSxHQUFJQSxLQUFhQSxNQUFLQSxPQUFPQSxHQUFHQSxXQUNqQ0EsS0FBS0EsT0FBT0EsR0FBR0EsR0FBYUEsUUFBQUEsTUFBTUEsV0FBV0EsS0FBS0EsT0FBT0EsR0FBR0EsR0FHaEVBLEdBQU9BLEtBQUtBLEtBQUtBLE9BQU9BLEdBQUdBLFdBQWdCQSxLQUMzQ0EsRUFBT0EsS0FBS0EsS0FBS0EsT0FBT0EsR0FBR0EsV0FBa0JBLE9BQzdDQSxFQUFPQSxLQUFLQSxLQUFLQSxPQUFPQSxHQUFHQSxXQUFpQkEsTUFFNUNBLElBS1pBLElBQUlBLEdBQUtBLEdBQUlBLEVBQUdBLEVBQUlBLEtBQUtBLE9BQU9BLE9BQVFBLElBQ3BDQSxLQUFLQSxPQUFPQSxHQUFHQSxXQUFnQkEsSUFBSUEsRUFDbkNBLEtBQUtBLE9BQU9BLEdBQUdBLFdBQWtCQSxNQUFJQSxFQUNyQ0EsS0FBS0EsT0FBT0EsR0FBR0EsV0FBaUJBLEtBQUlBLENBR3hDQSxNQUFLQSxZQUFZQSxLQUlsQlQsRUFBQUEsVUFBQUEsU0FBUEEsU0FBaUJBLEdBQ2JVLEtBQUtBLE1BQVFBLEdBRXJCVixJQUVBVyxXQUFZLFNBQVVDLEdBQ2xCLEdBQUlDLEdBQU9ELEVBQVFDLElBRUMsaUJBQVYsS0FDTkEsRUFBT0MsS0FBS0MsTUFBTSxJQUFJRixFQUFLLEtBRy9CLElBQUlHLEdBQVMsR0FBSWhCLE9BRWpCZ0IsR0FBT0MsU0FDSCxHQUFJckIsU0FBQXNCLE9BQ0FDLE9BQVEsR0FBSS9CLFVBQUFnQyxPQUNSLEdBQUl0QixVQUFBdUIsT0FBTyxFQUFHLEVBQUcsTUFDakIsR0FBSXZCLFVBQUF1QixPQUFPLEVBQUcsRUFBRyxHQUNqQlIsRUFBSyxHQUNMQSxFQUFLLElBRVRTLFNBQ0ksR0FBSXpCLFVBQUEwQixPQUFPLEdBQUl6QixVQUFBdUIsT0FBTyxFQUFHLElBQUssR0FBSSxJQUM3QkcsWUFBWSxHQUFJaEMsWUFBQWlDLFNBQVNuQyxRQUFBb0MsTUFBTUMsS0FBTSxHQUFJckMsU0FBQW9DLE1BQU0sR0FBSTNCLGNBQUE2QixXQUFXLElBQUssSUFBSyxRQUM3RSxHQUFJbkMsU0FBQW9DLE1BQU0sR0FBSS9CLFVBQUF1QixPQUFPLEVBQUcsRUFBRyxHQUFJLEdBQUl2QixVQUFBdUIsT0FBUSxFQUFHLEtBQU0sSUFBSUcsWUFBWSxHQUFJaEMsWUFBQWlDLFNBQVMsR0FBSW5DLFNBQUFvQyxNQUFNLEdBQUkvQixZQUFBbUMsU0FBUyxPQUFZLE9BQVksVUFBY0MsZ0JBQWdCLElBQzlKLEdBQUl0QyxTQUFBb0MsTUFBTSxHQUFJL0IsVUFBQXVCLE9BQU8sRUFBRyxHQUFJLEdBQUksR0FBSXZCLFVBQUF1QixPQUFRLEVBQUcsSUFBSyxJQUFJRyxZQUFZLEdBQUloQyxZQUFBaUMsU0FBUyxHQUFJbkMsU0FBQW9DLE1BQU0sR0FBSS9CLFlBQUFtQyxTQUFTLE9BQVksT0FBWSxVQUFjQyxnQkFBZ0IsSUFDOUosR0FBSXRDLFNBQUFvQyxNQUFNLEdBQUkvQixVQUFBdUIsT0FBTyxHQUFJLEVBQUcsR0FBSSxHQUFJdkIsVUFBQXVCLE9BQVEsSUFBSyxFQUFHLElBQUlHLFlBQVksR0FBSWhDLFlBQUFpQyxTQUFTLEdBQUluQyxTQUFBb0MsTUFBTSxHQUFJL0IsWUFBQW1DLFNBQVMsS0FBVyxJQUFLLFFBQWFDLGdCQUFnQixJQUNySixHQUFJdEMsU0FBQW9DLE1BQU0sR0FBSS9CLFVBQUF1QixPQUFPLEVBQUcsRUFBRyxHQUFJLEdBQUl2QixVQUFBdUIsT0FBUSxLQUFNLEVBQUcsSUFBSUcsWUFBWSxHQUFJaEMsWUFBQWlDLFNBQVMsR0FBSW5DLFNBQUFvQyxNQUFNLEdBQUkvQixZQUFBbUMsU0FBUyxJQUFLLEtBQVcsUUFBYUMsZ0JBQWdCLElBQ3JKLEdBQUl0QyxTQUFBb0MsTUFBTSxHQUFJL0IsVUFBQXVCLE9BQU8sRUFBRyxFQUFHLElBQUssR0FBSXZCLFVBQUF1QixPQUFRLEVBQUcsRUFBRyxNQUFNRyxZQUFZLEdBQUloQyxZQUFBaUMsU0FBUyxHQUFJbkMsU0FBQW9DLE1BQU0sR0FBSS9CLFlBQUFtQyxTQUFTLE9BQVksT0FBWSxVQUFjQyxnQkFBZ0IsSUFDOUosR0FBSXRDLFNBQUFvQyxNQUFNLEdBQUkvQixVQUFBdUIsT0FBTyxFQUFHLEVBQUcsR0FBSSxHQUFJdkIsVUFBQXVCLE9BQVEsRUFBRyxFQUFHLE9BQU9HLFlBQVksR0FBSWhDLFlBQUFpQyxTQUFTbkMsUUFBQW9DLE1BQU1NLE9BQU9ELGdCQUFnQixJQUk5RyxHQUFJbEMsVUFBQTBCLE9BQU8sR0FBSXpCLFVBQUF1QixPQUFPLEVBQUcsS0FBTSxLQUFNLEtBQ2hDRyxZQUFZLEdBQUloQyxZQUFBaUMsU0FBU25DLFFBQUFvQyxNQUFNQyxXQUtoRFgsRUFBT2lCLE9BQU9wQixFQUFLLEdBQUlBLEVBQUsiLCJmaWxlIjoiVHJhY2VyV29ya2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2Ugbm8tZGVmYXVsdC1saWI9XCJ0cnVlXCIvPlxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cImxpYi9saWIud2Vid29ya2VyLmQudHNcIiAvPlxuXG5pbXBvcnQgeyBBYnN0cmFjdExpZ2h0IH0gZnJvbSBcIi4vTGlnaHRzL0Fic3RyYWN0TGlnaHRcIjtcbmltcG9ydCB7IEFic3RyYWN0T2JqZWN0IH0gZnJvbSBcIi4vT2JqZWN0cy9BYnN0cmFjdE9iamVjdFwiO1xuaW1wb3J0IHsgQ2FtZXJhIH0gZnJvbSBcIi4vQ2FtZXJhXCI7XG5pbXBvcnQgeyBDb2xvciB9IGZyb20gXCIuL0NvbG9yL0NvbG9yXCI7XG5pbXBvcnQgeyBJbnRlcnNlY3RQb2ludCB9IGZyb20gXCIuL0ludGVyc2VjdFBvaW50XCI7XG5pbXBvcnQgeyBNYXRlcmlhbCB9IGZyb20gXCIuL01hdGVyaWFsXCI7XG5pbXBvcnQgeyBQbGFuZSB9IGZyb20gXCIuL09iamVjdHMvUGxhbmVcIjtcbmltcG9ydCB7IFBvbHlnb24gfSBmcm9tIFwiLi9PYmplY3RzL1BvbHlnb25cIjtcbmltcG9ydCB7IFJheSB9IGZyb20gXCIuL1JheVwiO1xuaW1wb3J0IHsgUkdCQ29sb3IgfSBmcm9tIFwiLi9Db2xvci9SR0JDb2xvclwiO1xuaW1wb3J0IHsgUlRNYXRoIH0gZnJvbSBcIi4vUlRNYXRoXCI7XG5pbXBvcnQgeyBTY2VuZSB9IGZyb20gXCIuL1NjZW5lXCI7XG5pbXBvcnQgeyBTcGhlcmUgfSBmcm9tIFwiLi9PYmplY3RzL1NwaGVyZVwiO1xuaW1wb3J0IHsgU3BoZXJpY2FsTGlnaHQgfSBmcm9tIFwiLi9MaWdodHMvU3BoZXJpY2FsTGlnaHRcIjtcbmltcG9ydCB7IFZlY3RvciB9IGZyb20gXCIuL1ZlY3RvclwiO1xuaW1wb3J0IHtGbG9hdENvbG9yfSBmcm9tIFwiLi9Db2xvci9GbG9hdENvbG9yXCI7XG5cbmNsYXNzIFRyYWNlciB7XG4gICAgcHJpdmF0ZSBidWZmZXI6IENvbG9yW10gPSBbXTtcbiAgICBwcml2YXRlIHNjZW5lOiBTY2VuZTtcbiAgICBwcml2YXRlIHNjcmVlbldpZHRoOiBudW1iZXIgPSAyNTA7XG4gICAgcHJpdmF0ZSBzY3JlZW5IZWlnaHQ6IG51bWJlciA9IDI1MDtcblxuICAgIGNvbnN0cnVjdG9yICgpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnNjcmVlbldpZHRoICogdGhpcy5zY3JlZW5IZWlnaHQgKiAzOyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMuYnVmZmVyLnB1c2goQ29sb3IuYmxhY2spO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjb3NpbmVTYW1wbGVIZW1pc3BoZXJlIChub3JtYWw6IFZlY3Rvcik6IFZlY3RvciB7XG4gICAgICAgIGxldCB1ID0gTWF0aC5yYW5kb20oKTtcbiAgICAgICAgbGV0IHYgPSBNYXRoLnJhbmRvbSgpO1xuICAgICAgICBsZXQgciA9IE1hdGguc3FydCh1KTtcbiAgICAgICAgbGV0IGFuZ2xlID0gMiAqIE1hdGguUEkgKiB2O1xuXG4gICAgICAgIGxldCBzZGlyLFxuICAgICAgICAgICAgdGRpcjtcblxuICAgICAgICBpZiAoTWF0aC5hYnMobm9ybWFsLmdldENvb3JkaW5hdGVzKClbJ3gnXSkgPCAwLjUpIHtcbiAgICAgICAgICAgIHNkaXIgPSBWZWN0b3IuY3Jvc3Mobm9ybWFsLCBuZXcgVmVjdG9yKDEsMCwwKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzZGlyID0gVmVjdG9yLmNyb3NzKG5vcm1hbCwgbmV3IFZlY3RvcigwLDEsMCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGRpciA9IFZlY3Rvci5jcm9zcyhub3JtYWwsIHNkaXIpO1xuXG4gICAgICAgIHJldHVybiBWZWN0b3IuYWRkKFxuICAgICAgICAgICAgVmVjdG9yLnNjYWxlKG5vcm1hbCwgIE1hdGguc3FydCgxIC0gdSkpLFxuICAgICAgICAgICAgVmVjdG9yLmFkZChcbiAgICAgICAgICAgICAgICBWZWN0b3Iuc2NhbGUoc2RpciwgciAqIE1hdGguY29zKGFuZ2xlKSksXG4gICAgICAgICAgICAgICAgVmVjdG9yLnNjYWxlKHRkaXIsIHIgKiBNYXRoLnNpbihhbmdsZSkpXG4gICAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRDb2xvciAocmF5OiBSYXkpOiBDb2xvciB7XG4gICAgICAgIGxldCBpbnRlcnNlY3Rpb24gPSB0aGlzLnRyYWNlKHJheSksXG4gICAgICAgICAgICBkaWZmdXNlQ29sb3I6IENvbG9yID0gQ29sb3IuYmxhY2ssXG4gICAgICAgICAgICByZWZsZWN0Q29sb3I6IENvbG9yID0gQ29sb3IuYmxhY2ssXG4gICAgICAgICAgICByYXlJdGVyYXRpb246IG51bWJlciA9IHJheS5nZXRJdGVyYXRpb24oKTtcblxuICAgICAgICByYXkuc2V0SXRlcmF0aW9uKC0tcmF5SXRlcmF0aW9uKTtcblxuICAgICAgICBpZiAocmF5SXRlcmF0aW9uID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gQ29sb3IuYmxhY2s7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWludGVyc2VjdGlvbi5nZXRJbnRlcnNlY3QoKSkge1xuICAgICAgICAgICAgcmV0dXJuIENvbG9yLmJsYWNrO1xuICAgICAgICB9XG5cbiAgICAgICAgZGlmZnVzZUNvbG9yID0gdGhpcy5nZXREaWZmdXNlQ29sb3IocmF5LCBpbnRlcnNlY3Rpb24pO1xuICAgICAgICByZWZsZWN0Q29sb3IgPSB0aGlzLmdldFJlZmxlY3Rpb25Db2xvcihyYXksIGludGVyc2VjdGlvbik7XG5cbiAgICAgICAgcmV0dXJuIGRpZmZ1c2VDb2xvci5hZGQocmVmbGVjdENvbG9yKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldERpZmZ1c2VDb2xvciAocmF5OiBSYXksIGludGVyc2VjdDogYW55LCByZWN1cnNpdmU6IGJvb2xlYW4gPSB0cnVlKTogQ29sb3Ige1xuICAgICAgICBsZXQgcDogbnVtYmVyO1xuXG4gICAgICAgIGxldCBsYW1iQ29sb3IgPSBDb2xvci5ibGFjaztcbiAgICAgICAgbGV0IHBob25nQ29sb3IgPSBDb2xvci5ibGFjaztcblxuICAgICAgICBmb3IgKGxldCBsaWdodCBvZiB0aGlzLnNjZW5lLmdldE9iamVjdHMoKSkge1xuICAgICAgICAgICAgaWYgKGxpZ2h0LmdldE1hdGVyaWFsKCkuZ2V0RW1pc3Npb25WYWx1ZSgpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vbGFtYkNvbG9yID0gbGFtYkNvbG9yLmFkZCh0aGlzLmdldExpZ2h0UG93ZXIocmF5LCBpbnRlcnNlY3QsIGxpZ2h0KSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoXG4gICAgICAgICAgICBpbnRlcnNlY3QuZ2V0T3duZXIoKS5nZXRNYXRlcmlhbCgpLmdldEVtaXNzaW9uVmFsdWUoKSA9PT0gMFxuICAgICAgICApIHtcbiAgICAgICAgICAgIHAgPSAwO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcCA9IDAuOTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjb2xvciA9IGxhbWJDb2xvci5hZGQoaW50ZXJzZWN0LmdldE93bmVyKCkuZ2V0TWF0ZXJpYWwoKS5nZXRDb2xvcigpLmFkZChpbnRlcnNlY3QuZ2V0T3duZXIoKS5nZXRNYXRlcmlhbCgpLmdldEVtaXNzaW9uKCkpKTtcblxuICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA8IHApIHtcbiAgICAgICAgICAgIHJldHVybiBjb2xvcjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmdldENvbG9yKFxuICAgICAgICAgICAgbmV3IFJheShcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3QuZ2V0SGl0UG9pbnQoKSxcbiAgICAgICAgICAgICAgICB0aGlzLmNvc2luZVNhbXBsZUhlbWlzcGhlcmUoXG4gICAgICAgICAgICAgICAgICAgIGludGVyc2VjdC5nZXRPd25lcigpLmdldE5vcm1hbChpbnRlcnNlY3QuZ2V0SGl0UG9pbnQoKSlcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHJheS5nZXRJdGVyYXRpb24oKVxuICAgICAgICAgICAgKVxuICAgICAgICApLm11bHRpcGxlKGNvbG9yKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFJlZmxlY3Rpb25Db2xvciAocmF5OiBSYXksIGludGVyc2VjdDogYW55KTogYW55IHtcbiAgICAgICAgbGV0IHJlZmxlY3Rpb25Db2xvcjogQ29sb3IsXG4gICAgICAgICAgICByZWZsZWN0aW9uVmFsdWU6IG51bWJlciA9IGludGVyc2VjdC5nZXRPd25lcigpLmdldE1hdGVyaWFsKCkuZ2V0UmVmbGVjdGlvblZhbHVlKCksXG4gICAgICAgICAgICByZWZsZWN0ZWRSYXk6IFZlY3RvcjtcblxuICAgICAgICBpZiAocmVmbGVjdGlvblZhbHVlID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gQ29sb3IuYmxhY2s7XG4gICAgICAgIH1cblxuICAgICAgICByZWZsZWN0ZWRSYXkgPSBWZWN0b3IucmVmbGVjdChcbiAgICAgICAgICAgIHJheS5nZXREaXJlY3Rpb24oKSxcbiAgICAgICAgICAgIGludGVyc2VjdC5nZXROb3JtYWwoKVxuICAgICAgICApO1xuXG4gICAgICAgIHJlZmxlY3Rpb25Db2xvciA9IHRoaXMuZ2V0Q29sb3IoXG4gICAgICAgICAgICBuZXcgUmF5KGludGVyc2VjdC5nZXRIaXRQb2ludCgpLCByZWZsZWN0ZWRSYXksIHJheS5nZXRJdGVyYXRpb24oKSlcbiAgICAgICAgKS5zY2FsZWQocmVmbGVjdGlvblZhbHVlKTtcblxuICAgICAgICByZXR1cm4gcmVmbGVjdGlvbkNvbG9yO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0UGVyc3BlY3RpdmVWZWN0b3IgKHg6IG51bWJlciwgeTogbnVtYmVyKSB7XG4gICAgICAgIGxldCBjYW1lcmE6IENhbWVyYSA9IHRoaXMuc2NlbmUuZ2V0Q2FtZXJhKCk7XG5cbiAgICAgICAgcmV0dXJuIFZlY3Rvci5ub3JtYWxpemUoXG4gICAgICAgICAgICBWZWN0b3IuYWRkKFxuICAgICAgICAgICAgICAgIGNhbWVyYS5nZXRGb3J3YXJkVmVjdG9yKCksXG4gICAgICAgICAgICAgICAgVmVjdG9yLmFkZChcbiAgICAgICAgICAgICAgICAgICAgVmVjdG9yLnNjYWxlKFxuICAgICAgICAgICAgICAgICAgICAgICAgY2FtZXJhLmdldFJpZ2h0VmVjdG9yKCksXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW1lcmEucmVjZW50ZXJYKHgpXG4gICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgIFZlY3Rvci5zY2FsZShcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbWVyYS5nZXRVcFZlY3RvcigpLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2FtZXJhLnJlY2VudGVyWSh5KVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TGlnaHRQb3dlciAocmF5OiBSYXksIGludGVyc2VjdDogYW55LCBvYmplY3Q6IEFic3RyYWN0T2JqZWN0KTogYW55IHtcbiAgICAgICAgbGV0IGwgPSBvYmplY3QuZ2V0UmFuZG9tUG9pbnQoKTtcblxuICAgICAgICBsZXQgY29zX2FfbWF4ID0gTWF0aC5zcXJ0KFxuICAgICAgICAgICAgMSAtIG9iamVjdC5nZXRSYWRpdXMoKSAqKiAyIC8gVmVjdG9yLmRvdChWZWN0b3Iuc3Vic3RyYWN0KGludGVyc2VjdC5nZXRIaXRQb2ludCgpLCBvYmplY3QuZ2V0UG9zaXRpb24oKSksIFZlY3Rvci5zdWJzdHJhY3QoaW50ZXJzZWN0LmdldEhpdFBvaW50KCksIG9iamVjdC5nZXRQb3NpdGlvbigpKSlcbiAgICAgICAgKTtcblxuICAgICAgICBsZXQgc2hhZG93UmF5ID0gdGhpcy50cmFjZShcbiAgICAgICAgICAgIG5ldyBSYXkoXG4gICAgICAgICAgICAgICAgaW50ZXJzZWN0LmdldEhpdFBvaW50KCksXG4gICAgICAgICAgICAgICAgVmVjdG9yLnN1YnN0cmFjdChcbiAgICAgICAgICAgICAgICAgICAgVmVjdG9yLnN1YnN0cmFjdChcbiAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdC5nZXRQb3NpdGlvbigpLFxuICAgICAgICAgICAgICAgICAgICAgICAgbFxuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICBpbnRlcnNlY3QuZ2V0SGl0UG9pbnQoKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoXG4gICAgICAgICAgICBzaGFkb3dSYXkuZ2V0SW50ZXJzZWN0KCkgJiZcbiAgICAgICAgICAgIHNoYWRvd1JheS5nZXRPd25lcigpLmdldE1hdGVyaWFsKCkuZ2V0RW1pc3Npb25WYWx1ZSgpID4gMFxuICAgICAgICApIHtcbiAgICAgICAgICAgIGxldCBvbWVnYSA9IDIgKiBNYXRoLlBJICogKDEgLSBjb3NfYV9tYXgpO1xuXG4gICAgICAgICAgICBsZXQgbmwgPSBWZWN0b3IuZG90KGludGVyc2VjdC5nZXROb3JtYWwoKSwgcmF5LmdldERpcmVjdGlvbigpKSA8IDAgPyBpbnRlcnNlY3QuZ2V0Tm9ybWFsKCkgOiBWZWN0b3Iuc2NhbGUoaW50ZXJzZWN0LmdldE5vcm1hbCgpLCAtMSk7XG5cbiAgICAgICAgICAgIHJldHVybiBpbnRlcnNlY3RcbiAgICAgICAgICAgICAgICAuZ2V0T3duZXIoKVxuICAgICAgICAgICAgICAgIC5nZXRNYXRlcmlhbCgpXG4gICAgICAgICAgICAgICAgLmdldENvbG9yKClcbiAgICAgICAgICAgICAgICAuYWRkKFxuICAgICAgICAgICAgICAgICAgICBvYmplY3RcbiAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRNYXRlcmlhbCgpXG4gICAgICAgICAgICAgICAgICAgICAgICAuZ2V0RW1pc3Npb24oKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnNjYWxlZChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBWZWN0b3IuZG90KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBubFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zY2FsZWQob21lZ2EpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIC5zY2FsZWQoMSAvIE1hdGguUEkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIENvbG9yLmJsYWNrO1xuICAgICAgICB9XG5cbiAgICAgICAgLypsZXQgbGlnaHRQb3dlciA9IG9iamVjdC5nZXRNYXRlcmlhbCgpLmdldEVtaXNzaW9uKCksXG4gICAgICAgICAgICBsaWdodFJhbmRvbVBvaW50OiBWZWN0b3IsXG4gICAgICAgICAgICBzaGFkb3dSYXk6IEludGVyc2VjdFBvaW50LFxuICAgICAgICAgICAgcmVzdWx0UG93ZXI6IG51bWJlciA9IDA7XG5cbiAgICAgICAgbGlnaHRSYW5kb21Qb2ludCA9IG9iamVjdC5nZXRSYW5kb21Qb2ludCgpO1xuXG4gICAgICAgIHNoYWRvd1JheSA9IHRoaXMudHJhY2UoXG4gICAgICAgICAgICBuZXcgUmF5KFxuICAgICAgICAgICAgICAgIGludGVyc2VjdC5nZXRIaXRQb2ludCgpLFxuICAgICAgICAgICAgICAgIFZlY3Rvci5zdWJzdHJhY3QoXG4gICAgICAgICAgICAgICAgICAgIFZlY3Rvci5zdWJzdHJhY3QoXG4gICAgICAgICAgICAgICAgICAgICAgICBvYmplY3QuZ2V0UG9zaXRpb24oKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0UmFuZG9tUG9pbnRcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0LmdldEhpdFBvaW50KClcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgc2hhZG93UmF5LmdldEludGVyc2VjdCgpICYmXG4gICAgICAgICAgICBzaGFkb3dSYXkuZ2V0T3duZXIoKS5nZXRNYXRlcmlhbCgpLmdldEVtaXNzaW9uVmFsdWUoKSA+IDBcbiAgICAgICAgKSB7XG4gICAgICAgICAgICByZXN1bHRQb3dlciA9IDE7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0UG93ZXI7XG5cbiAgICAgICAgLypsaWdodFJhbmRvbVBvaW50ID0gdGhpcy5jb3NpbmVTYW1wbGVIZW1pc3BoZXJlKFxuICAgICAgICAgICAgaW50ZXJzZWN0LmdldE93bmVyKCkuZ2V0Tm9ybWFsKGludGVyc2VjdC5nZXRIaXRQb2ludCgpKVxuICAgICAgICApO1xuXG4gICAgICAgIHNoYWRvd1JheSA9IHRoaXMudHJhY2UoXG4gICAgICAgICAgICBuZXcgUmF5KFxuICAgICAgICAgICAgICAgIGludGVyc2VjdC5nZXRIaXRQb2ludCgpLFxuICAgICAgICAgICAgICAgIGxpZ2h0UmFuZG9tUG9pbnRcbiAgICAgICAgICAgIClcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoXG4gICAgICAgICAgICBzaGFkb3dSYXkuZ2V0SW50ZXJzZWN0KCkgJiZcbiAgICAgICAgICAgIHNoYWRvd1JheS5nZXRPd25lcigpIGluc3RhbmNlb2YgQWJzdHJhY3RMaWdodFxuICAgICAgICApIHtcbiAgICAgICAgICAgIHJlc3VsdFBvd2VyID0gKFxuICAgICAgICAgICAgICAgIChcbiAgICAgICAgICAgICAgICAgICAgVmVjdG9yLnN1YnN0cmFjdChcbiAgICAgICAgICAgICAgICAgICAgICAgIFZlY3Rvci5zdWJzdHJhY3QoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHQuZ2V0UG9zaXRpb24oKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodFJhbmRvbVBvaW50XG4gICAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0LmdldEhpdFBvaW50KClcbiAgICAgICAgICAgICAgICAgICAgKS5nZXRMZW5ndGgoKSAqIChsaWdodFBvd2VyIC8gbGlnaHQuZ2V0RmFkZVJhZGl1cygpKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmIChyZXN1bHRQb3dlciA8IDApIHtcbiAgICAgICAgICAgICAgICByZXN1bHRQb3dlciA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0qL1xuXG4gICAgICAgIC8qcmV0dXJuIHJlc3VsdFBvd2VyOyovXG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0cmFjZSAocmF5OiBSYXkpOiBJbnRlcnNlY3RQb2ludCB7XG4gICAgICAgIGxldCBpbnRlcnNlY3Rpb24gPSBuZXcgSW50ZXJzZWN0UG9pbnQoKSxcbiAgICAgICAgICAgIGludGVyc2VjdERhdGE6IGFueSxcbiAgICAgICAgICAgIG1pbkRpc3RhbmNlOiBudW1iZXIgPSBJbmZpbml0eSxcbiAgICAgICAgICAgIHNjZW5lT2JqZWN0czogQWJzdHJhY3RPYmplY3RbXSA9IHRoaXMuc2NlbmUuZ2V0T2JqZWN0cygpO1xuXG4gICAgICAgIGZvciAobGV0IG9iamVjdCBvZiBzY2VuZU9iamVjdHMpIHtcbiAgICAgICAgICAgIGludGVyc2VjdERhdGEgPSBvYmplY3QuZ2V0SW50ZXJzZWN0RGF0YShyYXkpO1xuXG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgaW50ZXJzZWN0RGF0YSAmJlxuICAgICAgICAgICAgICAgIGludGVyc2VjdERhdGFbJ2Rpc3RhbmNlJ10gPCBtaW5EaXN0YW5jZVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgbWluRGlzdGFuY2UgPSBpbnRlcnNlY3REYXRhWydkaXN0YW5jZSddO1xuXG4gICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uLnNldEludGVyc2VjdCgpO1xuICAgICAgICAgICAgICAgIGludGVyc2VjdGlvbi5zZXRIaXRQb2ludChpbnRlcnNlY3REYXRhWydoaXRQb2ludCddKTtcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb24uc2V0Tm9ybWFsKGludGVyc2VjdERhdGFbJ25vcm1hbCddKTtcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb24uc2V0RGlzdGFuY2VGcm9tT3JpZ2luKGludGVyc2VjdERhdGFbJ2Rpc3RhbmNlJ10pO1xuICAgICAgICAgICAgICAgIGludGVyc2VjdGlvbi5zZXRPd25lcihvYmplY3QpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGludGVyc2VjdGlvbjtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVuZGVyIChzY3JlZW5XaWR0aDogbnVtYmVyLCBzY3JlZW5IZWlnaHQ6IG51bWJlcik6IHZvaWQge1xuICAgICAgICBjb25zdCByYW5kb011bHRpcGxpZXIgPSAwLjU7XG5cbiAgICAgICAgbGV0IGJ1ZmZlcjogbnVtYmVyW10sXG4gICAgICAgICAgICBjb2xvcjogQ29sb3IsXG4gICAgICAgICAgICByYW5kOiBudW1iZXIsXG4gICAgICAgICAgICByYXk6IFJheTtcblxuICAgICAgICB0aGlzLnNjcmVlbldpZHRoID0gc2NyZWVuV2lkdGg7XG4gICAgICAgIHRoaXMuc2NyZWVuSGVpZ2h0ID0gc2NyZWVuSGVpZ2h0O1xuXG4gICAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgICAgICBidWZmZXIgPSBbXTtcblxuICAgICAgICAgICAgZm9yIChsZXQgaXRlcmF0aW9uID0gMDsgaXRlcmF0aW9uIDwgMTsgaXRlcmF0aW9uKyspIHtcbiAgICAgICAgICAgICAgICBsZXQgaSA9IDA7XG5cbiAgICAgICAgICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHRoaXMuc2NyZWVuSGVpZ2h0OyB5KyspIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgeCA9IDA7IHggPCB0aGlzLnNjcmVlbldpZHRoOyB4KyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmQgPSAwO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmQgKz0gTWF0aC5yYW5kb20oKSAqIHJhbmRvTXVsdGlwbGllcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmQgLT0gTWF0aC5yYW5kb20oKSAqIHJhbmRvTXVsdGlwbGllcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgcmF5ID0gbmV3IFJheShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNjZW5lLmdldENhbWVyYSgpLmdldFBvc2l0aW9uKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRQZXJzcGVjdGl2ZVZlY3Rvcih4ICsgcmFuZCwgeSArIHJhbmQpXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJ1ZmZlcltpXSA9IENvbG9yLmJsYWNrLmFkZCh0aGlzLmdldENvbG9yKHJheSkpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBjb21wb25lbnQgaW4gdGhpcy5idWZmZXJbaV0uZ2V0Q29sb3IoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYnVmZmVyW2ldW2NvbXBvbmVudF0gPSBDb2xvci5zUkdCRW5jb2RlKHRoaXMuYnVmZmVyW2ldW2NvbXBvbmVudF0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaCh0aGlzLmJ1ZmZlcltpXS5nZXRDb2xvcigpWydyZWQnXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaCh0aGlzLmJ1ZmZlcltpXS5nZXRDb2xvcigpWydncmVlbiddKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKHRoaXMuYnVmZmVyW2ldLmdldENvbG9yKClbJ2JsdWUnXSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGkrKztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZm9yKGxldCAgaSA9IDA7IGkgPCB0aGlzLmJ1ZmZlci5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHRoaXMuYnVmZmVyW2ldLmdldENvbG9yKClbJ3JlZCddID0gMC4wO1xuICAgICAgICAgICAgICAgIHRoaXMuYnVmZmVyW2ldLmdldENvbG9yKClbJ2dyZWVuJ10gPSAwLjA7XG4gICAgICAgICAgICAgICAgdGhpcy5idWZmZXJbaV0uZ2V0Q29sb3IoKVsnYmx1ZSddID0gMC4wO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZWxmLnBvc3RNZXNzYWdlKGJ1ZmZlcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0U2NlbmUgKHNjZW5lOiBTY2VuZSk6IHZvaWQge1xuICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7XG4gICAgfVxufVxuXG5vbm1lc3NhZ2UgPSBmdW5jdGlvbiAobWVzc2FnZSkge1xuICAgIHZhciBkYXRhID0gbWVzc2FnZS5kYXRhO1xuXG4gICAgaWYgKHR5cGVvZihkYXRhKSA9PSAnc3RyaW5nJykge1xuICAgICAgICBkYXRhID0gSlNPTi5wYXJzZSgnWycrZGF0YSsnXScpO1xuICAgIH1cblxuICAgIGxldCB0cmFjZXIgPSBuZXcgVHJhY2VyKCk7XG5cbiAgICB0cmFjZXIuc2V0U2NlbmUoXG4gICAgICAgIG5ldyBTY2VuZSh7XG4gICAgICAgICAgICBjYW1lcmE6IG5ldyBDYW1lcmEoXG4gICAgICAgICAgICAgICAgbmV3IFZlY3RvcigwLCAwLCAtNjk5KSxcbiAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKDAsIDAsIDEpLFxuICAgICAgICAgICAgICAgIGRhdGFbMF0sXG4gICAgICAgICAgICAgICAgZGF0YVsxXVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIG9iamVjdHM6IFtcbiAgICAgICAgICAgICAgICBuZXcgU3BoZXJlKG5ldyBWZWN0b3IoMCwgNjMwLCAwKSwgNjApXG4gICAgICAgICAgICAgICAgICAgIC5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWwoQ29sb3IuZ3JheSwgbmV3IENvbG9yKG5ldyBGbG9hdENvbG9yKDQwMCwgNDAwLCA0MDApKSkpLFxuICAgICAgICAgICAgICAgIG5ldyBQbGFuZShuZXcgVmVjdG9yKDAsIDEsIDApLCBuZXcgVmVjdG9yICgwLCAtNzAwLCAwKSkuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKG5ldyBDb2xvcihuZXcgUkdCQ29sb3IoMC43NSAqIDI1NSwgMC43NSAqIDI1NSwgMC43NSAqIDI1NSkpKS5zZXRMYW1iZXJ0Q29lZmYoMSkpLFxuICAgICAgICAgICAgICAgIG5ldyBQbGFuZShuZXcgVmVjdG9yKDAsIC0xLCAwKSwgbmV3IFZlY3RvciAoMCwgNzAwLCAwKSkuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKG5ldyBDb2xvcihuZXcgUkdCQ29sb3IoMC43NSAqIDI1NSwgMC43NSAqIDI1NSwgMC43NSAqIDI1NSkpKS5zZXRMYW1iZXJ0Q29lZmYoMSkpLFxuICAgICAgICAgICAgICAgIG5ldyBQbGFuZShuZXcgVmVjdG9yKC0xLCAwLCAwKSwgbmV3IFZlY3RvciAoNzAwLCAwLCAwKSkuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKG5ldyBDb2xvcihuZXcgUkdCQ29sb3IoMC4zICogMjU1LCAyNTUsIDAuMSAqIDI1NSkpKS5zZXRMYW1iZXJ0Q29lZmYoMSkpLFxuICAgICAgICAgICAgICAgIG5ldyBQbGFuZShuZXcgVmVjdG9yKDEsIDAsIDApLCBuZXcgVmVjdG9yICgtNzAwLCAwLCAwKSkuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKG5ldyBDb2xvcihuZXcgUkdCQ29sb3IoMjU1LCAwLjMgKiAyNTUsIDAuMSAqIDI1NSkpKS5zZXRMYW1iZXJ0Q29lZmYoMSkpLFxuICAgICAgICAgICAgICAgIG5ldyBQbGFuZShuZXcgVmVjdG9yKDAsIDAsIC0xKSwgbmV3IFZlY3RvciAoMCwgMCwgNzAwKSkuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKG5ldyBDb2xvcihuZXcgUkdCQ29sb3IoMC43NSAqIDI1NSwgMC43NSAqIDI1NSwgMC43NSAqIDI1NSkpKS5zZXRMYW1iZXJ0Q29lZmYoMSkpLFxuICAgICAgICAgICAgICAgIG5ldyBQbGFuZShuZXcgVmVjdG9yKDAsIDAsIDEpLCBuZXcgVmVjdG9yICgwLCAwLCAtNzAwKSkuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKENvbG9yLmJsYWNrKS5zZXRMYW1iZXJ0Q29lZmYoMSkpLFxuICAgICAgICAgICAgICAgIC8vIGJvdHRvbSBwbGFuZVxuICAgICAgICAgICAgICAgIC8qbmV3IFNwaGVyZShuZXcgVmVjdG9yKC0yNTAsIC01MDAsIDQ1MCksIDIwMClcbiAgICAgICAgICAgICAgICAgICAgLnNldE1hdGVyaWFsKG5ldyBNYXRlcmlhbChDb2xvci5ibGFjaywgMSkpLCovXG4gICAgICAgICAgICAgICAgbmV3IFNwaGVyZShuZXcgVmVjdG9yKDAsIC0zMDAsIDQwMCksIDQwMClcbiAgICAgICAgICAgICAgICAgICAgLnNldE1hdGVyaWFsKG5ldyBNYXRlcmlhbChDb2xvci5ncmF5KSlcbiAgICAgICAgICAgIF1cbiAgICAgICAgfSlcbiAgICApO1xuXG4gICAgdHJhY2VyLnJlbmRlcihkYXRhWzBdLCBkYXRhWzFdKTtcbn07Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
