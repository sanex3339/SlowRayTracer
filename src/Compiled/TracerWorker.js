var AbstractLight_1=require("./Lights/AbstractLight"),Camera_1=require("./Camera"),Color_1=require("./Color/Color"),IntersectPoint_1=require("./IntersectPoint"),Material_1=require("./Material"),Polygon_1=require("./Objects/Polygon"),Ray_1=require("./Ray"),RGBColor_1=require("./Color/RGBColor"),Scene_1=require("./Scene"),Sphere_1=require("./Objects/Sphere"),SphericalLight_1=require("./Lights/SphericalLight"),Vector_1=require("./Vector"),Tracer=function(){function e(){this.screenWidth=250,this.screenHeight=250}return e.prototype.cosineSampleHemisphere=function(e){var t,r,o=Math.random(),a=Math.random(),c=Math.sqrt(o),n=2*Math.PI*a;return t=Math.abs(e.getCoordinates().x)<.5?Vector_1.Vector.cross(e,new Vector_1.Vector(1,0,0)):Vector_1.Vector.cross(e,new Vector_1.Vector(0,1,0)),r=Vector_1.Vector.cross(e,t),Vector_1.Vector.add(Vector_1.Vector.scale(e,Math.sqrt(1-o)),Vector_1.Vector.add(Vector_1.Vector.scale(t,c*Math.cos(n)),Vector_1.Vector.scale(r,c*Math.sin(n))))},e.prototype.getColor=function(e){var t=this.trace(e),r=Color_1.Color.black,o=Color_1.Color.black,a=e.getIteration();return e.setIteration(--a),0===a?Color_1.Color.black:t.getIntersect()?(r=this.getDiffuseColor(e,t),o=this.getReflectionColor(e,t),r.add(o)):Color_1.Color.black},e.prototype.getDiffuseColor=function(e,t,r){void 0===r&&(r=!0);for(var o,a,c,n,i,l,s,g,V,_,h=Color_1.Color.black,w=0,C=this.scene.getLights();w<C.length;w++){var d=C[w];if(t.getOwner()instanceof AbstractLight_1.AbstractLight)return t.getOwner().getMaterial().getColor();l=this.getLightPower(t,d),o=Color_1.Color.black,a=Color_1.Color.black,c=Color_1.Color.black,i=Vector_1.Vector.normalize(Vector_1.Vector.substract(t.getHitPoint(),d.getPosition()));var M=void 0;n=this.cosineSampleHemisphere(t.getOwner().getNormal(t.getHitPoint())),M=this.getColor(new Ray_1.Ray(t.getHitPoint(),n,e.getIteration())),c=c.add(M),g=-Vector_1.Vector.dot(i,t.getNormal()),o=o.add(t.getOwner().getMaterial().getColor().add(c).multiple(d.getMaterial().getColor().scaled(l*g*t.getOwner().getMaterial().getLambertCoeff()))),s=Vector_1.Vector.reflect(i,t.getNormal()),V=-Vector_1.Vector.dot(s,e.getDirection()),V>0&&(_=Math.pow(V,35),a=a.add(t.getOwner().getMaterial().getColor().multiple(d.getMaterial().getColor().scaled(l*_*t.getOwner().getMaterial().getPhongCoeff())))),h=h.add(o.add(a))}return h},e.prototype.getReflectionColor=function(e,t){var r,o,a=t.getOwner().getMaterial().getReflectionValue();return 0===a?Color_1.Color.black:(o=Vector_1.Vector.reflect(e.getDirection(),t.getNormal()),r=this.getColor(new Ray_1.Ray(t.getHitPoint(),o,e.getIteration())).scaled(a))},e.prototype.getPerspectiveVector=function(e,t){var r=this.scene.getCamera();return Vector_1.Vector.normalize(Vector_1.Vector.add(r.getForwardVector(),Vector_1.Vector.add(Vector_1.Vector.scale(r.getRightVector(),r.recenterX(e)),Vector_1.Vector.scale(r.getUpVector(),r.recenterY(t)))))},e.prototype.getLightPower=function(e,t){var r,o,a=t.getPower(),c=0;return r=t.getRandomPoint(),o=this.trace(new Ray_1.Ray(e.getHitPoint(),Vector_1.Vector.substract(Vector_1.Vector.substract(t.getPosition(),r),e.getHitPoint()))),o.getIntersect()&&o.getOwner()instanceof AbstractLight_1.AbstractLight&&(c+=a-Vector_1.Vector.substract(Vector_1.Vector.substract(t.getPosition(),r),e.getHitPoint()).getLength()*(a/t.getFadeRadius())),c},e.prototype.trace=function(e){for(var t,r=new IntersectPoint_1.IntersectPoint,o=1/0,a=this.scene.getObjects().concat(this.scene.getLights()),c=0,n=a;c<n.length;c++){var i=n[c];t=i.getIntersectData(e),t&&t.distance<o&&(o=t.distance,r.setIntersect(),r.setHitPoint(t.hitPoint),r.setNormal(t.normal),r.setDistanceFromOrigin(t.distance),r.setOwner(i))}return r},e.prototype.render=function(e,t){var r,o,a,c,n=.5;for(this.screenWidth=e,this.screenHeight=t;;){r=[];for(var i=0;i<this.screenHeight;i++)for(var l=0;l<this.screenWidth;l++){a=0,Math.random()>.5?a+=Math.random()*n:a-=Math.random()*n,c=new Ray_1.Ray(this.scene.getCamera().getPosition(),this.getPerspectiveVector(l+a,i+a)),o=Color_1.Color.black.add(this.getColor(c));for(var s in o)o[s]=Color_1.Color.sRGBEncode(o[s]);r.push(o.red),r.push(o.green),r.push(o.blue)}self.postMessage(r)}},e.prototype.setScene=function(e){this.scene=e},e}();onmessage=function(e){var t=e.data;"string"==typeof t&&(t=JSON.parse("["+t+"]"));var r=new Tracer;r.setScene(new Scene_1.Scene({camera:new Camera_1.Camera(new Vector_1.Vector(0,0,-699),new Vector_1.Vector(0,0,1),t[0],t[1]),lights:[new SphericalLight_1.SphericalLight(new Vector_1.Vector(0,600,0),.6,100).setMaterial(new Material_1.Material(Color_1.Color.white)),new SphericalLight_1.SphericalLight(new Vector_1.Vector(0,0,0),.6,150).setMaterial(new Material_1.Material(new Color_1.Color(new RGBColor_1.RGBColor(255,235,200))))],objects:[new Polygon_1.Polygon(new Vector_1.Vector(-700,-700,-700),new Vector_1.Vector(700,-700,-700),new Vector_1.Vector(700,-700,700),new Vector_1.Vector(-700,-700,700)).setMaterial(new Material_1.Material(Color_1.Color.white,0).setLambertCoeff(1)),new Polygon_1.Polygon(new Vector_1.Vector(-700,-700,700),new Vector_1.Vector(700,-700,700),new Vector_1.Vector(700,700,700),new Vector_1.Vector(-700,700,700)).setMaterial(new Material_1.Material(Color_1.Color.white,0).setLambertCoeff(1)),new Polygon_1.Polygon(new Vector_1.Vector(-700,700,700),new Vector_1.Vector(700,700,700),new Vector_1.Vector(700,700,-700),new Vector_1.Vector(-700,700,-700)).setMaterial(new Material_1.Material(Color_1.Color.white,0).setLambertCoeff(1)),new Polygon_1.Polygon(new Vector_1.Vector(700,-700,700),new Vector_1.Vector(700,-700,-700),new Vector_1.Vector(700,700,-700),new Vector_1.Vector(700,700,700)).setMaterial(new Material_1.Material(Color_1.Color.blue).setLambertCoeff(1)),new Polygon_1.Polygon(new Vector_1.Vector(-700,-700,-700),new Vector_1.Vector(-700,-700,700),new Vector_1.Vector(-700,700,700),new Vector_1.Vector(-700,700,-700)).setMaterial(new Material_1.Material(Color_1.Color.red,0).setLambertCoeff(1)),new Polygon_1.Polygon(new Vector_1.Vector(700,-700,-700),new Vector_1.Vector(-700,-700,-700),new Vector_1.Vector(-700,700,-700),new Vector_1.Vector(700,700,-700)).setMaterial(new Material_1.Material(Color_1.Color.black,0).setLambertCoeff(1)),new Sphere_1.Sphere(new Vector_1.Vector(-250,-500,450),200).setMaterial(new Material_1.Material(Color_1.Color.black,1)),new Sphere_1.Sphere(new Vector_1.Vector(250,-500,400),200).setMaterial(new Material_1.Material(Color_1.Color.green,0))]})),r.render(t[0],t[1])};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlRyYWNlcldvcmtlci50cyJdLCJuYW1lcyI6WyJBYnN0cmFjdExpZ2h0XzEiLCJyZXF1aXJlIiwiQ2FtZXJhXzEiLCJDb2xvcl8xIiwiSW50ZXJzZWN0UG9pbnRfMSIsIk1hdGVyaWFsXzEiLCJQb2x5Z29uXzEiLCJSYXlfMSIsIlJHQkNvbG9yXzEiLCJTY2VuZV8xIiwiU3BoZXJlXzEiLCJTcGhlcmljYWxMaWdodF8xIiwiVmVjdG9yXzEiLCJUcmFjZXIiLCJUcmFjZXIuY29uc3RydWN0b3IiLCJUcmFjZXIuY29zaW5lU2FtcGxlSGVtaXNwaGVyZSIsIlRyYWNlci5nZXRDb2xvciIsIlRyYWNlci5nZXREaWZmdXNlQ29sb3IiLCJUcmFjZXIuZ2V0UmVmbGVjdGlvbkNvbG9yIiwiVHJhY2VyLmdldFBlcnNwZWN0aXZlVmVjdG9yIiwiVHJhY2VyLmdldExpZ2h0UG93ZXIiLCJUcmFjZXIudHJhY2UiLCJUcmFjZXIucmVuZGVyIiwiVHJhY2VyLnNldFNjZW5lIiwib25tZXNzYWdlIiwibWVzc2FnZSIsImRhdGEiLCJKU09OIiwicGFyc2UiLCJ0cmFjZXIiLCJzZXRTY2VuZSIsIlNjZW5lIiwiY2FtZXJhIiwiQ2FtZXJhIiwiVmVjdG9yIiwibGlnaHRzIiwiU3BoZXJpY2FsTGlnaHQiLCJzZXRNYXRlcmlhbCIsIk1hdGVyaWFsIiwiQ29sb3IiLCJ3aGl0ZSIsIlJHQkNvbG9yIiwib2JqZWN0cyIsIlBvbHlnb24iLCJzZXRMYW1iZXJ0Q29lZmYiLCJibHVlIiwicmVkIiwiYmxhY2siLCJTcGhlcmUiLCJncmVlbiIsInJlbmRlciJdLCJtYXBwaW5ncyI6IkFBR0EsR0FBQUEsaUJBQUFDLFFBQThCLDBCQUU5QkMsU0FBQUQsUUFBdUIsWUFDdkJFLFFBQUFGLFFBQXNCLGlCQUN0QkcsaUJBQUFILFFBQStCLG9CQUMvQkksV0FBQUosUUFBeUIsY0FFekJLLFVBQUFMLFFBQXdCLHFCQUN4Qk0sTUFBQU4sUUFBb0IsU0FDcEJPLFdBQUFQLFFBQXlCLG9CQUV6QlEsUUFB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T0FBTyxJQUFLLElBQUssTUFDckIsR0FBSXRCLFVBQUFzQixPQUFPLElBQUssSUFBSyxNQUN2QkcsWUFBWSxHQUFJaEMsWUFBQWlDLFNBQVNuQyxRQUFBb0MsTUFBTU0sTUFBTUQsZ0JBQWdCLElBRXZELEdBQUl0QyxXQUFBcUMsUUFDQSxHQUFJL0IsVUFBQXNCLE9BQU8sS0FBTSxLQUFNLE1BQ3ZCLEdBQUl0QixVQUFBc0IsT0FBTyxLQUFNLEtBQU0sS0FDdkIsR0FBSXRCLFVBQUFzQixPQUFPLEtBQU0sSUFBSyxLQUN0QixHQUFJdEIsVUFBQXNCLE9BQU8sS0FBTSxJQUFLLE9BQ3hCRyxZQUFZLEdBQUloQyxZQUFBaUMsU0FBU25DLFFBQUFvQyxNQUFNTyxJQUFLLEdBQUdGLGdCQUFnQixJQUV6RCxHQUFJdEMsV0FBQXFDLFFBQ0EsR0FBSS9CLFVBQUFzQixPQUFPLElBQUssS0FBTSxNQUN0QixHQUFJdEIsVUFBQXNCLE9BQU8sS0FBTSxLQUFNLE1BQ3ZCLEdBQUl0QixVQUFBc0IsT0FBTyxLQUFNLElBQUssTUFDdEIsR0FBSXRCLFVBQUFzQixPQUFPLElBQUssSUFBSyxPQUN2QkcsWUFBWSxHQUFJaEMsWUFBQWlDLFNBQVNuQyxRQUFBb0MsTUFBTVEsTUFBTyxHQUFHSCxnQkFBZ0IsSUFDM0QsR0FBSWxDLFVBQUFzQyxPQUFPLEdBQUlwQyxVQUFBc0IsT0FBTyxLQUFNLEtBQU0sS0FBTSxLQUNuQ0csWUFBWSxHQUFJaEMsWUFBQWlDLFNBQVNuQyxRQUFBb0MsTUFBTVEsTUFBTyxJQUMzQyxHQUFJckMsVUFBQXNDLE9BQU8sR0FBSXBDLFVBQUFzQixPQUFPLElBQUssS0FBTSxLQUFNLEtBQ2xDRyxZQUFZLEdBQUloQyxZQUFBaUMsU0FBU25DLFFBQUFvQyxNQUFNVSxNQUFPLFFBS3ZEcEIsRUFBT3FCLE9BQU94QixFQUFLLEdBQUlBLEVBQUsiLCJmaWxlIjoiVHJhY2VyV29ya2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2Ugbm8tZGVmYXVsdC1saWI9XCJ0cnVlXCIvPlxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cImxpYi9saWIud2Vid29ya2VyLmQudHNcIiAvPlxuXG5pbXBvcnQgeyBBYnN0cmFjdExpZ2h0IH0gZnJvbSBcIi4vTGlnaHRzL0Fic3RyYWN0TGlnaHRcIjtcbmltcG9ydCB7IEFic3RyYWN0T2JqZWN0IH0gZnJvbSBcIi4vT2JqZWN0cy9BYnN0cmFjdE9iamVjdFwiO1xuaW1wb3J0IHsgQ2FtZXJhIH0gZnJvbSBcIi4vQ2FtZXJhXCI7XG5pbXBvcnQgeyBDb2xvciB9IGZyb20gXCIuL0NvbG9yL0NvbG9yXCI7XG5pbXBvcnQgeyBJbnRlcnNlY3RQb2ludCB9IGZyb20gXCIuL0ludGVyc2VjdFBvaW50XCI7XG5pbXBvcnQgeyBNYXRlcmlhbCB9IGZyb20gXCIuL01hdGVyaWFsXCI7XG5pbXBvcnQgeyBQbGFuZSB9IGZyb20gXCIuL09iamVjdHMvUGxhbmVcIjtcbmltcG9ydCB7IFBvbHlnb24gfSBmcm9tIFwiLi9PYmplY3RzL1BvbHlnb25cIjtcbmltcG9ydCB7IFJheSB9IGZyb20gXCIuL1JheVwiO1xuaW1wb3J0IHsgUkdCQ29sb3IgfSBmcm9tIFwiLi9Db2xvci9SR0JDb2xvclwiO1xuaW1wb3J0IHsgUlRNYXRoIH0gZnJvbSBcIi4vUlRNYXRoXCI7XG5pbXBvcnQgeyBTY2VuZSB9IGZyb20gXCIuL1NjZW5lXCI7XG5pbXBvcnQgeyBTcGhlcmUgfSBmcm9tIFwiLi9PYmplY3RzL1NwaGVyZVwiO1xuaW1wb3J0IHsgU3BoZXJpY2FsTGlnaHQgfSBmcm9tIFwiLi9MaWdodHMvU3BoZXJpY2FsTGlnaHRcIjtcbmltcG9ydCB7IFZlY3RvciB9IGZyb20gXCIuL1ZlY3RvclwiO1xuXG5jbGFzcyBUcmFjZXIge1xuICAgIHByaXZhdGUgc2NlbmU6IFNjZW5lO1xuICAgIHByaXZhdGUgc2NyZWVuV2lkdGg6IG51bWJlciA9IDI1MDtcbiAgICBwcml2YXRlIHNjcmVlbkhlaWdodDogbnVtYmVyID0gMjUwO1xuXG4gICAgcHJpdmF0ZSBjb3NpbmVTYW1wbGVIZW1pc3BoZXJlIChub3JtYWw6IFZlY3Rvcik6IFZlY3RvciB7XG4gICAgICAgIGxldCB1ID0gTWF0aC5yYW5kb20oKTtcbiAgICAgICAgbGV0IHYgPSBNYXRoLnJhbmRvbSgpO1xuICAgICAgICBsZXQgciA9IE1hdGguc3FydCh1KTtcbiAgICAgICAgbGV0IGFuZ2xlID0gMiAqIE1hdGguUEkgKiB2O1xuXG4gICAgICAgIGxldCBzZGlyLFxuICAgICAgICAgICAgdGRpcjtcblxuICAgICAgICBpZiAoTWF0aC5hYnMobm9ybWFsLmdldENvb3JkaW5hdGVzKClbJ3gnXSkgPCAwLjUpIHtcbiAgICAgICAgICAgIHNkaXIgPSBWZWN0b3IuY3Jvc3Mobm9ybWFsLCBuZXcgVmVjdG9yKDEsMCwwKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzZGlyID0gVmVjdG9yLmNyb3NzKG5vcm1hbCwgbmV3IFZlY3RvcigwLDEsMCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGRpciA9IFZlY3Rvci5jcm9zcyhub3JtYWwsIHNkaXIpO1xuXG4gICAgICAgIHJldHVybiBWZWN0b3IuYWRkKFxuICAgICAgICAgICAgVmVjdG9yLnNjYWxlKG5vcm1hbCwgIE1hdGguc3FydCgxIC0gdSkpLFxuICAgICAgICAgICAgVmVjdG9yLmFkZChcbiAgICAgICAgICAgICAgICBWZWN0b3Iuc2NhbGUoc2RpciwgciAqIE1hdGguY29zKGFuZ2xlKSksXG4gICAgICAgICAgICAgICAgVmVjdG9yLnNjYWxlKHRkaXIsIHIgKiBNYXRoLnNpbihhbmdsZSkpXG4gICAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRDb2xvciAocmF5OiBSYXkpOiBDb2xvciB7XG4gICAgICAgIGxldCBpbnRlcnNlY3Rpb24gPSB0aGlzLnRyYWNlKHJheSksXG4gICAgICAgICAgICBkaWZmdXNlQ29sb3I6IENvbG9yID0gQ29sb3IuYmxhY2ssXG4gICAgICAgICAgICByZWZsZWN0Q29sb3I6IENvbG9yID0gQ29sb3IuYmxhY2ssXG4gICAgICAgICAgICByYXlJdGVyYXRpb246IG51bWJlciA9IHJheS5nZXRJdGVyYXRpb24oKTtcblxuICAgICAgICByYXkuc2V0SXRlcmF0aW9uKC0tcmF5SXRlcmF0aW9uKTtcblxuICAgICAgICBpZiAocmF5SXRlcmF0aW9uID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gQ29sb3IuYmxhY2s7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWludGVyc2VjdGlvbi5nZXRJbnRlcnNlY3QoKSkge1xuICAgICAgICAgICAgcmV0dXJuIENvbG9yLmJsYWNrO1xuICAgICAgICB9XG5cbiAgICAgICAgZGlmZnVzZUNvbG9yID0gdGhpcy5nZXREaWZmdXNlQ29sb3IocmF5LCBpbnRlcnNlY3Rpb24pO1xuICAgICAgICByZWZsZWN0Q29sb3IgPSB0aGlzLmdldFJlZmxlY3Rpb25Db2xvcihyYXksIGludGVyc2VjdGlvbik7XG5cbiAgICAgICAgcmV0dXJuIGRpZmZ1c2VDb2xvci5hZGQocmVmbGVjdENvbG9yKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldERpZmZ1c2VDb2xvciAocmF5OiBSYXksIGludGVyc2VjdDogYW55LCByZWN1cnNpdmU6IGJvb2xlYW4gPSB0cnVlKTogQ29sb3Ige1xuICAgICAgICBsZXQgbGFtYkNvbG9yOiBDb2xvcixcbiAgICAgICAgICAgIHBob25nQ29sb3I6IENvbG9yLFxuICAgICAgICAgICAgcmFkaWFuY2VDb2xvcjogQ29sb3IsXG4gICAgICAgICAgICBwaXhlbENvbG9yOiBDb2xvciA9IENvbG9yLmJsYWNrLFxuICAgICAgICAgICAgcmFkaWFuY2VSYW5kb21EaXJlY3Rpb246IFZlY3RvcixcbiAgICAgICAgICAgIGxpZ2h0RGlyZWN0aW9uOiBWZWN0b3IsXG4gICAgICAgICAgICBsaWdodFBvd2VyOiBudW1iZXIsXG4gICAgICAgICAgICByZWZsZWN0UGhvbmdWZWN0b3JEaXI6IFZlY3RvcixcbiAgICAgICAgICAgIGxhbWJDb3M6IG51bWJlcixcbiAgICAgICAgICAgIHBob25nQ29zOiBudW1iZXIsXG4gICAgICAgICAgICBwaG9uZzogbnVtYmVyO1xuXG4gICAgICAgIGZvciAobGV0IGxpZ2h0IG9mIHRoaXMuc2NlbmUuZ2V0TGlnaHRzKCkpIHtcbiAgICAgICAgICAgIGlmIChpbnRlcnNlY3QuZ2V0T3duZXIoKSBpbnN0YW5jZW9mIEFic3RyYWN0TGlnaHQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gaW50ZXJzZWN0LmdldE93bmVyKClcbiAgICAgICAgICAgICAgICAgICAgLmdldE1hdGVyaWFsKClcbiAgICAgICAgICAgICAgICAgICAgLmdldENvbG9yKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxpZ2h0UG93ZXIgPSB0aGlzLmdldExpZ2h0UG93ZXIoaW50ZXJzZWN0LCBsaWdodCk7XG5cbiAgICAgICAgICAgIGxhbWJDb2xvciA9IENvbG9yLmJsYWNrO1xuICAgICAgICAgICAgcGhvbmdDb2xvciA9IENvbG9yLmJsYWNrO1xuICAgICAgICAgICAgcmFkaWFuY2VDb2xvciA9IENvbG9yLmJsYWNrO1xuXG4gICAgICAgICAgICBsaWdodERpcmVjdGlvbiA9IFZlY3Rvci5ub3JtYWxpemUoXG4gICAgICAgICAgICAgICAgVmVjdG9yLnN1YnN0cmFjdChcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0LmdldEhpdFBvaW50KCksXG4gICAgICAgICAgICAgICAgICAgIGxpZ2h0LmdldFBvc2l0aW9uKClcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApO1xuXG5cblxuICAgICAgICAgICAgLy9naVxuICAgICAgICAgICAgbGV0IHJhZGlhbmNlSW5SYW5kb21EaXJlY3Rpb246IENvbG9yO1xuXG4gICAgICAgICAgICByYWRpYW5jZVJhbmRvbURpcmVjdGlvbiA9IHRoaXMuY29zaW5lU2FtcGxlSGVtaXNwaGVyZShcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3QuZ2V0T3duZXIoKS5nZXROb3JtYWwoaW50ZXJzZWN0LmdldEhpdFBvaW50KCkpXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICByYWRpYW5jZUluUmFuZG9tRGlyZWN0aW9uID0gdGhpcy5nZXRDb2xvcihcbiAgICAgICAgICAgICAgICBuZXcgUmF5KFxuICAgICAgICAgICAgICAgICAgICBpbnRlcnNlY3QuZ2V0SGl0UG9pbnQoKSxcbiAgICAgICAgICAgICAgICAgICAgcmFkaWFuY2VSYW5kb21EaXJlY3Rpb24sXG4gICAgICAgICAgICAgICAgICAgIHJheS5nZXRJdGVyYXRpb24oKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIHJhZGlhbmNlQ29sb3IgPSByYWRpYW5jZUNvbG9yXG4gICAgICAgICAgICAgICAgLmFkZChyYWRpYW5jZUluUmFuZG9tRGlyZWN0aW9uKTtcblxuXG5cbiAgICAgICAgICAgIC8vIGxhbWJlcnRcblxuICAgICAgICAgICAgbGFtYkNvcyA9IC1WZWN0b3IuZG90KFxuICAgICAgICAgICAgICAgIGxpZ2h0RGlyZWN0aW9uLFxuICAgICAgICAgICAgICAgIGludGVyc2VjdC5nZXROb3JtYWwoKVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgbGFtYkNvbG9yID0gbGFtYkNvbG9yLmFkZChcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3RcbiAgICAgICAgICAgICAgICAgICAgLmdldE93bmVyKClcbiAgICAgICAgICAgICAgICAgICAgLmdldE1hdGVyaWFsKClcbiAgICAgICAgICAgICAgICAgICAgLmdldENvbG9yKClcbiAgICAgICAgICAgICAgICAgICAgLmFkZChyYWRpYW5jZUNvbG9yKVxuICAgICAgICAgICAgICAgICAgICAubXVsdGlwbGUoXG4gICAgICAgICAgICAgICAgICAgICAgICBsaWdodC5nZXRNYXRlcmlhbCgpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldENvbG9yKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuc2NhbGVkKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodFBvd2VyICogbGFtYkNvcyAqIGludGVyc2VjdC5nZXRPd25lcigpLmdldE1hdGVyaWFsKCkuZ2V0TGFtYmVydENvZWZmKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICk7XG5cblxuXG4gICAgICAgICAgICAvLyBwaG9uZ1xuXG4gICAgICAgICAgICByZWZsZWN0UGhvbmdWZWN0b3JEaXIgPSBWZWN0b3IucmVmbGVjdChcbiAgICAgICAgICAgICAgICBsaWdodERpcmVjdGlvbixcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3QuZ2V0Tm9ybWFsKClcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBwaG9uZ0NvcyA9IC1WZWN0b3IuZG90KHJlZmxlY3RQaG9uZ1ZlY3RvckRpciwgcmF5LmdldERpcmVjdGlvbigpKTtcblxuICAgICAgICAgICAgaWYgKHBob25nQ29zID4gMCkge1xuICAgICAgICAgICAgICAgIHBob25nID0gTWF0aC5wb3cocGhvbmdDb3MsIDM1KTtcbiAgICAgICAgICAgICAgICBwaG9uZ0NvbG9yID0gcGhvbmdDb2xvci5hZGQoXG4gICAgICAgICAgICAgICAgICAgIGludGVyc2VjdC5nZXRPd25lcigpXG4gICAgICAgICAgICAgICAgICAgICAgICAuZ2V0TWF0ZXJpYWwoKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmdldENvbG9yKClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5tdWx0aXBsZShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodC5nZXRNYXRlcmlhbCgpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRDb2xvcigpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5zY2FsZWQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodFBvd2VyICogcGhvbmcgKiBpbnRlcnNlY3QuZ2V0T3duZXIoKS5nZXRNYXRlcmlhbCgpLmdldFBob25nQ29lZmYoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy9hbWJpZW50IG9jY2x1c2lvblxuICAgICAgICAgICAgLypsZXQgYyA9IDA7XG5cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hb1NhbXBsZXM7IGkrKykge1xuICAgICAgICAgICAgICAgIGxldCBkaXIgPSB0aGlzLmNvc2luZVNhbXBsZUhlbWlzcGhlcmUoaW50ZXJzZWN0LmdldE93bmVyKCkuZ2V0Tm9ybWFsKGludGVyc2VjdC5nZXRIaXRQb2ludCgpKSk7XG5cbiAgICAgICAgICAgICAgICBsZXQgYW9JbnRlcnNlY3QgPSB0aGlzLnRyYWNlKFxuICAgICAgICAgICAgICAgICAgICBuZXcgUmF5KFxuICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0LmdldEhpdFBvaW50KCksXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXJcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgICAgICBpZiAoIWFvSW50ZXJzZWN0LmdldEludGVyc2VjdCgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChhb0ludGVyc2VjdC5nZXREaXN0YW5jZUZyb21PcmlnaW4oKSA+IDIwMCkge1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjKys7XG4gICAgICAgICAgICB9Ki9cblxuICAgICAgICAgICAgLypwaXhlbENvbG9yID0gcGl4ZWxDb2xvci5hZGQoXG4gICAgICAgICAgICAgICAgbGFtYkNvbG9yLm11bHRpcGxlKENvbG9yLndoaXRlLnNjYWxlZCgxIC0gKGMgKiAwLjY3IC8gdGhpcy5hb1NhbXBsZXMpKSkuYWRkKHBob25nQ29sb3IpXG4gICAgICAgICAgICApOyovXG5cbiAgICAgICAgICAgIHBpeGVsQ29sb3IgPSBwaXhlbENvbG9yLmFkZChcbiAgICAgICAgICAgICAgICBsYW1iQ29sb3IuYWRkKHBob25nQ29sb3IpXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHBpeGVsQ29sb3I7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRSZWZsZWN0aW9uQ29sb3IgKHJheTogUmF5LCBpbnRlcnNlY3Q6IGFueSk6IGFueSB7XG4gICAgICAgIGxldCByZWZsZWN0aW9uQ29sb3I6IENvbG9yLFxuICAgICAgICAgICAgcmVmbGVjdGlvblZhbHVlOiBudW1iZXIgPSBpbnRlcnNlY3QuZ2V0T3duZXIoKS5nZXRNYXRlcmlhbCgpLmdldFJlZmxlY3Rpb25WYWx1ZSgpLFxuICAgICAgICAgICAgcmVmbGVjdGVkUmF5OiBWZWN0b3I7XG5cbiAgICAgICAgaWYgKHJlZmxlY3Rpb25WYWx1ZSA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIENvbG9yLmJsYWNrO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVmbGVjdGVkUmF5ID0gVmVjdG9yLnJlZmxlY3QoXG4gICAgICAgICAgICByYXkuZ2V0RGlyZWN0aW9uKCksXG4gICAgICAgICAgICBpbnRlcnNlY3QuZ2V0Tm9ybWFsKClcbiAgICAgICAgKTtcblxuICAgICAgICByZWZsZWN0aW9uQ29sb3IgPSB0aGlzLmdldENvbG9yKFxuICAgICAgICAgICAgbmV3IFJheShpbnRlcnNlY3QuZ2V0SGl0UG9pbnQoKSwgcmVmbGVjdGVkUmF5LCByYXkuZ2V0SXRlcmF0aW9uKCkpXG4gICAgICAgICkuc2NhbGVkKHJlZmxlY3Rpb25WYWx1ZSk7XG5cbiAgICAgICAgcmV0dXJuIHJlZmxlY3Rpb25Db2xvcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFBlcnNwZWN0aXZlVmVjdG9yICh4OiBudW1iZXIsIHk6IG51bWJlcikge1xuICAgICAgICBsZXQgY2FtZXJhOiBDYW1lcmEgPSB0aGlzLnNjZW5lLmdldENhbWVyYSgpO1xuXG4gICAgICAgIHJldHVybiBWZWN0b3Iubm9ybWFsaXplKFxuICAgICAgICAgICAgVmVjdG9yLmFkZChcbiAgICAgICAgICAgICAgICBjYW1lcmEuZ2V0Rm9yd2FyZFZlY3RvcigpLFxuICAgICAgICAgICAgICAgIFZlY3Rvci5hZGQoXG4gICAgICAgICAgICAgICAgICAgIFZlY3Rvci5zY2FsZShcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbWVyYS5nZXRSaWdodFZlY3RvcigpLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2FtZXJhLnJlY2VudGVyWCh4KVxuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICBWZWN0b3Iuc2NhbGUoXG4gICAgICAgICAgICAgICAgICAgICAgICBjYW1lcmEuZ2V0VXBWZWN0b3IoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbWVyYS5yZWNlbnRlclkoeSlcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldExpZ2h0UG93ZXIgKGludGVyc2VjdDogYW55LCBsaWdodDogQWJzdHJhY3RMaWdodCk6IG51bWJlciB7XG4gICAgICAgIGxldCBsaWdodFBvd2VyID0gbGlnaHQuZ2V0UG93ZXIoKSxcbiAgICAgICAgICAgIGxpZ2h0UmFuZG9tUG9pbnQ6IFZlY3RvcixcbiAgICAgICAgICAgIHNoYWRvd1JheTogSW50ZXJzZWN0UG9pbnQsXG4gICAgICAgICAgICByZXN1bHRQb3dlcjogbnVtYmVyID0gMDtcblxuICAgICAgICBsaWdodFJhbmRvbVBvaW50ID0gbGlnaHQuZ2V0UmFuZG9tUG9pbnQoKTtcblxuICAgICAgICBzaGFkb3dSYXkgPSB0aGlzLnRyYWNlKFxuICAgICAgICAgICAgbmV3IFJheShcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3QuZ2V0SGl0UG9pbnQoKSxcbiAgICAgICAgICAgICAgICBWZWN0b3Iuc3Vic3RyYWN0KFxuICAgICAgICAgICAgICAgICAgICBWZWN0b3Iuc3Vic3RyYWN0KFxuICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHQuZ2V0UG9zaXRpb24oKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0UmFuZG9tUG9pbnRcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgaW50ZXJzZWN0LmdldEhpdFBvaW50KClcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICApXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgc2hhZG93UmF5LmdldEludGVyc2VjdCgpICYmXG4gICAgICAgICAgICBzaGFkb3dSYXkuZ2V0T3duZXIoKSBpbnN0YW5jZW9mIEFic3RyYWN0TGlnaHRcbiAgICAgICAgKSB7XG4gICAgICAgICAgICByZXN1bHRQb3dlciArPSAoXG4gICAgICAgICAgICAgICAgbGlnaHRQb3dlciAtXG4gICAgICAgICAgICAgICAgKFxuICAgICAgICAgICAgICAgICAgICBWZWN0b3Iuc3Vic3RyYWN0KFxuICAgICAgICAgICAgICAgICAgICAgICAgVmVjdG9yLnN1YnN0cmFjdChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodC5nZXRQb3NpdGlvbigpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpZ2h0UmFuZG9tUG9pbnRcbiAgICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnNlY3QuZ2V0SGl0UG9pbnQoKVxuICAgICAgICAgICAgICAgICAgICApLmdldExlbmd0aCgpICogKGxpZ2h0UG93ZXIgLyBsaWdodC5nZXRGYWRlUmFkaXVzKCkpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHRQb3dlcjtcbiAgICB9XG5cbiAgICBwcml2YXRlIHRyYWNlIChyYXk6IFJheSk6IEludGVyc2VjdFBvaW50IHtcbiAgICAgICAgbGV0IGludGVyc2VjdGlvbiA9IG5ldyBJbnRlcnNlY3RQb2ludCgpLFxuICAgICAgICAgICAgaW50ZXJzZWN0RGF0YTogYW55LFxuICAgICAgICAgICAgbWluRGlzdGFuY2U6IG51bWJlciA9IEluZmluaXR5LFxuICAgICAgICAgICAgc2NlbmVPYmplY3RzOiBBYnN0cmFjdE9iamVjdFtdJkFic3RyYWN0TGlnaHRbXSA9IHRoaXMuc2NlbmUuZ2V0T2JqZWN0cygpLmNvbmNhdCh0aGlzLnNjZW5lLmdldExpZ2h0cygpKTtcblxuICAgICAgICBmb3IgKGxldCBvYmplY3Qgb2Ygc2NlbmVPYmplY3RzKSB7XG4gICAgICAgICAgICBpbnRlcnNlY3REYXRhID0gb2JqZWN0LmdldEludGVyc2VjdERhdGEocmF5KTtcblxuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIGludGVyc2VjdERhdGEgJiZcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3REYXRhWydkaXN0YW5jZSddIDwgbWluRGlzdGFuY2VcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIG1pbkRpc3RhbmNlID0gaW50ZXJzZWN0RGF0YVsnZGlzdGFuY2UnXTtcblxuICAgICAgICAgICAgICAgIGludGVyc2VjdGlvbi5zZXRJbnRlcnNlY3QoKTtcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb24uc2V0SGl0UG9pbnQoaW50ZXJzZWN0RGF0YVsnaGl0UG9pbnQnXSk7XG4gICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uLnNldE5vcm1hbChpbnRlcnNlY3REYXRhWydub3JtYWwnXSk7XG4gICAgICAgICAgICAgICAgaW50ZXJzZWN0aW9uLnNldERpc3RhbmNlRnJvbU9yaWdpbihpbnRlcnNlY3REYXRhWydkaXN0YW5jZSddKTtcbiAgICAgICAgICAgICAgICBpbnRlcnNlY3Rpb24uc2V0T3duZXIob2JqZWN0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBpbnRlcnNlY3Rpb247XG4gICAgfVxuXG4gICAgcHVibGljIHJlbmRlciAoc2NyZWVuV2lkdGg6IG51bWJlciwgc2NyZWVuSGVpZ2h0OiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgcmFuZG9NdWx0aXBsaWVyID0gMC41O1xuXG4gICAgICAgIGxldCBidWZmZXI6IG51bWJlcltdLFxuICAgICAgICAgICAgY29sb3I6IENvbG9yLFxuICAgICAgICAgICAgcmFuZDogbnVtYmVyLFxuICAgICAgICAgICAgcmF5OiBSYXk7XG5cbiAgICAgICAgdGhpcy5zY3JlZW5XaWR0aCA9IHNjcmVlbldpZHRoO1xuICAgICAgICB0aGlzLnNjcmVlbkhlaWdodCA9IHNjcmVlbkhlaWdodDtcblxuICAgICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICAgICAgYnVmZmVyID0gW107XG5cbiAgICAgICAgICAgIGZvciAobGV0IHkgPSAwOyB5IDwgdGhpcy5zY3JlZW5IZWlnaHQ7IHkrKykge1xuICAgICAgICAgICAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgdGhpcy5zY3JlZW5XaWR0aDsgeCsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHJhbmQgPSAwO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpID4gMC41KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByYW5kICs9IE1hdGgucmFuZG9tKCkgKiByYW5kb011bHRpcGxpZXI7XG4gICAgICAgICAgICAgICAgICAgIH0gIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmFuZCAtPSBNYXRoLnJhbmRvbSgpICogcmFuZG9NdWx0aXBsaWVyO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgcmF5ID0gbmV3IFJheShcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2NlbmUuZ2V0Q2FtZXJhKCkuZ2V0UG9zaXRpb24oKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0UGVyc3BlY3RpdmVWZWN0b3IoeCArIHJhbmQsIHkgKyByYW5kKVxuICAgICAgICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbG9yID0gQ29sb3IuYmxhY2suYWRkKHRoaXMuZ2V0Q29sb3IocmF5KSk7XG5cbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgY29tcG9uZW50IGluIGNvbG9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xvcltjb21wb25lbnRdID0gQ29sb3Iuc1JHQkVuY29kZShjb2xvcltjb21wb25lbnRdKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKGNvbG9yLnJlZCk7XG4gICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKGNvbG9yLmdyZWVuKTtcbiAgICAgICAgICAgICAgICAgICAgYnVmZmVyLnB1c2goY29sb3IuYmx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzZWxmLnBvc3RNZXNzYWdlKGJ1ZmZlcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0U2NlbmUgKHNjZW5lOiBTY2VuZSk6IHZvaWQge1xuICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7XG4gICAgfVxufVxuXG5vbm1lc3NhZ2UgPSBmdW5jdGlvbiAobWVzc2FnZSkge1xuICAgIHZhciBkYXRhID0gbWVzc2FnZS5kYXRhO1xuXG4gICAgaWYgKHR5cGVvZihkYXRhKSA9PSAnc3RyaW5nJykge1xuICAgICAgICBkYXRhID0gSlNPTi5wYXJzZSgnWycrZGF0YSsnXScpO1xuICAgIH1cblxuICAgIGxldCB0cmFjZXIgPSBuZXcgVHJhY2VyKCk7XG5cbiAgICB0cmFjZXIuc2V0U2NlbmUoXG4gICAgICAgIG5ldyBTY2VuZSh7XG4gICAgICAgICAgICBjYW1lcmE6IG5ldyBDYW1lcmEoXG4gICAgICAgICAgICAgICAgbmV3IFZlY3RvcigwLCAwLCAtNjk5KSxcbiAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKDAsIDAsIDEpLFxuICAgICAgICAgICAgICAgIGRhdGFbMF0sXG4gICAgICAgICAgICAgICAgZGF0YVsxXVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIGxpZ2h0czogW1xuICAgICAgICAgICAgICAgIG5ldyBTcGhlcmljYWxMaWdodChuZXcgVmVjdG9yICgwLCA2MDAsIDApLCAwLjYsIDEwMClcbiAgICAgICAgICAgICAgICAgICAgLnNldE1hdGVyaWFsKG5ldyBNYXRlcmlhbChDb2xvci53aGl0ZSkpLFxuICAgICAgICAgICAgICAgIG5ldyBTcGhlcmljYWxMaWdodChuZXcgVmVjdG9yICgwLCAwLCAwKSwgMC42LCAxNTApXG4gICAgICAgICAgICAgICAgICAgIC5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWwobmV3IENvbG9yKG5ldyBSR0JDb2xvcigyNTUsIDIzNSwgMjAwKSkpKVxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIG9iamVjdHM6IFtcbiAgICAgICAgICAgICAgICAvLyBuZXcgUGxhbmUobmV3IFZlY3RvcigwLCAxLCAwKSwgbmV3IFZlY3RvciAoMCwgLTQwMCwgMCkpLnNldE1hdGVyaWFsKG5ldyBNYXRlcmlhbChDb2xvci5ncmF5LCAwKSksXG4gICAgICAgICAgICAgICAgLy8gYm90dG9tIHBsYW5lXG4gICAgICAgICAgICAgICAgbmV3IFBvbHlnb24oXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoLTcwMCwgLTcwMCwgLTcwMCksXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoNzAwLCAtNzAwLCAtNzAwKSxcbiAgICAgICAgICAgICAgICAgICAgbmV3IFZlY3Rvcig3MDAsIC03MDAsIDcwMCksXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoLTcwMCwgLTcwMCwgNzAwKVxuICAgICAgICAgICAgICAgICkuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKENvbG9yLndoaXRlLCAwKS5zZXRMYW1iZXJ0Q29lZmYoMSkpLFxuICAgICAgICAgICAgICAgIC8vIGZyb250IHBsYW5lXG4gICAgICAgICAgICAgICAgbmV3IFBvbHlnb24oXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoLTcwMCwgLTcwMCwgNzAwKSxcbiAgICAgICAgICAgICAgICAgICAgbmV3IFZlY3Rvcig3MDAsIC03MDAsIDcwMCksXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoNzAwLCA3MDAsIDcwMCksXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoLTcwMCwgNzAwLCA3MDApXG4gICAgICAgICAgICAgICAgKS5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWwoQ29sb3Iud2hpdGUsIDApLnNldExhbWJlcnRDb2VmZigxKSksXG4gICAgICAgICAgICAgICAgLy8gdG9wIHBsYW5lXG4gICAgICAgICAgICAgICAgbmV3IFBvbHlnb24oXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoLTcwMCwgNzAwLCA3MDApLFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKDcwMCwgNzAwLCA3MDApLFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKDcwMCwgNzAwLCAtNzAwKSxcbiAgICAgICAgICAgICAgICAgICAgbmV3IFZlY3RvcigtNzAwLCA3MDAsIC03MDApXG4gICAgICAgICAgICAgICAgKS5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWwoQ29sb3Iud2hpdGUsIDApLnNldExhbWJlcnRDb2VmZigxKSksXG4gICAgICAgICAgICAgICAgLy9yaWdodCBwbGFuZVxuICAgICAgICAgICAgICAgIG5ldyBQb2x5Z29uKFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKDcwMCwgLTcwMCwgNzAwKSxcbiAgICAgICAgICAgICAgICAgICAgbmV3IFZlY3Rvcig3MDAsIC03MDAsIC03MDApLFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKDcwMCwgNzAwLCAtNzAwKSxcbiAgICAgICAgICAgICAgICAgICAgbmV3IFZlY3Rvcig3MDAsIDcwMCwgNzAwKVxuICAgICAgICAgICAgICAgICkuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKENvbG9yLmJsdWUpLnNldExhbWJlcnRDb2VmZigxKSksXG4gICAgICAgICAgICAgICAgLy9sZWZ0IHBsYW5lXG4gICAgICAgICAgICAgICAgbmV3IFBvbHlnb24oXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoLTcwMCwgLTcwMCwgLTcwMCksXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoLTcwMCwgLTcwMCwgNzAwKSxcbiAgICAgICAgICAgICAgICAgICAgbmV3IFZlY3RvcigtNzAwLCA3MDAsIDcwMCksXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoLTcwMCwgNzAwLCAtNzAwKVxuICAgICAgICAgICAgICAgICkuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKENvbG9yLnJlZCwgMCkuc2V0TGFtYmVydENvZWZmKDEpKSxcbiAgICAgICAgICAgICAgICAvLyBiYWNrIHBsYW5lXG4gICAgICAgICAgICAgICAgbmV3IFBvbHlnb24oXG4gICAgICAgICAgICAgICAgICAgIG5ldyBWZWN0b3IoNzAwLCAtNzAwLCAtNzAwKSxcbiAgICAgICAgICAgICAgICAgICAgbmV3IFZlY3RvcigtNzAwLCAtNzAwLCAtNzAwKSxcbiAgICAgICAgICAgICAgICAgICAgbmV3IFZlY3RvcigtNzAwLCA3MDAsIC03MDApLFxuICAgICAgICAgICAgICAgICAgICBuZXcgVmVjdG9yKDcwMCwgNzAwLCAtNzAwKVxuICAgICAgICAgICAgICAgICkuc2V0TWF0ZXJpYWwobmV3IE1hdGVyaWFsKENvbG9yLmJsYWNrLCAwKS5zZXRMYW1iZXJ0Q29lZmYoMSkpLFxuICAgICAgICAgICAgICAgIG5ldyBTcGhlcmUobmV3IFZlY3RvcigtMjUwLCAtNTAwLCA0NTApLCAyMDApXG4gICAgICAgICAgICAgICAgICAgIC5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWwoQ29sb3IuYmxhY2ssIDEpKSxcbiAgICAgICAgICAgICAgICBuZXcgU3BoZXJlKG5ldyBWZWN0b3IoMjUwLCAtNTAwLCA0MDApLCAyMDApXG4gICAgICAgICAgICAgICAgICAgIC5zZXRNYXRlcmlhbChuZXcgTWF0ZXJpYWwoQ29sb3IuZ3JlZW4sIDApKVxuICAgICAgICAgICAgXVxuICAgICAgICB9KVxuICAgICk7XG5cbiAgICB0cmFjZXIucmVuZGVyKGRhdGFbMF0sIGRhdGFbMV0pO1xufTsiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
